= springboot mysqlæœåŠ¡é›†æˆdockerå®ä¾‹ 
:toc: left
:toc-title: ç›®å½•
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: â—
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
// :tip-caption: :bulb:
// :note-caption: :information_source:
// :important-caption: :heavy_exclamation_mark:	
// :caution-caption: :fire:
// :warning-caption: :warning:
:icons: font

Doc writer yaoyihao1@gmail.com

== å›é¡¾
ä¸Šç¯‡ç¬”è€…å®æˆ˜æ“ä½œäº†< https://yaoyuanyy.github.io/2019/05/22/springboot%E9%9B%86%E6%88%90docker%E5%AE%9E%E4%BE%8B/[springbooté›†æˆdocker] >ä»0å¼€å§‹çš„æ“ä½œä¾‹å­ï¼Œæœ¬ç¯‡å†æ·±å…¥ä¸€ç‚¹ï¼šæŠŠmysqlç»§æ‰¿è¿›æ¥ï¼Œå½¢æˆspringboot+mysqlæœåŠ¡é›†æˆdockerå®ä¾‹ï¼Œæœ¬ç¯‡æ˜¯åœ¨ä¸Šç¯‡< (https://yaoyuanyy.github.io/2019/05/22/springboot%E9%9B%86%E6%88%90docker%E5%AE%9E%E4%BE%8B/[springbooté›†æˆdocker]>çš„åŸºç¡€ä¸Šè¿›è¡Œçš„

é¡¹ç›®ä»£ç : https://github.com/yaoyuanyy/springboot_project/tree/feature-docker-20190517/springboot_mybatis[springboot_mybatis]


== dockeré›†æˆspringboot_mybatis+mysql

=== é›†æˆmybatis
ä¸Šç¯‡çš„é¡¹ç›®æˆ‘ä»¬copyä¸‹ï¼Œæ”¹ä¸ªåï¼šspringboot_mybatisï¼Œåœ¨æ­¤åŸºç¡€ä¸Šé›†æˆmybatisç›¸å…³ä»£ç 
----
# å¢åŠ å®ä½“bean: User
package com.yy.demo.bean;

import lombok.Data;

@Data
public class User {
    private long id;
    private long studentId;
    private String name;
    private String mobile;
    private int score;
}

# åˆ›å»ºUserMapper
package com.yy.demo.mapper;
import org.apache.ibatis.annotations.Param;
import com.yy.demo.bean.User;

public interface UserMapper {
    User findById(@Param("id") long id);
}

# åˆ›å»ºUserMapperå¯¹åº”çš„xmlæ–‡ä»¶
<mapper namespace="com.yy.demo.mapper.UserMapper">
  <resultMap type="com.yy.demo.bean.User" id="userMapper">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="mobile" column="mobile"/>
        <result property="score" column="score"/>
        <result property="studentId" column="studentId"/>
  </resultMap>
	
  <select id="findById" parameterType="long" resultMap="userMapper">
        select * from user where id=#{id}
  </select>
</mapper>
----

application.ymlæ–‡ä»¶æ·»åŠ mybatisç›¸å…³é…ç½®å¦‚ä¸‹
----
mybatis:
  == Locations of Mapper xml config file
  mapperLocations: classpath*:com/yy/**/mapper/*.xml
  == å®ä½“ç±»åŒ…è·¯å¾„ Packages to search for type aliases. (Package delimiters are ",; \t\n")
  typeAliasesPackage: com.yy.**.bean
  == Location of MyBatis xml config file.
  == æ³¨æ„ï¼šè¿™ä¸ªå±æ€§ä¸mybatis.configurationäºŒé€‰ä¸€
  config-location: classpath:mybatis/mybatis-config.xml
  ==  æ£€æŸ¥ mybatis é…ç½®æ˜¯å¦å­˜åœ¨ï¼Œä¸€èˆ¬å‘½åä¸º mybatis-config.xml
  check-config-location: true

----

pom.xmlæ–‡ä»¶å¼•å…¥mysqlå’Œmybatiså¦‚ä¸‹
----
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.11</version>
</dependency>
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>1.3.2</version>
</dependency>

----
src/main/resourcesä¸‹æ–°å¢schema.sqlæ–‡ä»¶ï¼Œå¦åˆ™ä½ éœ€è¦åœ¨dockerä¸­å®‰è£…mysql server, é¡¹ç›®ä¸­æ·»åŠ schema.sqlå¯ä»¥ç®€ä¾¿demoçš„æ­å»º(demoå¯ä»¥è¿™æ ·å†™ï¼Œå®é™…é¡¹ç›®å°±ä¸èƒ½å·æ‡’äº†)ï¼Œå†…å®¹å¦‚ä¸‹
----
drop table if exists user;

CREATE TABLE `user` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(50) NOT NULL,
  `mobile` varchar(20) NOT NULL,
  `score` int(4) NOT NULL DEFAULT '0' COMMENT 'åˆ†æ•°',
  `studentId` bigint(20) unsigned NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_studentId` (`studentId`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

INSERT INTO `user`(`id`, `name`, `mobile`, `score`, `studentId`) VALUES (1, 'y', '13000000000', 0, 1);
INSERT INTO `user`(`id`, `name`, `mobile`, `score`, `studentId`) VALUES (2, 'l', '13800008888', 5, 2);
INSERT INTO `user`(`id`, `name`, `mobile`, `score`, `studentId`) VALUES (3, 's', '111', 0, 3);
INSERT INTO `user`(`id`, `name`, `mobile`, `score`, `studentId`) VALUES (4, 's', '111', 0, 33);
INSERT INTO `user`(`id`, `name`, `mobile`, `score`, `studentId`) VALUES (5, 's', '112', 0, 4);
INSERT INTO `user`(`id`, `name`, `mobile`, `score`, `studentId`) VALUES (7, 's', '113', 0, 5);
INSERT INTO `user`(`id`, `name`, `mobile`, `score`, `studentId`) VALUES (8, 's', '113', 0, 60);
INSERT INTO `user`(`id`, `name`, `mobile`, `score`, `studentId`) VALUES (9, 's', '114', 0, 7);
INSERT INTO `user`(`id`, `name`, `mobile`, `score`, `studentId`) VALUES (10, 's', '115', 0, 8);
----

application.ymlæ–‡ä»¶æ·»åŠ mysqlè¿æ¥é…ç½®
----
#profile
spring:
  datasource:
    url: jdbc:mysql://${DATABASE_HOST}:${DATABASE_PORT}/${DATABASE_NAME}?allowMultiQueries=true&allowPublicKeyRetrieval=true&useSSL=false
    username: ${DATABASE_USER}
    password: ${DATABASE_PASSWORD}
    driver-class-name: @spring.datasource.driverlassName@

# è¿™é‡Œä½¿ç”¨äº†maven profileå’Œspring profileç‰¹æ€§ï¼Œ@ç¬¦å·ä½¿ç”¨äº†maven profileç‰¹æ€§ï¼Œ${}ä½¿ç”¨spring profileç‰¹æ€§ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯dev profile(å…·ä½“å‚è§é¡¹ç›®ä»£ç dev.propertieså’Œapplication-dev.yml), æ³¨ï¼šä½ ä¼šå‘ç°application-dev.ymlæ²¡æœ‰â€œDATABASE_HOST Â·Â·Â·â€çš„å£°æ˜ï¼Œé‚£æ˜¯å› ä¸ºæˆ‘ä»¬è¦åœ¨docker runçš„æ—¶å€™æŒ‡å®šï¼Œå¦‚æœä½ ä½¿ç”¨application-local.ymlå°±å‘ç°æœ‰äº†ã€‚ä½ ä¼šå‘ç°localç¯å¢ƒå¯ä»¥ç›´æ¥èµ·é¡¹ç›®ï¼Œdevç¯å¢ƒä½¿ç”¨dockerèµ·é¡¹ç›®ã€‚é¡¹ç›®å¯¹å¤–ä¿æŒä¸€è‡´ï¼Œæ— éœ€ä»»ä½•ä¿®æ”¹ã€‚
----

åˆ›å»ºcontrollerå’Œservice
----
@RestController
@Slf4j
@RequestMapping("/user")
public class UserController {

    @Resource
    private IUserService userService;
    /**
    * eq: http://localhost:2372/user/findById?id=3
    * @param id
    * @return
    */
    @GetMapping("/findById")
    public ResponseResult findById(long id, @AttrbuteArg("test") String name, ModelMap modelMap) {
        log.info("findById param id:{}", id);

        User user = userService.fingById(id);
    log.info("user:{}", user);
        System.out.println("ll: "+modelMap.get("ll"));
    return ResponseResult.ok(user);
    }
}

public interface IUserService {
    User fingById(long id);
}
@Service
public class UserServiceImpl implements IUserService {
    @Resource
    private UserMapper userMapper;

    @Override
    public User fingById(long id) {
      return userMapper.findById(id);
    }
}
----
åˆ°è¿™é‡Œä»£ç æ–¹é¢çš„ä¸œä¸œæ·»åŠ å¥½äº†ã€‚


=== æ„å»ºé¡¹ç›®å¹¶å‘åˆ°dockeræœåŠ¡å™¨

é¡¹ç›®æ ¹è·¯å¾„ä¸‹æ‰§è¡Œï¼š`mvn clean package docker:build -DskipTests`ï¼Œå°†é¡¹ç›®æ‰“åŒ…å‘åˆ°dockeræœåŠ¡å™¨ä¸Šã€‚æ§åˆ¶å°æç¤ºbuild successåï¼Œç™»å½•è¿œç¨‹docker æœåŠ¡å™¨çœ‹è§æ–°ä¼ ä¸Šæ¥çš„image é•œåƒï¼Œå¦‚ä¸‹å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129145936.png[20201129145936]

=== dockerè¿è¡Œmysql image
æˆ‘ä»¬ä½¿ç”¨docker runæ¥å¯åŠ¨ä¸€ä¸ªmysql image,å› ä¸ºdocker hubå·²ç»æœ‰äº†å¾ˆå¤šçš„å¸¸ç”¨image, mysqlæ˜¯å…¶ä¸­ä¹‹ä¸€ï¼Œæˆ‘ä»¬åªç”¨è¿è¡Œå°±å¥½
----
$ docker run -d -t --name mybatis-mysql -e MYSQL_ROOT_PASSWORD=root123 -e MYSQL_DATABASE=jdbc_test -e MYSQL_USER=root -e MYSQL_PASSWORD=root123 mysql:latest

# è§£é‡Šä¸€ä¸‹è¿™ä¸ªå‘½ä»¤ï¼Œå¯ä»¥è‡ªè¡Œä½¿ç”¨docker run --helpæŸ¥çœ‹
# docker run è¿è¡Œä¸€ä¸ªimageé•œåƒï¼Œæ­¤å¤„çš„imageä¸ºï¼šmysql:latest(mysqlæœ€æ–°ç‰ˆæœ¬)ï¼ŒåŒæ—¶äº§ç”Ÿä¸€ä¸ªcontainer,åå­—ä½¿ç”¨--name æŒ‡å®šï¼Œæ­¤å¤„ä¸ºmybatis-mysql
# -d åœ¨åå°è¿è¡Œ
# -t åˆ†é…ä¸€ä¸ªä¼ªttyã€‚å¦‚æœä¸åŠ -tï¼Œå‘½ä»¤è¿è¡Œåï¼Œä½ ä¼šå‘ç°äº§ç”Ÿçš„containerçš„çŠ¶æ€æ˜¯Exitedã€‚åŸå› æ˜¯ï¼šä½ é•œåƒé‡Œé¢æŒ‡å®šçš„é»˜è®¤å¯åŠ¨ç¨‹åºæ˜¯bashï¼Œå¯¹äºLinuxä¸‹çš„shellç¨‹åºæ¥è¯´ï¼Œttyæ˜¯å¿…é¡»çš„ï¼Œæ‰€ä»¥å¯åŠ¨å®¹å™¨çš„æ—¶å€™è¦åŠ ä¸Š-tå‚æ•°ã€‚
# å¦‚æœdocker runæ²¡æœ‰åŠ -t ï¼Œé‚£ä¹ˆè¿è¡Œå®Œdocker runåï¼Œéœ€è¦æ¥ç€è¿è¡Œdocker start containerId
# -e ä¸ºè¿™ä¸ªå®¹å™¨è®¾ç½®ç¯å¢ƒå˜é‡
----
è¿è¡Œå‘½ä»¤åï¼ŒæŸ¥çœ‹äº§ç”Ÿçš„containerçš„çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°çŠ¶æ€ä¸ºUpï¼Œè¡¨æ˜mysqlå·²ç»å¯åŠ¨ï¼Œå¦‚ä¸‹å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129150116.png[20201129150116]


=== dockerè¿è¡Œspringboot_mybatisé¡¹ç›®
ç°åœ¨æˆ‘ä»¬å¯ä»¥è¿è¡Œåˆšåˆšä¸Šä¼ çš„é¡¹ç›®(springboot_mybatis)äº†ã€‚
----
$ docker run -d -t --name demo-springboot-docker --link mybatis-mysql:mysql -p 2372:2371 -e DATABASE_HOST=mybatis-mysql -e DATABASE_PORT=3306 -e DATABASE_NAME=jdbc_test -e DATABASE_USER=root -e DATABASE_PASSWORD=root123 springboot_demo/springboot_mybatis

# è§£é‡Šä¸€ä¸‹è¿™ä¸ªå‘½ä»¤ -d -t --name -e è¿™äº›å‚æ•°ä¸Šé¢å·²ç»è§£é‡Šè¿‡ï¼Œå¿˜è®°äº†å›çœ‹ä¸‹å°±å¥½.
# --link è¿æ¥ä¸€ä¸ªæŒ‡å®šçš„container
# -p æŒ‡å®šå¯åŠ¨çš„containeræš´éœ²çš„ç«¯å£å·ï¼Œ2372:2371æŒ‡å®šä¸ºspringboot_demo/springboot_mybatisä»“åº“äº§ç”Ÿçš„containerçš„ç«¯å£å·ä¸º2372ï¼Œå†’å·åé¢çš„2371ä¸ºspringboot_mybatis webé¡¹ç›®çš„ç«¯å£ï¼Œå†’å·èµ·åˆ°æ˜ å°„çš„ä½œç”¨ï¼Œå³docker å®¹å™¨çš„2372ç«¯å£æ˜ å°„åˆ°webé¡¹ç›®çš„2371ç«¯å£
# æ³¨æ„-e åé¢æ•°æ®åº“é…ç½®çš„valueå’Œå¯åŠ¨mysqlé•œåƒæ—¶è®¾ç½®çš„ä¸€è‡´
----
è¿è¡Œå‘½ä»¤åä½ å¯èƒ½å¾—åˆ°ä¸€ä¸ªé”™è¯¯ï¼Œå¦‚ä¸‹å›¾ï¼Œæ„æ€ä¸ºä¾èµ–çš„mybatis-mysqlå®¹å™¨ä¸æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œdocker ps -aä½ ä¼šå‘ç°mybatis-mysqlæ˜¯ExitedçŠ¶æ€
----
docker: Error response from daemon: Cannot link to a non running container: /mybatis-mysql AS /demo-springboot-docker/mysql
----
ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ‰§è¡Œå‘½ä»¤ï¼š`docker start mybatis-mysql`ï¼Œç„¶å`docker ps -a` æŸ¥çœ‹mybatis-mysqlå¯åŠ¨äº†ã€‚
å†æ¬¡æ‰§è¡Œå¯åŠ¨springboot_demo/springboot_mybatisä»“åº“çš„å‘½ä»¤ã€‚å¦‚ä¸‹å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129150223.png[20201129150223]

æ²¡æœ‰æŠ¥é”™ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸çŸ¥é“springboot_mybatisè¿™ä¸ªwebé¡¹ç›®æ˜¯å¦å¯åŠ¨æˆåŠŸï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæƒ³çœ‹ä¸‹webé¡¹ç›®çš„å¯åŠ¨æ—¥å¿—ã€‚è¿™æ—¶è¿›è¡Œå¦‚ä¸‹æ­¥éª¤ï¼Œé¦–å…ˆæ‰§è¡Œ`docker ps`æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„containerï¼Œæ‰¾åˆ°æˆ‘ä»¬springboot_demo/springboot_mybatis imageå¯¹åº”çš„containerIdï¼Œç„¶åæ‰§è¡Œ`docker logs -f -t --tail 20 containerId`ï¼ŒcontainerIdæ›¿æ¢ä¸ºåˆšæ‰æ‰¾åˆ°çš„containerIdã€‚å›è½¦å°±å¯ä»¥çœ‹åˆ°springboot_mybatisçš„æ—¥å¿—äº†ï¼Œå¦‚ä¸‹å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129150252.png[20201129150252]

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129150335.png[20201129150335]

=== è®¿é—®springboot_mybatisæœåŠ¡
é¡¹ç›®å¯åŠ¨åï¼Œå°±å¯ä»¥è®¿é—®äº†ï¼Œä¹Ÿå¯ä»¥éªŒè¯æˆ‘ä»¬è¿™ä¸€ç³»åˆ—æ“ä½œæ˜¯å¦æ­£ç¡®ï¼Œcurlé¡¹ç›®pathï¼Œå¦‚ä¸‹å›¾
----
$ curl http://localhost:2372/user/findById?id=3
----
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129150411.png[20201129150411]

åˆ°è¿™é‡Œï¼Œdockeré›†æˆspringboot+mysqlæ˜¯æ­å»ºå®Œæˆäº†ã€‚ä½†æ˜¯åŠ å…¥springboot_mybatisä¸ä»…ä¾èµ–mysqlï¼Œè¿˜æœ‰redis mongodbï¼Œnginx Â·Â·Â·ï¼Œå¤šä¸ªç»„ä»¶æ—¶ï¼Œå¦‚æœæ¯ä¸ªç»„ä»¶éƒ½è¦docker run Â·Â·Â·ï¼Œä½ ä¼šç–¯æ‰çš„ã€‚è¿™æ—¶docker-composeè§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ä¸‹é¢æˆ‘ä»¬åœ¨æ­¤åŸºç¡€ä¸Šä½¿ç”¨docker-composeé›†æˆspringboot_mybatis+mysqlã€‚


== docker-composeé›†æˆspringboot_mybatis+mysql
é¡¹ç›®ä»£ç ä¸å˜ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨springboot_demo/springboot_mybatisè¿™ä¸ªimageã€‚

=== docker-composeå®‰è£…å’Œè¿è¡Œ 
docker-composeçš„å®‰è£…å’Œè¿è¡Œä¸Šæ–‡å·²ç»å®æˆ˜è¿‡ï¼Œå‚è§ï¼š<https://yaoyuanyy.github.io/2019/05/22/springboot%E9%9B%86%E6%88%90docker%E5%AE%9E%E4%BE%8B/[springbooté›†æˆdocker]> docker-composeéƒ¨åˆ†

=== docker-compose.ymlæ·»åŠ mysqlçš„é…ç½®
ç›¸å¯¹äºdockeré›†æˆmysql,docker-composeçš„ä¼˜åŠ¿æ˜¯å°†mysqlç­‰ç»„ä»¶çš„é…ç½®ä¿¡æ¯å®šä¹‰åœ¨docker-compose.ymlæ–‡ä»¶ä¸­, åœ¨dockeræœåŠ¡å™¨ä¸Šåˆ›å»ºä¸ªç›®å½•æ”¾docker-compose.ymlæ–‡ä»¶ã€‚å¦‚
`cd /root/skyler_home/project/docker_compose`ï¼Œæ²¡æœ‰è¿™ä¸ªç›®å½•å°±åˆ›å»ºä¸‹ï¼Œvimç¼–è¾‘docker-compose.ymlï¼Œå¦‚ä¸‹ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹
----
[root@xxxxx docker_compose]# vim docker-compose.yml
version: '3.3'

services:
  mybatis-mysql:
    image: mysql:latest
    environment:
      - MYSQL_ROOT_PASSWORD=root123
      - MYSQL_USER=root
      - MYSQL_PASSWORD=root123
      - MYSQL_DATABASE=jdbc_test
    ports:
      - "3306:3306"
    container_name: mybatis-mysql_dev
  demo-springboot-docker:
    image: springboot_demo/springboot_mybatis
#    build: .
    depends_on:
      - mybatis-mysql
    ports:
      - 2372:2371
    environment:
      - DATABASE_HOST=mybatis-mysql
      - DATABASE_PORT=3306
      - DATABASE_USER=root
      - DATABASE_PASSWORD=root123
      - DATABASE_NAME=jdbc_test
----
å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡ŒæŠŠå‘½ä»¤å¯åŠ¨mysqlå’Œspringboot-mybatisçš„ä¿¡æ¯éƒ½æ”¾åœ¨äº†docker-compose.ymlä¸­

=== ä¸Šä¼ springboot_mybatis projectåˆ°dockeræœåŠ¡å™¨

docker-composeæ‰§è¡Œéœ€è¦é¡¹ç›®jarå’ŒDockerfileï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æŠŠspringboot_mybatiså’ŒDockerfileä¸Šä¼ åˆ°docker-compose.ymlæ‰€åœ¨ç›®å½•
ç°åœ¨å›åˆ°intellijï¼Œæ‰§è¡Œ`mvn clean package`ï¼Œå¦‚ä¸‹å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129151045.png[20201129151045]
ä½¿ç”¨scpä¸Šä¼ Dockerfileå’Œjaræ–‡ä»¶
----
cd /Users/xx/springboot_mybatis/target/docker

scp Dockerfile root@48.99.190.38:/root/skyler_home/project/docker_compose #è¾“å…¥å¯†ç 

scp springboot_mybatis-0.0.1-SNAPSHOT.jar root@48.99.190.38:/root/skyler_home/project/docker_compose #è¾“å…¥å¯†ç 

----
ç°åœ¨docker_composeç›®å½•ä¸‹æ–‡ä»¶å¦‚ä¸‹
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129151118.png[20201129151118]


=== ä½¿ç”¨docker_composeå¯åŠ¨springboot_mybatis jar
 
å¯åŠ¨å‰éœ€è¦stop rmä¹‹å‰å¯åŠ¨çš„container
----
docker stop demo-springboot-docker
docker stop mybatis-mysql
docker rm demo-springboot-docker
docker rm mybatis-mysql
----

==== è¿è¡Œ 
----
$ docker-compose up
----
å¯èƒ½ä¼šæŠ¥é”™ï¼Œå¦‚ä¸‹å›¾

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129151236.png[20201129151236]
è€Œä¸”springboot-mybatiså’Œmysql containerå·²ç»åˆ›å»ºäº†ï¼Œä½†æ˜¯çŠ¶æ€æ˜¯Exited
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129151322.png[20201129151322]


==== æŠ¥é”™åŸå› 
1. mysql containerçŠ¶æ€æ˜¯Exitedçš„åŸå› :
ä¸ºdocker-compose.ymlä¸­`MYSQL_USER=root`ã€‚æ­¤dockeré•œåƒä½¿ç”¨æ‚¨æä¾›çš„å¯†ç åˆ›å»ºrootç”¨æˆ·ï¼Œå› æ­¤å½“æ‚¨æƒ³å†æ¬¡åˆ›å»ºrootç”¨æˆ·æ—¶ï¼Œå®ƒä¼šå¤±è´¥å¹¶å…³é—­å®¹å™¨ã€‚åªéœ€å°†å…¶æ›´æ”¹ä¸º`MYSQL_USER=myuser`å³å¯
2. springboot-mybatiså¯åŠ¨å¤±è´¥çš„åŸå› :
æœ¬è´¨æ˜¯docker-composeçš„å¯åŠ¨é¡ºåºé—®é¢˜ã€‚springboot-mybatisä¾èµ–mysql, åœ¨docker-compose.ymlä¸­ï¼Œé€šè¿‡é…ç½®depends_on, links, volumes_from, ä»¥åŠ network_mode: "service:...".å¯ä»¥æ§åˆ¶æœåŠ¡çš„å¯åŠ¨é¡ºåºï¼Œä½†æ˜¯å´ä¸èƒ½çŸ¥é“è¢«ä¾èµ–çš„æœåŠ¡æ˜¯å¦å¯åŠ¨å®Œæ¯•ï¼Œåœ¨ä¸€ä¸ªæœåŠ¡å¿…é¡»è¦ä¾èµ–å¦ä¸€ä¸ªæœåŠ¡å®Œæˆçš„æ—¶å€™ï¼Œè¿™æ ·å°±ä¼šæœ‰é—®é¢˜ã€‚ä»springboot-mybatiså¯åŠ¨æ—¥å¿—ä¹Ÿå¯ä»¥çœ‹å‡ºdemo-springboot-docker_1å…ˆäºmybatis-mysql_devåˆå§‹åŒ–äº†
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129151426.png[20201129151426]

==== è§£å†³åŠæ³•
é’ˆå¯¹è¿™æ ·çš„é—®é¢˜ï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆ:

1ã€è¶³å¤Ÿçš„å®¹é”™å’Œé‡è¯•æœºåˆ¶ï¼Œæ¯”å¦‚è¿æ¥æ•°æ®åº“ï¼Œåœ¨åˆæ¬¡è¿æ¥ä¸ä¸Šçš„æ—¶å€™ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯ä»¥ä¸æ–­é‡è¯•ï¼Œç›´åˆ°è¿æ¥ä¸ŠæœåŠ¡ã€‚ä¹Ÿå°±æ˜¯åœ¨æœåŠ¡ä¸­å®šä¹‰ï¼š restart: always

2ã€åŒæ­¥ç­‰å¾…ï¼Œä½¿ç”¨ wait-for-it.shæˆ–è€…å…¶ä»– shellè„šæœ¬å°†å½“å‰æœåŠ¡å¯åŠ¨é˜»å¡ï¼Œç›´åˆ°è¢«ä¾èµ–çš„æœåŠ¡åŠ è½½å®Œæ¯•ã€‚è¿™ç§æ–¹æ¡ˆåæœŸå¯ä»¥å°è¯•ä½¿ç”¨

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç¬¬ä¸€ç§ã€‚å…·ä½“æ“ä½œï¼šç¼–è¾‘docker-compose.ymlï¼Œæ–°å¢restart: alwaysã€‚docker-compose.ymlå…¨å†…å®¹ä¸ºï¼š
----
version: '3.3'

services:
  mybatis-mysql:
    image: mysql:latest
    environment:
      - MYSQL_ROOT_PASSWORD=root123
# MYSQL_USERè®¾ç½®ä¸ºrootï¼Œå¯åŠ¨æœåŠ¡æ—¶æŠ¥é”™ï¼šOperation CREATE USER failed for 'root'@'%'
      - MYSQL_USER=skyler
      - MYSQL_PASSWORD=root123
      - MYSQL_DATABASE=jdbc_test
    ports:
      - "3306:3306"
    restart: always 
    container_name: mybatis-mysql_dev
  demo-springboot-docker:
    restart: always
    image: springboot_demo/springboot_mybatis
    depends_on:
      - mybatis-mysql
    ports:
      - 2372:2371
    environment:
      - DATABASE_HOST=mybatis-mysql
      - DATABASE_PORT=3306
      - DATABASE_USER=skyler
      - DATABASE_PASSWORD=root123
      - DATABASE_NAME=jdbc_test
----

å†è¿è¡Œä¸€æ¬¡ï¼š`docker-compose up -d`ã€‚-dä¸ºåå°å¯åŠ¨ï¼Œå¯é€‰
ä½¿ç”¨`docker logs -f -t --tail 20 62617312c8bf`çœ‹æ—¥å¿—ï¼Œä½ ä¼šå‘ç°ï¼Œå¤±è´¥ä¹‹åè‡ªåŠ¨é‡å¯ï¼Œæœ€åæ˜¾ç¤ºæœåŠ¡å¯åŠ¨æˆåŠŸ


https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129151519.png[20201129151519]
ä½¿ç”¨docker-compose ps(ç±»ä¼¼docker ps -a)æŸ¥çœ‹containerçš„çŠ¶æ€ä¸ºUp
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129151556.png[20201129151556]


ç°åœ¨ï¼Œæ— è®ºdockeré›†æˆspringboot_mybatis+mysqlè¿˜æ˜¯docker-composeé›†æˆspringboot_mybatis+mysqlï¼Œéƒ½å®æˆ˜å®Œæˆ


æ–‡ä¸­æ‰€ç”¨ä»£ç : https://github.com/yaoyuanyy/springboot_project/tree/feature-docker-20190517/springboot_mybatis[springboot_mybatis]

== æ‰©å±•
===  `docker runä¸docker start`åŒºåˆ«
`docker run IMAGE_ID`ï¼Œè€Œ`docker start CONTAINER_ID`ã€‚å³`run runs an image`; `start starts a container`ã€‚`docker run = docker create + docker start`

=== dockeräº¤äº’å¼ä»»åŠ¡
æ ¼å¼ï¼š`docker exec [OPTIONS] CONTAINER COMMAND [ARG...]`
 
-i, --interactive    Keep STDIN open even if not attached
-t, --tty            Allocate a pseudo-TTY

å¦‚ï¼š`docker exec -it 62617312c8bf /bin/bash`ï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯è¿›å…¥å®¹å™¨62617312c8bfå†…éƒ¨æ‰“å¼€shellï¼Œll å¯ä»¥çœ‹åˆ°å®¹å™¨çš„ç›®å½•ç»“æ„ï¼Œå¦‚ä¸‹å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129151719.png[20201129151719]

`Ctrl + d` é€€å‡º

=== è¿›å…¥mysqlå®¹å™¨å†…éƒ¨

`docker ps`æ‰¾åˆ°mysqlå®¹å™¨containerIdæˆ–containerNameï¼Œè¿è¡Œ `docker exec -it containerId/containerName bash`, `mysql -uskyler -p`ï¼Œè¾“å…¥å¯†ç ï¼Œè¿›å»mysql serveræŸ¥çœ‹æ•°æ®åº“,å¦‚ä¸‹å›¾

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129151750.png[20201129151750]
