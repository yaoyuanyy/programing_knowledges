= spring bootåŠ è½½.classæ–¹å¼è‰é›†
:toc: left
:toc-title: ç›®å½•
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: â—
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
// :tip-caption: :bulb:
// :note-caption: :information_source:
// :important-caption: :heavy_exclamation_mark:	
// :caution-caption: :fire:
// :warning-caption: :warning:
:icons: font

Doc writer yaoyihao1@gmail.com

``spring``è¿™ä¸ªåºå¤§çš„å®¶æ—ç»™äº†æˆ‘ä»¬å¾ˆå¤§ä¾¿åˆ©çš„åŒæ—¶ï¼Œä¹Ÿç»™äº†æˆ‘ä»¬å¾ˆå¤šçš„çœ¼ç•Œã€‚ä½¿å¾—æˆ‘ä»¬å¯ä»¥æ¨¡ä»¿å®ƒï¼Œæœ‰ä¸ªèƒ½æ¨¡ä»¿å®ƒçš„æ¡†æ¶ï¼Œæœ‰çš„èƒ½æ¨¡ä»¿å®ƒçš„æŸä¸ªçŸ¥è¯†ç‚¹ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æ¥å¯¹``spring``, ``spring boot``, ``spring cloud``ä¸­çš„æ¶‰åŠåŠ è½½``.class``æ–‡ä»¶æ–¹å¼è¿›è¡Œä¸€æ¬¡æ‘¸åº•ï¼Œå½¢æˆä¸€ä¸ªè‰é›†ã€‚

å½“å‰ï¼Œåœ¨``spring``æ¡†æ¶ä¸­ï¼Œä¸»è¦æœ‰ä»¥ä¸‹ç§ç±»çš„æ–‡ä»¶``.class``æ–‡ä»¶ï¼Œ``spring.factories``æ–‡ä»¶ï¼Œ``.properties/.yml``æ–‡ä»¶ï¼Œ``.xml``æ–‡ä»¶ç­‰ç­‰ã€‚å‰ä¸‰ç§è·ç¦»å®é™…å¼€å‘å·¥ä½œæ›´è¿‘ï¼Œæ‰€æœ‰æˆ‘ä»¬è¯¦è¯´å‰ä¸‰ç§ï¼Œä¸‹é¢æˆ‘ä»¬å°±çœ‹çœ‹è¿™ä¸‰ç§``resourceèµ„æºæ–‡ä»¶`` ``spring``æ˜¯å¦‚ä½•åŠ è½½è§£æçš„

== åŠ è½½``.class``æ–‡ä»¶

è™½ç„¶éƒ½æ˜¯åŠ è½½``.class``æ–‡ä»¶ï¼Œä¹Ÿéƒ½æ˜¯ä»``classpath*``ä¸‹å»å¯»æ‰¾å¹¶åŠ è½½ï¼Œä½†æ˜¯åœ¨å…¥å‚ä¸Šæä¾›äº†ä¸åŒå±‚æ¬¡çš„ä¼ å…¥ï¼Œæ–¹å¼ä¸€æä¾›çš„æ˜¯æ³¨è§£å±æ€§é›†åˆå’ŒæŒ‡å®šç±»``class``ï¼Œæ–¹å¼äºŒæ˜¯``spring cloud openfeign``è‡ªå·±çš„å±‚çº§å‚å…¥ã€‚è¿™ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥ä¸ºæˆ‘ä»¬ç›´æ¥ä½¿ç”¨ã€‚å½“ç„¶ï¼Œæœ€ç»ˆç”¨çš„è¿˜æ˜¯å…¬å…±(é€šç”¨)éƒ¨åˆ†ï¼Œå³ï¼š``ClassPathScanningCandidateComponentProvider.findCandidateComponents(String)``

=== æ–¹å¼ä¸€ è§£ææ³¨è§£å±æ€§å€¼ç¡®å®š``package``ç›®å½•ä»è€Œå®ç°åŠ è½½``classpath*``ä¸‹æŒ‡å®šç›®å½•``*.class``æ–‡ä»¶

----
ComponentScanAnnotationParser class
public Set<BeanDefinitionHolder> parse(AnnotationAttributes componentScan, final String declaringClass ) {
    ClassPathBeanDefinitionScanner scanner = new ClassPathBeanDefinitionScanner(this.registry,
            componentScan.getBoolean("useDefaultFilters"), this.environment, this.resourceLoader);

    scanner.setBeanNameGenerator(this.beanNameGenerator);
    scanner.setScopedProxyMode(scopedProxyMode);
    scanner.setScopeMetadataResolver(BeanUtils.instantiateClass(resolverClass));
    scanner.setResourcePattern(componentScan.getString("resourcePattern"));
    scanner.addIncludeFilter(typeFilter);
    scanner.addExcludeFilter(typeFilter);
    scanner.getBeanDefinitionDefaults().setLazyInit(true);
    
    Set<String> basePackages = new LinkedHashSet<>();
    for (Class<?> clazz : componentScan.getClassArray("basePackageClasses")) {
        basePackages.add(ClassUtils.getPackageName(clazz));
    }

    return scanner.doScan(StringUtils.toStringArray(basePackages));
}

protected Set<BeanDefinitionHolder> doScan(String... basePackages) {
    Set<BeanDefinitionHolder> beanDefinitions = new LinkedHashSet<>();
    for (String basePackage : basePackages) {
        // è°ƒç”¨ä¸‹é¢çš„å…¬å…±éƒ¨åˆ†çš„æ–¹æ³•ï¼Œå³ClassPathScanningCandidateComponentProvider.findCandidateComponents(String)
        Set<BeanDefinition> candidates = findCandidateComponents(basePackage);
        for (BeanDefinition candidate : candidates) {
            String beanName = this.beanNameGenerator.generateBeanName(candidate, this.registry);
            if (checkCandidate(beanName, candidate)) {
                BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(candidate, beanName);
                beanDefinitions.add(definitionHolder);
                registerBeanDefinition(definitionHolder, this.registry);
            }
        }
    }
    return beanDefinitions;
}
----

=== æ–¹å¼äºŒ åŠ è½½æŒ‡å®š``package``ç›®å½•ä¸‹çš„``.class``æ–‡ä»¶
``spring cloud openfeign``ä½œä¸ºRPCè°ƒç”¨ç»„ä»¶ï¼Œä»–æ²¡æœ‰ç›´æ¥ä½¿ç”¨``spring``é€šç”¨çš„é€»è¾‘ï¼Œè€Œæ˜¯è‡ªå·±åœ¨åŠ è½½``feignç»„ä»¶çš„.class``æ—¶ï¼Œå®ƒè‡ªå·±å®ç°äº†ä¸€å¥—åŠ è½½é€»è¾‘ã€‚

----
FeignClientsRegistrar class
public void registerFeignClients(AnnotationMetadata metadata, BeanDefinitionRegistry registry) {
    ClassPathScanningCandidateComponentProvider scanner = getScanner();
    scanner.setResourceLoader(this.resourceLoader);
    scanner.addIncludeFilter(new AnnotationTypeFilter(FeignClient.class));

    Set<String> basePackages = getBasePackages(metadata);
    for (String basePackage : basePackages) {
        // è°ƒç”¨ä¸‹é¢çš„å…¬å…±éƒ¨åˆ†çš„æ–¹æ³•ï¼Œå³ClassPathScanningCandidateComponentProvider.findCandidateComponents(String)
        Set<BeanDefinition> candidateComponents = scanner.findCandidateComponents(basePackage);
        for (BeanDefinition candidateComponent : candidateComponents) {
            if (candidateComponent instanceof AnnotatedBeanDefinition) {
                // verify annotated class is an interface
                AnnotatedBeanDefinition beanDefinition = (AnnotatedBeanDefinition) candidateComponent;
                AnnotationMetadata annotationMetadata = beanDefinition.getMetadata();
                
                Map<String, Object> attributes = annotationMetadata
                        .getAnnotationAttributes(FeignClient.class.getCanonicalName());
             
                registerFeignClient(registry, annotationMetadata, attributes);
            }
        }
    }
}
----
é€šè¿‡åˆ›å»º``ClassPathScanningCandidateComponentProvider``å¯¹è±¡ï¼Œå¹¶ç»™ä»–èµ‹å€¼ç±»åŠ è½½å™¨ã€ç›®æ ‡ç±»å‹ç­‰ã€‚åŒæ—¶æä¾›packageç›®å½•å°±å¯ä»¥å®ŒæˆåŠ è½½å…¶ä¸‹çš„``.class``æ–‡ä»¶ï¼Œç„¶åç”ŸæˆBeanDefinitionæ”¾å…¥spring beanFactoryå®¹å™¨ã€‚è¿™å¯ä»¥è¯´å°±æ˜¯ä¸€ä¸ªå·¥å…·ç±»

å…¬å…±éƒ¨åˆ†(å³å®ç°åŸç†å†…éƒ¨)
----
ClassPathScanningCandidateComponentProvider class
public Set<BeanDefinition> findCandidateComponents(String basePackage) {
    return scanCandidateComponents(basePackage);
}

private Set<BeanDefinition> scanCandidateComponents(String basePackage) {
    Set<BeanDefinition> candidates = new LinkedHashSet<>();
    
    // å¦‚ classpath*:com/skyler/**/*.class
    String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +
            resolveBasePackage(basePackage) + '/' + this.resourcePattern;
    Resource[] resources = getResourcePatternResolver().getResources(packageSearchPath);
    for (Resource resource : resources) {
        MetadataReader metadataReader = getMetadataReaderFactory().getMetadataReader(resource);
        if (isCandidateComponent(metadataReader)) {
            ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader);
            candidates.add(sbd);
        }
     }
    return candidates;
}
----
å¦‚æ–¹æ³•æ‰€ç¤ºï¼ŒåŠ è½½çš„éƒ½æ˜¯``classpath*``ä¸‹æŒ‡å®šç›®å½•çš„``.class``ä»¬


== åŠ è½½``.factories``æ–‡ä»¶

=== é¡¹ç›®ä¸‹æ‰€æœ‰``jaråŒ…``ä¸­çš„``META-INF/spring.factories``åŠ è½½æŒ‡å®šçš„``class``ç±»å‹å¯¹è±¡é›†åˆ
----
List<EnvironmentPostProcessor> loadPostProcessors() {
    // æ ¸å¿ƒæ–¹æ³•
    return SpringFactoriesLoader.loadFactories(EnvironmentPostProcessor.class,
            getClass().getClassLoader());
}

// åº”ç”¨ç¤ºä¾‹
private void onApplicationEnvironmentPreparedEvent(ApplicationEnvironmentPreparedEvent event) {
    List<EnvironmentPostProcessor> postProcessors = loadPostProcessors();
    AnnotationAwareOrderComparator.sort(postProcessors);
    for (EnvironmentPostProcessor postProcessor : postProcessors) {
        postProcessor.postProcessEnvironment(event.getEnvironment(), event.getSpringApplication());
    }
}

----
åœ¨é¡¹ç›®ä¸‹æ‰€æœ‰``jaråŒ…``ä¸­çš„``META-INF/spring.factories``åŠ è½½æŒ‡å®šçš„``class``ç±»å‹å¯¹è±¡é›†åˆã€‚å¦‚ä¸Šæ–¹æ³•ï¼ŒåŠ è½½``EnvironmentPostProcessor``ç±»å‹çš„å¯¹è±¡é›†åˆ

== åŠ è½½``.properties/.yml``æ–‡ä»¶

è¯¦è§ï¼š``ConfigFileApplicationListener class``

== æ‰©å±•
``AnnotatedBeanDefinitionReaderä¸ClassPathBeanDefinitionScanner``å„è‡ªåŠŸèƒ½åŠåŒºåˆ«
----
public AnnotationConfigServletWebServerApplicationContext() {
    this.reader = new AnnotatedBeanDefinitionReader(this);
    this.scanner = new ClassPathBeanDefinitionScanner(this);
}
----