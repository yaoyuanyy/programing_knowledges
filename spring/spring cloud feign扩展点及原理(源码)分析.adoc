= spring cloud feignæ‰©å±•ç‚¹åŠåŸç†(æºç )åˆ†æ
:toc: left
:toc-title: ç›®å½•
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: â—
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
// :tip-caption: :bulb:
// :note-caption: :information_source:
// :important-caption: :heavy_exclamation_mark:	
// :caution-caption: :fire:
// :warning-caption: :warning:
:icons: font

Doc writer yaoyihao1@gmail.com

== èƒŒæ™¯

[tip]
è¿œç¨‹è°ƒç”¨å®ç°æŠ€æœ¯æ–¹æ¡ˆä¸­, spring cloud openfeignå¯ä»¥è¯´æ˜¯å…¥é—¨ç®€å•ï¼Œä½¿ç”¨æ–¹ä¾¿ã€‚ä½œä¸ºspring cloudå®¶æ—æˆå‘˜ï¼Œå®ƒçš„ä½¿ç”¨é‡å¹¿æ³›ã€‚äº†è§£spring framework, spring boot, spring cloudæœ¬èº«å°±æ˜¯ä¸€ä»¶æŠ€æœ¯äººåˆ†å†…çš„äº‹ã€‚è¿›é˜¶è·¯ä¸Šï¼Œè¿™æ˜¯å¿…é¡»åšçš„ã€‚

> debugæºç ï¼Œç›´è§‚æ”¶ç›Šæ˜¯å­¦ä¹ æ ‡å‡†çš„ä»£ç é£æ ¼ï¼Œç¼–ç æ€æƒ³ï¼Œå®ç°æ–¹æ³•å’ŒæŠ€å·§ï¼Œä»è€Œæå‡è‡ªèº«çš„èƒ½åŠ›
 
== æ”¶è·
æœ¬ç¯‡åé‡é˜è¿°`feign`çš„å®ç°åŸç†ï¼Œè€Œå¯¹ä»–çš„ç”¨æ³•ç”¨ä¸€ä¸ªç¤ºä¾‹ç®€å•å±•ç¤ºã€‚å› ä¸ºæœ¬ç¯‡è®©ä½ æ”¶è·çš„ä¸ä»…ä»…æ˜¯`feign`çš„ç”¨æ³•ï¼Œæ›´é‡è¦çš„æ˜¯é€šè¿‡`feign`çš„åŸç†é˜è¿°ï¼Œèƒ½æç‚¼å‡ºä¸ºä½ æˆ‘æ‰€ç”¨çš„çŸ¥è¯†ç‚¹ï¼Œä¸ºä½ è‡ªå·±å®ç°@EnableXXXæ³¨è§£æä¾›ä¸€äº›ä¾æ®å’Œç‰‡æ®µï¼ŒåŠ›äº‰å®ç°çªç ´ï¼Œç”Ÿäº§å‡ºä½ è‡ªå·±çš„ä¸œè¥¿ã€‚

æœ¬ç¯‡çš„ç›®æ ‡æ˜¯1.è¯´æ¸…`feign`ç»„ä»¶çš„åŠ è½½å³è§£æï¼Œå°¤å…¶æ˜¯å…³é”®ç»„ä»¶çš„åŸç†æºç é˜è¿°ï¼›2.å½“ç”¨æˆ·è¯·æ±‚è¿›æ¥åï¼Œ`feign`æ˜¯å¦‚ä½•å°†`feign`æ–¹æ³•è§£æä¸º`http request`è¯·æ±‚ä¿¡æ¯çš„ã€‚3.æ­¤å¤–ï¼Œåœ¨è¿™åŸºç¡€ä¸Šï¼Œé‡ç‚¹é˜è¿°`feign`æ•´ä¸ªè¿‡ç¨‹ç»™æˆ‘ä»¬å¸¦æ¥å“ªäº›ä»·å€¼ï¼šä¸¤æ–¹é¢
ä¸€ã€å¤ç”¨ç‚¹
----
1. å¦‚ä½•åŠ è½½ä¸€ä¸ªpackageä¸‹æŒ‡å®šçš„classæ–‡ä»¶å³ç”ŸæˆBeanDefinitionæ”¾å…¥springå®¹å™¨
2. Class<T>ç±»ç”ŸæˆTçš„instance
3. å¦‚ä½•è·å–springä¸­çš„BeanDefinitionã€Object
----

äºŒã€æ‰©å±•ç‚¹
----
1. æ‰©å±•RuquestInteceptorï¼Œå®ç°Getæ–¹å¼æ¥å—body data
2. è‡ªå®šä¹‰@EnableFeignClients.defaultConfigurationçš„å€¼
3. è‡ªå®šä¹‰@FeignClient.configurationçš„å€¼
4. properties.ymlå’Œ@Configurationå£°æ˜çš„feignç»„ä»¶çš„ä¼˜å…ˆçº§
5. è‡ªå®šä¹‰@EnableXXXç»„ä»¶ï¼Œè§£å†³å…¶ä»–çš„é—®é¢˜
----

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191109101703.png[20191109101703.png]


== ç¤ºä¾‹
ä¸‹é¢æ’¸å‡ºæœ€ç®€å•çš„feignä½¿ç”¨æ¡ˆä¾‹ã€‚`åˆ†åˆ«å®šä¹‰ä¸€ä¸ªå¯åŠ¨ç±»ã€controllerã€feignæ¥å£`ã€‚å¦‚ä¸‹ï¼Œå°†è¿™ä¸ªä½œä¸ºç´ æè¿›è¡Œ`feignæºç åˆ†æ`
----
@SpringBootApplication
@EnableFeignClients("com.skyler.manager")
@EnableDiscoveryClient
public class SkylerApplication {
    public static void main(String[] args) {
        SpringApplication.run(SkylerApplication.class, args);
    }
}

@RestController
@RequestMapping("/brand")
public class BrandController {
    @Autowired private BrandFeignClient brandFeignClient;

    @PostMapping(value = "/create", produces = MediaType.APPLICATION_JSON_VALUE, consumes = MediaType.APPLICATION_JSON_VALUE)
    public ResultVO create(@RequestBody BrandParam param) {
        return brandFeignClient.create(param);
    }
}

@FeignClient(value = "${provider.application:serverB}", contextId = "BrandFeignClient")
public interface BrandFeignClient {
    
    @PostMapping(value = "api/brand/create", produces = MediaType.APPLICATION_JSON_VALUE, consumes = MediaType.APPLICATION_JSON_VALUE)
    ResultDTO create(@RequestBody BrandParam param);

    @GetMapping("api/brand/query")
    ResultDTO<List<BrandDto>> query(@RequestParam("id") Long id, @RequestParam("code") String code);
}
----

== feignå…³é”®ç»„ä»¶ç±»
å…ˆåˆ—å‡º`feignå…³é”®`çš„åœ°æ–¹ï¼Œä½ æœ‰ä¸ªå¤§æ¦‚å°è±¡ï¼Œè¿›è¡Œæºç åˆ†ææ—¶å¸Œæœ›ä½ èƒ½æœ‰æ„è¯†çš„`é‡ç‚¹ç…§é¡¾`è¿™äº›å…³é”®ç‚¹ã€‚

| å…³é”®ç±» | ä½œç”¨| è¯´æ˜
| --- | ----| ---|
| @EnableFeignClient | å£°æ˜å¼•å…¥feignç»„ä»¶çš„æ ‡è¯†ï¼ŒåŒæ—¶è´Ÿè´£è§£æ@FeignClient
| @FeignClient |å£°æ˜ä¸€ä¸ªè¿œç¨‹è°ƒç”¨çš„æ¥å£ï¼Œä¾›ä¸šåŠ¡æ–¹å®Œæˆè¿œç¨‹è°ƒç”¨
|  FeignClientsRegistrar |åŠ è½½@FeignClientçš„æ‰€æœ‰.classæ–‡ä»¶ï¼Œç”ŸæˆbeanDefinitioinå’ŒbeanInstanceæ”¾å…¥springå®¹å™¨
| FeignClientFactoryBean |å®Œæˆfeignè¿œç¨‹è°ƒç”¨æ‰€éœ€è¦ç»„ä»¶çš„èšåˆï¼ŒåŒæ—¶è¿˜æœ‰@FeignClientçš„ä»£ç†ç±»çš„ç”Ÿæˆ
| FeignAutoConfiguration |AutoConfigurationçš„å­ç±»ï¼Œå®šä¹‰@Bean FeignContextã€@Bean xxxHttpClientç­‰
| FeignClientsConfiguration | "Feign configuration"çš„é»˜è®¤é…ç½®å€¼ï¼Œ@EnableFeignClients.defaultConfigurationå¦‚æœæ²¡æœ‰è®¾ç½®å€¼ï¼Œé»˜è®¤å°±æ˜¯FeignClientsConfigurationã€‚

== feignä»£ç åŠ è½½åŸç†
ä¸‹å›¾æ˜¯spring bootæ‰€æœ‰é¡¹ç›®åŠ è½½@Configurationçš„ç±»æ—¶éƒ½è¦èµ°çš„è·¯å¾„(é™¤äº†FeignClientsRegistrar)ã€‚å‚è§<springboot @Configurationç±»çš„åŠ è½½æºç å’Œæ‰©å±•ç‚¹è§£æ>

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191102190916.png[å›¾ä¸€]



=== feignç›¸å…³ç»„ä»¶çš„.classè½¬åŒ–ä¸ºBeanDefinition
è¿™ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†æˆä¸¤éƒ¨åˆ†ï¼š`FeignAutoConfigurationç±»å’ŒFeignClientsConfigurationç±»`ç­‰ï¼Œ`@EnableFeignClientså’Œ@FeignClient`ã€‚

å‰è€…åŠ è½½è¿‡ç¨‹åŒspring bootæ‰€æœ‰ç»„ä»¶åŠ è½½çš„é€»è¾‘ï¼Œæ­£å¦‚å›¾ä¸€æ‰€ç¤ºï¼›è€Œåè€…æ˜¯é‡‡ç”¨`feign`è‡ªå·±çš„åŠ è½½æ–¹å¼ã€‚å½“ç„¶ä¸¤è€…åŠ è½½è¿‡ç¨‹å¼€å§‹éƒ¨åˆ†æ˜¯ä¸€æ ·çš„ã€‚å³ä»`springApplication.run()`åˆ°`ConfigurationClassPostProcessor.processConfigBeanDefinitions()`æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿæ˜¯æ‰€æœ‰`spring boot`é¡¹ç›®å¯åŠ¨åŠ è½½å…±ç”¨çš„é€»è¾‘ã€‚ä½†æ˜¯ä»`processConfigBeanDefinitions()`æ–¹æ³•å†…å¼€å§‹å˜å¾—ä¸åŒäº†ã€‚`FeignAutoConfigurationç±»å’ŒFeignClientsConfigurationç±»`çš„åŠ è½½å¼€å§‹äºæ–¹æ³•å†…`315è¡Œçš„parser.parse(candidates)`,è€Œ`@EnableFeignClientså’Œ@FeignClient`çš„åŠ è½½å¼€å§‹äº`327è¡Œçš„this.reader.loadBeanDefinitions(configClasses)`ã€‚å…¶å®ï¼Œä»å¦ä¸€è§’åº¦å¯ä»¥è¯´`FeignAutoConfigurationç±»å’ŒFeignClientsConfiguration`ç±»çš„åŠ è½½æ˜¯é€šç”¨çš„ï¼Œ`@EnableFeignClientså’Œ@FeignClient`çš„åŠ è½½æ˜¯ç‰¹æ®Šçš„ï¼Œæ˜¯ä»é€šç”¨çš„æŸä¸€ä¸ªç‚¹æ‹‰å‡ºå»çš„åˆ†æ”¯ã€‚æ‰€ä»¥ç‰¹æ®Šçš„æ˜¯åœ¨é€šç”¨çš„åŸºç¡€ä¸Šè¿›è¡Œçš„ã€‚ä»ä¸¤ä¸ªä¸åŒç‚¹è¿›å…¥åˆ°å„è‡ªå…·ä½“çš„`.class-->BeanDefinition`çš„åŠ è½½è¿‡ç¨‹ã€‚åŒæ ·çš„ç›®çš„ï¼Œåªæ˜¯ä½¿ç”¨ä¸åŒçš„æ–¹å¼ã€‚ä¸‹é¢æˆ‘ä»¬è¯¦ç»†è¯´ä¸‹ä¸¤ç§åŠ è½½çš„æºç å’ŒåŸç†

NOTE::å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸¤ç§åŠ è½½æ–¹å¼éƒ½æ˜¯<font color=green>æˆ‘ä»¬å®é™…å¼€å‘è¿‡ç¨‹ä¸­çš„æ‰©å±•ç‚¹ï¼š.classè½¬åŒ–ä¸ºbeanDefinitonçš„ä»£ç è¿‡ç¨‹</font>ã€‚é‡å†™ä»–ä»¬ä»¥å®Œæˆæˆ‘ä»¬è‡ªå·±å®é™…çš„é€»è¾‘

==== FeignAutoConfigurationç±»å’ŒFeignClientsConfigurationç±»ç­‰
å‰é¢è¯´åˆ°ï¼Œä»–ä»¬çš„åŠ è½½å¼€å§‹äºConfigurationClassPostProcessor.processConfigBeanDefinitions()æ–¹æ³•çš„`315è¡Œ: çš„parser.parse(candidates)`ã€‚æˆ‘ä»¬å°±ä»è¿™é‡Œè¯´èµ·
----
public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) {
    List<BeanDefinitionHolder> configCandidates = new ArrayList<>();
    String[] candidateNames = registry.getBeanDefinitionNames();
    for (String beanName : candidateNames) {
        BeanDefinition beanDef = registry.getBeanDefinition(beanName);
        // æ£€æŸ¥beanDefinitionçš„beanClassæ˜¯å¦ä¸ºæ ‡è¯†äº†@Configurationçš„classï¼Œç¬¦åˆçš„æ”¾å…¥é›†åˆ
        if (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, this.metadataReaderFactory)) {
            configCandidates.add(new BeanDefinitionHolder(beanDef, beanName));
        }
    }
    // æ ¹æ®@Orderç»™é›†åˆä¸­çš„å¯¹è±¡æ’åºï¼Œä¹Ÿå°±æ˜¯å¯¹è±¡è¢«åŠ è½½çš„é¡ºåº
    configCandidates.sort((bd1, bd2) -> {
        int i1 = ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());
        int i2 = ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());
        return Integer.compare(i1, i2);
    });

    // Parse each @Configuration class
    ConfigurationClassParser parser = new ConfigurationClassParser(
            this.metadataReaderFactory, this.problemReporter, this.environment,
            this.resourceLoader, this.componentScanBeanNameGenerator, registry);

    Set<BeanDefinitionHolder> candidates = new LinkedHashSet<>(configCandidates);
    do {`
        // FeignAutoConfigurationç±»å’ŒFeignClientsConfigurationç±»ç­‰é€šç”¨ç»„ä»¶çš„åŠ è½½å¼€å§‹å¤„
        // æ–¹æ³•åŠŸèƒ½ä¸ºä»¥candidatesä¸ºèµ·ç‚¹è¿›è¡Œå‘ä¸‹åŠ è½½ã€‚ä¸€èˆ¬ä¸ºé¡¹ç›®çš„å¯åŠ¨ç±»ï¼Œå¦‚è¿™é‡Œçš„SkylerApplication
        parser.parse(candidates);
        parser.validate();

        Set<ConfigurationClass> configClasses = new LinkedHashSet<>(parser.getConfigurationClasses());
        // Read the model and create bean definitions based on its content
        if (this.reader == null) {
            this.reader = new ConfigurationClassBeanDefinitionReader(
                registry, this.sourceExtractor, this.resourceLoader, this.environment,
                this.importBeanNameGenerator, parser.getImportRegistry());
        }
        // @EnableFeignClientså’Œ@FeignClientçš„åŠ è½½å¤„ï¼Œå½“ç„¶é€šç”¨çš„åŠ è½½ä¹Ÿä¼šèµ°è¿™é‡Œ
        // æ–¹æ³•åŠŸèƒ½ä¸ºè§£ææ¯ä¸ªConfigurationClassï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰@Bean @Import @ImportResource @Scopeæ³¨è§£ï¼Œå¦‚æœå¦‚è§£æä»–ä»¬å½¢æˆBeanDefinitionï¼Œæ”¾å…¥beanFactoryå®¹å™¨ä¸­
        this.reader.loadBeanDefinitions(configClasses);

        candidates.clear();
        if (registry.getBeanDefinitionCount() > candidateNames.length) {
            String[] newCandidateNames = registry.getBeanDefinitionNames();
            for (String candidateName : newCandidateNames) {
                    BeanDefinition bd = registry.getBeanDefinition(candidateName);
                    if (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, this.metadataReaderFactory)) {
                        candidates.add(new BeanDefinitionHolder(bd, candidateName));
                    }
                }
            }
            candidateNames = newCandidateNames;
        }
    }
    while (!candidates.isEmpty());
}
----
è¯¦ç»†çš„åŠ è½½æ˜¯å§‹äºparser.parse(candidates)è¡Œï¼Œè¯¦ç»†å‚è§todoã€‚åˆ°è¿™é‡Œï¼ŒFeignAutoConfigurationç±»å’ŒFeignClientsConfigurationç±»çš„åŠ è½½å’Œè§£æå°±å®Œæˆäº†ã€‚æ ¸å¿ƒæ˜¯å°†ç±»ä¸­@Beanæ–¹æ³•(å¦‚feignEncoder()ã€feignDecoder()ã€feignBuilder()ç­‰)åŠ è½½æˆBeanDefinitionæ”¾å…¥spring beanFactoryå®¹å™¨ä¸­ï¼Œä¸ºBeanDefinitionè½¬åŒ–ä¸ºBeanInstanceåšå‡†å¤‡ã€‚@Configurationæ ‡è¯†çš„classç”±BeanDefinitionè½¬åŒ–ä¸ºBeanInstanceçš„è¯¦ç»†è¿‡ç¨‹å‚è§todo@Configuration classè§£æ

==== @EnableFeignClientså’Œ@FeignClient
è¿™éƒ¨åˆ†çš„åŠ è½½æ˜¯ä»processConfigBeanDefinitions()æ–¹æ³•çš„`327è¡Œçš„this.reader.loadBeanDefinitions(configClasses)`å¼€å§‹ï¼Œå†å¾€é‡Œè¯´æ˜¯ä»æ­¤æ–¹æ³•å†…çš„ConfigurationClassBeanDefinitionReader.loadBeanDefinitionsForConfigurationClass()å¼€å§‹çš„ã€‚ä¹Ÿå°±æ˜¯å¼€å§‹å¤„ç†ConfigurationClasså¯¹è±¡ã€‚å½“å¤„ç†åˆ°ConfigurationClass(SkylerApplication)æ—¶ï¼Œå°±ä¼šè§¦å‘@EnableFeignClientsçš„è§£æäº†ã€‚åŸç†ä¸º@EnableFeignClientsæ ‡æ³¨åœ¨å¼•å…¥äº†@SpringBootApplication(å†…å«@Configuration)çš„SkylerApplicationç±»ä¸Š,å³SkylerApplicationç±»æ ‡æ³¨äº†@Configurationæ³¨è§£ï¼Œæ‰€ä»¥ï¼ŒSkylerApplicationä¼šè¢«è§£ææˆConfigurationClasså¯¹è±¡ã€‚ä¸”@EnableFeignClientså†…å«@Importæ³¨è§£ï¼Œæ‰€ä»¥ConfigurationClassPostProcessorè§£æè¿™ä¸ªConfigurationClass(SkylerApplication)å¯¹è±¡æ—¶ï¼Œä¼šåŠ è½½åˆ°@EnableFeignClientså†…åµŒæ³¨è§£@Importçš„FeignClientsRegistrarç±»ã€‚åˆFeignClientsRegistraræ˜¯ImportBeanDefinitionRegistrarå­ç±»ï¼Œæ‰€ä»¥ConfigurationClassBeanDefinitionReaderåœ¨è§£æImportBeanDefinitionRegistrarç±»å‹æ—¶ï¼Œä¼šè§£æFeignClientsRegistrarå¯¹è±¡ï¼Œå³Feignç›¸å…³ç»„ä»¶è§£æå’ŒåŠ è½½å°±å¼€å§‹äº†ã€‚

ç”±äºFeignClientsRegistraræ˜¯ImportBeanDefinitionRegistrarç±»å‹ï¼Œå®ƒé‡è½½äº†registerBeanDefinitions()æ–¹æ³•æ¥å®ç°è§£æ@FeignClientçš„åŠŸèƒ½ï¼Œè¿™ä¹Ÿæ˜¯FeignClientsRegistrarç±»çš„æ ¸å¿ƒä½œç”¨ã€‚å¦‚ä¸‹ä»£ç 
----
@Override
public void registerBeanDefinitions(AnnotationMetadata metadata,
        BeanDefinitionRegistry registry) {
    // è§£æ@EnableFeignClientsçš„defaultConfigurationå±æ€§ï¼Œç”¨äºfeignçš„å…¨å±€è®¾ç½®       
    registerDefaultConfiguration(metadata, registry);
    // è§£æ@FeignClientæ³¨è§£
    registerFeignClients(metadata, registry);
}
----
æ–¹æ³•çš„å…¥å‚ï¼šmetadataæ˜¯ConfigurationClassçš„å…ƒæ³¨è§£ä¿¡æ¯ï¼Œå³SkylerApplicationç±»çš„æ³¨è§£ä¿¡æ¯ï¼›registryæ˜¯DefaultListableBeanFactoryå¯¹è±¡å¼•ç”¨ã€‚è§£æç”Ÿæˆçš„BeanDefinitionéƒ½æ”¾å…¥spring beanFactoryå®¹å™¨

----
private void registerDefaultConfiguration(AnnotationMetadata metadata,
        BeanDefinitionRegistry registry) {
    // è·å–EnableFeignClientsæ³¨è§£çš„å±æ€§åŠå€¼        
    Map<String, Object> defaultAttrs = metadata
            .getAnnotationAttributes(EnableFeignClients.class.getName(), true);
    // è·å–çš„å±æ€§åŠnameå­˜å…¥springçš„BeanFactoryå®¹å™¨å†…
    registerClientConfiguration(registry, name,
            defaultAttrs.get("defaultConfiguration"));
    }
}
----
<font color=green>è¿™é‡Œæˆ‘ä»¬å®é™…å¼€å‘ä¸­çš„æ‰©å±•ç‚¹ä¸º:</font>å¼•å…¥@EnableFeignClientsæ—¶ï¼Œå¯ä»¥è‡ªå®šä¹‰å®ƒçš„defaultConfigurationå±æ€§çš„å€¼ï¼Œä»è€Œå®ç°æˆ‘ä»¬è‡ªå·±å…³äºFeignçš„é…ç½®ã€‚å¦‚é‡å†™Feignè¯·æ±‚å“åº”ä¿¡æ¯çš„åŠ å¯†è§£å¯†ã€fallbackã€fallbackFactoryç­‰

æˆ‘ä»¬é‡ç‚¹çœ‹registerFeignClients()æ–¹æ³•çš„é€»è¾‘ï¼šåŠ è½½æ ‡æ³¨äº†@FeignClientçš„.classæ–‡ä»¶ï¼Œè§£æå¹¶è·å–ç¬¦åˆæ¡ä»¶çš„classï¼Œç”ŸæˆBeanDefinitionï¼Œæ”¾å…¥spring beanFactoryå®¹å™¨ã€‚ä»£ç å¦‚ä¸‹
----
public void registerFeignClients(AnnotationMetadata metadata,
        BeanDefinitionRegistry registry) {
    // å®ä¾‹åŒ–å¯¹è±¡
    ClassPathScanningCandidateComponentProvider scanner = getScanner();
    scanner.setResourceLoader(this.resourceLoader);

    Set<String> basePackages;

    Map<String, Object> attrs = metadata
            .getAnnotationAttributes(EnableFeignClients.class.getName());
    AnnotationTypeFilter annotationTypeFilter = new AnnotationTypeFilter(
            FeignClient.class);
    final Class<?>[] clients = attrs == null ? null
            : (Class<?>[]) attrs.get("clients");
    // ç¡®å®šè¦æœç´¢çš„package
    if (clients == null || clients.length == 0) {
        scanner.addIncludeFilter(annotationTypeFilter);
        basePackages = getBasePackages(metadata);
    }
    else {
        final Set<String> clientClasses = new HashSet<>();
        basePackages = new HashSet<>();
        for (Class<?> clazz : clients) {
            basePackages.add(ClassUtils.getPackageName(clazz));
            clientClasses.add(clazz.getCanonicalName());
        }
        AbstractClassTestingTypeFilter filter = new AbstractClassTestingTypeFilter() {
            @Override
            protected boolean match(ClassMetadata metadata) {
                String cleaned = metadata.getClassName().replaceAll("\\$", ".");
                return clientClasses.contains(cleaned);
            }
        };
        scanner.addIncludeFilter(new AllTypeFilter(Arrays.asList(filter, annotationTypeFilter)));
    }

    // åŠ è½½packageå°†æ ‡æ³¨äº†@FeignClientçš„.classè½¬åŒ–ä¸ºBeanDefinitionï¼Œæ”¾å…¥spring beanFactoryå®¹å™¨
    for (String basePackage : basePackages) {
        Set<BeanDefinition> candidateComponents = scanner.findCandidateComponents(basePackage);

        for (BeanDefinition candidateComponent : candidateComponents) {
            if (candidateComponent instanceof AnnotatedBeanDefinition) {
                AnnotatedBeanDefinition beanDefinition = (AnnotatedBeanDefinition) candidateComponent;
                AnnotationMetadata annotationMetadata = beanDefinition.getMetadata();
                 
                Map<String, Object> attributes = annotationMetadata
                        .getAnnotationAttributes(FeignClient.class.getCanonicalName());

                // è·å–@FeignClientçš„configurationå±æ€§å€¼ï¼Œç”ŸæˆBeanDefinitionæ”¾å…¥spring beanFactoryå®¹å™¨
                // è¿˜è®°å¾—@EnableFeignClient.defaultConfigurationçš„å±æ€§å€¼å—ï¼Œå¯¹æ¯”@FeignClient.configurationï¼Œæ‰€ä»¥å‰è€…æ˜¯æ‰€æœ‰@FeignClientä½¿ç”¨ï¼Œåè€…æ˜¯å•ä¸ª@FeignClientä½¿ç”¨ï¼Œåè€…ä¼˜å…ˆçº§é«˜äºå‰è€…
                registerClientConfiguration(registry, getClientName(attributes), attributes.get("configuration"));
                // å°†æ¯ä¸ª@FeignClientè§£æï¼Œç”ŸæˆBeanDefinitionæ”¾å…¥spring BeanFactoryå®¹å™¨
                registerFeignClient(registry, annotationMetadata, attributes);
            }
        }
    }
}
----
ä¸ºæœç´¢åˆ°ç¬¦åˆæ¡ä»¶çš„@FeignClientçš„ç±»ï¼Œæ­¤æ–¹æ³•åˆ†ä¸¤æ­¥
1. é¦–å…ˆï¼Œç¡®å®šè¦æœç´¢çš„packageç›®å½•
2. å…¶æ¬¡ï¼Œä»è¿™äº›packageç›®å½•ä¸‹è·å–å’Œè§£æ@FeignClientçš„ç±»

æ–¹æ³•åˆ†ä¸‰ä¸ªæƒ…å†µæ¥ç¡®å®špackageåŒ…ç›®å½•ï¼šä¼˜å…ˆä»@EnableFeignClients.clientsè·å–å±æ€§å€¼ï¼Œä»è€Œç¡®å®špackageç›®å½•ï¼›ç¬¬äºŒä¼˜å…ˆçº§ä»EnableFeignClientsçš„å±æ€§valueã€basePackagesã€basePackageClassesè·å–å±æ€§å€¼ï¼Œä»è€Œç¡®å®špackageç›®å½•ï¼›æœ€åä¼˜å…ˆçº§ä»@EnableFeignClientæ‰€åœ¨çš„ç±»çš„packageï¼Œä»è€Œç¡®å®špackageç›®å½•ã€‚

ç¡®å®šäº†packageç›®å½•åï¼Œå¼€å§‹åŠ è½½packageåŒ…ç›®å½•ä¸‹æ ‡æ³¨äº†@FeignClientçš„.classæ–‡ä»¶ã€‚åŠ è½½.classæ–‡ä»¶ä½¿ç”¨çš„æ˜¯ClassPathScanningCandidateComponentProviderç±»ï¼Œè¿™ä¸ªç±»çš„resourceLoaderå˜é‡æä¾›classLoaderæ¥åŠ è½½.classæ–‡ä»¶ï¼›åŒæ—¶includeFilterså˜é‡æ ‡è¯†è¦å°†å“ªäº›ç±»è½¬åŒ–ä¸ºBeanDefinitionã€‚æœ€åå°†BeanDefinitionæ”¾å…¥spring BeanFactoryå®¹å™¨ã€‚ä¸ºäº†å°½é‡ä¸æ‰°ä¹±feignéƒ¨åˆ†ï¼ŒåŠ è½½.classåŠè½¬åŒ–ä¸ºBeanDefinitionè¿™é‡Œä¸é˜è¿°ï¼Œè¯¦ç»†ä»£ç è§ClassPathScanningCandidateComponentProvider.scanCandidateComponents()æ–¹æ³•

ç‰¹åˆ«æ³¨æ„ï¼š<font color=green>è¿™é‡Œæœ‰ä¸€ä¸ªæˆ‘ä»¬å®é™…å¼€å‘ä¸­çš„æ‰©å±•ç‚¹: åŠ è½½æŒ‡å®špackageç›®å½•ä¸‹æ ‡æ³¨äº†æŒ‡å®šæ³¨è§£çš„.classæ–‡ä»¶ä»¬è½¬åŒ–ä¸ºBeanDefinitioonæ”¾å…¥spring beanFactoryå®¹å™¨</font>ã€‚å…·ä½“å¦‚ä¸‹
----
ç¬¬ä¸€æ­¥ï¼š
ClassPathScanningCandidateComponentProvider scanner = getScanner();
scanner.setResourceLoader(this.resourceLoader);
AnnotationTypeFilter annotationTypeFilter = new AnnotationTypeFilter(FeignClient.class);
scanner.addIncludeFilter(annotationTypeFilter);
ç¬¬äºŒæ­¥ï¼š
Set<BeanDefinition> candidateComponents = scanner.findCandidateComponents(basePackage);
ç¬¬ä¸‰æ­¥ï¼š
BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry); //registryä¸ºBeanDefinitionRegistryåŠå­ç±»æˆ–DefaultListableBeanFactory

----
ç»è¿‡ä»¥ä¸Šä¸‰æ­¥ï¼Œå°±å¯ä»¥å°†æŒ‡å®špackageä¸‹çš„.classæ–‡ä»¶è½¬åŒ–ä¸ºBeanDefinitionï¼Œè¿›è€Œæ”¾å…¥spring çš„BeanFactoryå®¹å™¨ä¸­ã€‚å¦‚:ä½ åœ¨å®é™…å¼€å‘ä¸­ï¼Œéœ€è¦åŠ è½½com.yourcompany.projectNameä¸‹çš„å¸¦æœ‰@LoginAccessæ³¨è§£çš„.classæ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨ä¸Šé¢çš„ä»£ç ï¼Œç¨åŠ æ”¹åŠ¨å°±okäº†


åœ¨å°†æ¯ä¸ª@FeignClientè½¬åŒ–ç”ŸæˆBeanDefinitionæ”¾å…¥spring BeanFactoryå®¹å™¨æ—¶ï¼Œè¿™é‡Œæ³¨æ„ä¸€ç‚¹ï¼šç”Ÿæˆçš„BeanDefinitionçš„beanClasså€¼ä¸ºFeignClientFactoryBeanç±»å‹(FeignClientFactoryBeanæ˜¯FactoryBeançš„å­ç±»ï¼Œåœ¨beanDefinitionç”ŸæˆbeanInstanceæ—¶å‘æŒ¥ä½œç”¨)ã€‚å¦‚ä¸‹ä»£ç 
----
private void registerFeignClient(BeanDefinitionRegistry registry,
		AnnotationMetadata annotationMetadata, Map<String, Object> attributes) {
    String className = annotationMetadata.getClassName();
    BeanDefinitionBuilder definition = BeanDefinitionBuilder.genericBeanDefinition(FeignClientFactoryBean.class);
    Â·Â·Â·
    BeanDefinitionHolder holder = new BeanDefinitionHolder(beanDefinition, className,new String[] { alias });
    BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry);
	}
----
ç°åœ¨ï¼Œfeignç›¸å…³ç»„ä»¶çš„.classè½¬åŒ–ä¸ºBeanDefinitionäº†ï¼ŒBeanDefinitionéƒ½æ”¾å…¥äº†spring beanFactoryå®¹å™¨ï¼Œå³DefaultListableBeanFactroy.beanDefinitionMapå±æ€§ï¼Œè¿™ä¸€é˜¶æ®µå·²ç»å®Œæˆã€‚æˆ‘ä»¬ä»¥ä¸€ä¸ªå®ä¾‹ç»“æŸè¿™ä¸€é˜¶æ®µï¼šBrandFeignClientæ ‡æ³¨äº†@FeignClientï¼Œæ‰€ä»¥BrandFeignClientç±»è½¬åŒ–ä¸ºBeanDefinitionæ—¶ã€‚ç”Ÿæˆçš„BeanDefinitionçš„beanClasså€¼ä¸ºFeignClientFactoryBean.classï¼ŒåŒæ—¶BeanDefinitionçš„beanNameä¸ºBrandFeignClientå…¨é™å®šåã€‚beanNameå­˜å…¥beanFactory.beanDefinitionNamesï¼›åŒæ—¶ï¼ŒbeanNameä¸ºkeyï¼ŒBeanDefinitionä¸ºvalueçš„mapå­˜å…¥beanFactory.beanDefinitionMapã€‚éœ€è¦è·å–BeanDefinitionæ—¶ï¼ŒbeanFactoryå®¹å™¨æ˜¯ä»¥beanNameä¸ºkeyä»beanDefinitionMapå±æ€§ä¸­å–å¯¹åº”çš„BeanDefinitionçš„ã€‚


=== feignç›¸å…³ç»„ä»¶çš„BeanDefinitionè½¬åŒ–ä¸ºBeanInstance
å¦‚æœè¯´AbstractApplicatonContext.invokeBeanFactoryPostProcessors()è´Ÿè´£åŠ è½½.classåˆ°BeanDefinitionçš„è½¬åŒ–ï¼Œé‚£ä¹ˆAbstractApplicationContext.registerBeanPostProcessors()å°±è´Ÿè´£BeanDefinitionåˆ°BeanInstanceçš„è½¬åŒ–ã€‚è¿™æ­£å¥½å°è¯äº†æˆ‘åœ¨ https://yaoyuanyy.github.io/2019/03/12/BeanFactoryPostProcessory%E4%B8%8EBeanPostProcessor%E5%8C%BA%E5%88%AB/[BeanFactoryPostProcessoryä¸BeanPostProcessoråŒºåˆ«
] æ‰€é˜è¿°çš„é‚£æ ·ã€‚beanDefinitionè½¬åŒ–ä¸ºbeanInstanceæ˜¯spring booté€šç”¨çš„é€»è¾‘ã€‚è¯¦ç»†å‚è§ https://yaoyuanyy.github.io/2019/04/12/springboot%20beanDefinition%E8%BD%AC%E5%8C%96%E4%B8%BAbeanInstance%E8%BF%87%E7%A8%8B%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E5%92%8C%E6%89%A9%E5%B1%95%E7%82%B9/[springboot beanDefinitionè½¬åŒ–ä¸ºbeanInstanceè¿‡ç¨‹æºç åˆ†æå’Œæ‰©å±•ç‚¹
] ã€‚å¤§æ¦‚çš„é€»è¾‘æ˜¯ä»beanFactoryå®¹å™¨ä¸­çš„beanDefinitionNameså’ŒbeanDefinitionMapå±æ€§ä¸­å–å‡ºBeanDefinitionè¿›è¡Œå®ä¾‹åŒ–ï¼Œèµ‹å±æ€§å€¼ç­‰ç”ŸæˆBeanDefinition.beanClasså¯¹åº”çš„beanInstanceï¼Œç„¶åæ”¾å…¥DefaultSingletonBeanRegistry(beanFactoryçˆ¶ç±»).singletonObjectså±æ€§ä¸­ã€‚åé¢ç”¨åˆ°çš„æ—¶å€™æ ¹æ®keyä»è¿™ä¸ªå±æ€§ä¸­è·å–beanInstance

é€šè¿‡beanDefinitionè½¬åŒ–ä¸ºbeanInstanceæ˜¯é€šç”¨é€»è¾‘ï¼Œå¦‚ä¸‹å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191105185059.png[20191105185059.png]
å›¾ä¸­doCreateBeanå¼€å§‹å˜å¾—ä¸åŒäº†ï¼Œå› ä¸ºåœ¨springä¸­beanæœ‰ä¸¤ç§ç±»å‹ï¼šFactoryBeanå’ŒBeanï¼›å¦‚æœæ˜¯FactoryBeanï¼Œä¼šæ ¹æ®beanNameä»AbstractAutowiredCapableBeanFactory.factoryBeanInstanceCacheè·å–å‡ºbeanInstanceï¼Œæ¥ç€ä¼ ç»™populateBean()æ–¹æ³•å†è¿›è¡Œå¤„ç†ï¼Ÿï¼Œå½“ç„¶å¦‚æœæ²¡æœ‰è·å–åˆ°ï¼ŒåŒæ ·èµ°Beanç±»å‹çš„é€»è¾‘ï¼Œå³å¦‚æœæ˜¯Beanï¼Œä¼šè°ƒç”¨createBeanInstance(beanNameï¼Œmbdï¼ŒÂ·Â·)é€šè¿‡è§£æmbd(BeanDefinitionç±»å‹)å¾—åˆ°beanInstanceï¼Œç„¶åå°†beanInstanceå­˜å…¥DefaultSingletonBeanRegistry(beanFactoryçˆ¶ç±»).singletonObjectsã€‚æ˜¾ç„¶ï¼Œ@FeignClientæ ‡è¯†çš„ç±»çš„BeanDifinitionçš„beanClassæ˜¯FactoryBeanç±»å‹(FeignClientFactoryBean)ï¼Œæ‰€ä»¥ä»–èµ°FactoryBeançš„é€»è¾‘ã€‚æˆ‘ä»¬ç›´æ¥å®šä½åˆ°è½¬åŒ–çš„å…³é”®ä»£ç 
----
AbstractAutowiredCapableBeanFactory class
@Override
protected Object createBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)  {
    Object beanInstance = doCreateBean(beanName, mbd, args); // (1)
    return beanInstance;
}

protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final @Nullable Object[] args){
    // Instantiate the bean.
    BeanWrapper instanceWrapper = null;
    if (mbd.isSingleton()) {
        instanceWrapper = this.factoryBeanInstanceCache.remove(beanName);
    }
    if (instanceWrapper == null) {
        instanceWrapper = createBeanInstance(beanName, mbd, args);
    }
}

protected BeanWrapper createBeanInstance(String beanName, RootBeanDefinition mbd, @Nullable Object[] args) {
    return instantiateBean(beanName, mbd);
}

protected BeanWrapper instantiateBean(final String beanName, final RootBeanDefinition mbd) {
    Object beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, parent);
    BeanWrapper bw = new BeanWrapperImpl(beanInstance);
    initBeanWrapper(bw);
    return bw;
}

SimpleInstantiationStrategy class
public Object instantiate(RootBeanDefinition bd, @Nullable String beanName, BeanFactory owner) {
    final Class<?> clazz = bd.getBeanClass();
    Constructor<?> constructorToUse = clazz.getDeclaredConstructor();
    return BeanUtils.instantiateClass(constructorToUse);
}
----
ä¸Šé¢è¿™å‡ ä¸ªæ–¹æ³•å±•ç¤ºäº†beanInstanceç”Ÿæˆçš„å¤§æ¦‚è¿‡ç¨‹ã€‚ç‰¹åˆ«æ³¨æ„ï¼Œè¿™é‡Œæœ‰<font color=green>æˆ‘ä»¬å®é™…å¼€å‘ä¸­çš„æ‰©å±•ç‚¹:</font> Class<T>ç±»ç”ŸæˆTçš„instance
----
ç¬¬ä¸€æ­¥ï¼šå¾—åˆ°T.classçš„Class clazzå¯¹è±¡ --> clazz=T.class
ç¬¬äºŒæ­¥ï¼šè·å–clazzçš„æ„é€ å‡½æ•° --> constructorToUse=clazz.getDeclaredConstructor()
ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆinstance --> BeanUtils.instantiateClass(constructorToUse)
----
ç°åœ¨ï¼ŒBeanDefintionè½¬åŒ–æˆBeanInstanceäº†ã€‚å¦‚æœæ‹¿BrandFeignClientæ¥è¯´çš„è¯ï¼ŒBeanDefintion(class BrandFeignClient)è½¬åŒ–ä¸ºBrandFeignClientå¯¹è±¡äº†ï¼Œä¸”BrandFeignClientå¯¹è±¡ä½œä¸ºvalue(keyä¸ºBrandFeignClientå…¨é™å®šå)å­˜å…¥DefaultSingletonBeanRegistry(beanFactoryçˆ¶ç±»).singletonObjects

=== feignç›¸å…³ç»„ä»¶çš„BeanInstanceè½¬åŒ–ä¸ºproxyä»£ç†ç±»
å½“å¼•ç”¨äº†@FeignClientçš„ç±»çš„ç±»è¢«å®ä¾‹åŒ–æ—¶ï¼Œä¼šinjectè¿™ä¸ª@FeignClientçš„ç±»ï¼Œè¿™æ—¶å€™ä¼šé€šè¿‡ä»£ç†ç”Ÿæˆ@FeignClientçš„ç±»çš„ä»£ç†ç±»ï¼Œç„¶åèµ‹å€¼ç»™å®ä¾‹åŒ–çš„ç±»ã€‚ä»¥æˆ‘ä»¬å¼€ç¯‡ç¤ºä¾‹ä»£ç æ¥è¯´ï¼Œå½“BrandControllerç±»å®ä¾‹åŒ–æ—¶ï¼Œä»–çš„æˆå‘˜å˜é‡BrandFeignClientä¹Ÿä¼šè¢«èµ‹å€¼ï¼Œè€Œè¿™ä¸ªå€¼æ˜¯é€šè¿‡ä¸Šé¢è®²åˆ°çš„beanInstanceå³FeignClientFactoryBeanå¯¹è±¡ç”Ÿæˆproxyä»£ç†ç±»ï¼Œä»è€Œå®ç°Controllerè°ƒç”¨RPCè¿œç¨‹æ¥å£ã€‚æˆ‘ä»¬é‡ç‚¹é˜è¿°ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¹Ÿæ˜¯RPCæŠ€æœ¯çš„é€šç”¨å®ç°æ–¹å¼

å…ˆè¯´ä¸‹å¦‚ä½•è·å–åˆ°FeignClientFactoryBeanå¯¹è±¡çš„ï¼Œä»£ç å¦‚ä¸‹
----
AbstractBeanFactory class
protected <T> T doGetBean(final String beanName) throws BeansException {
    Object sharedInstance = getSingleton(beanName);
    Object bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);
}

DefaultSingletonBeanRegistry class
protected Object getSingleton(String beanName, boolean allowEarlyReference) {
    Object singletonObject = this.singletonObjects.get(beanName);
	return singletonObject;
}

FactoryBeanRegistrySupport class
protected Object getObjectFromFactoryBean(FactoryBean<?> factory, String beanName, boolean shouldPostProcess) {
    object = doGetObjectFromFactoryBean(factory, beanName);
	return object;
}
private Object doGetObjectFromFactoryBean(final FactoryBean<?> factory, final String beanName) {
    object = factory.getObject();
}

FeignClientFactoryBean class
@Override
public Object getObject() throws Exception {
    return getTarget();
}

FeignClientFactoryBean class
<T> T getTarget() {
    FeignContext context = this.applicationContext.getBean(FeignContext.class); //(1)
    Feign.Builder builder = feign(context); //(2)

    if (!StringUtils.hasText(this.url)) {
        if (!this.name.startsWith("http")) {
            this.url = "http://" + this.name;
        }
        else {
            this.url = this.name;
        }
        this.url += cleanPath();
        return (T) loadBalance(builder, context,
                new HardCodedTarget<>(this.type, this.name, this.url));
    }
    if (StringUtils.hasText(this.url) && !this.url.startsWith("http")) {
        this.url = "http://" + this.url;
    }
    String url = this.url + cleanPath();
    Client client = getOptional(context, Client.class);
    if (client != null) {
        if (client instanceof LoadBalancerFeignClient) {
            // not load balancing because we have a url,
            // but ribbon is on the classpath, so unwrap
            client = ((LoadBalancerFeignClient) client).getDelegate();
        }
        builder.client(client);
    }
    Targeter targeter = get(context, Targeter.class); //(3)
    return (T) targeter.target(this, builder, context,
            new HardCodedTarget<>(this.type, this.name, url)); //(4)
}   
----
è¿›åˆ°FeignClientFactoryBean.getObject()æ–¹æ³•ï¼Œå…³äº@FeignClientç±»ç”Ÿæˆproxyä»£ç†ç±»çš„è¿‡ç¨‹å°±åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ã€‚è¿™ä¸ªé€»è¾‘åˆ†ä¸ºå››æ­¥ï¼š
----
1. è·å–FeignContextå¯¹è±¡
2. è·å–Feign.Builderå¯¹è±¡
3. è·å–Targeterå¯¹è±¡
4. è°ƒç”¨Targeter.targeter()ç”Ÿæˆproxyä»£ç†ç±»
----
ç‰¹åˆ«è¯´ä¸€ä¸‹ï¼Œåœ¨æ­¥éª¤2åæœ‰ä¸ªæŒºå…³é”®çš„é€»è¾‘ç‚¹ï¼šä¼šä»¥urlä¸ºåˆ†çº¿ï¼Œå¦‚æœæ²¡æœ‰urlå°±ä¼šèµ°è´Ÿè½½å‡è¡¡ï¼Œåä¹‹æ²¡æœ‰ã€‚åˆ†çº¿çš„æ„ä¹‰ä»·å€¼åœ¨äºæˆ‘ä»¬å¯ä»¥ä»¥ä¸¤ç§æ–¹å¼ä½¿ç”¨feignè¿œç¨‹è°ƒç”¨ï¼Œä¸€æ˜¯é€šè¿‡urlå±æ€§å€¼ç›´æ¥é€šè¿‡`åŸŸåè°ƒç”¨`httpæ¥å£ï¼›äºŒæ˜¯é€šè¿‡Eurekaèµ°è´Ÿè½½å‡è¡¡è°ƒç”¨httpæ¥å£ã€‚é€šè¿‡urlçš„æ–¹å¼å¯ä»¥å®ç°å¿«é€Ÿè°ƒç”¨ï¼Œä¸éœ€è¦ä¾èµ–eurekaç­‰æœåŠ¡ï¼Œå¯ä»¥ç›´æ¥æ‰“åˆ°ç›®æ ‡æœºå™¨ï¼Œç‰¹åˆ«é€‚åˆç”¨åœ¨å¿«é€Ÿè¿­ä»£åœºæ™¯ï¼›è€Œè´Ÿè½½å‡è¡¡æ–¹å¼æ‰©å±•æ€§å¥½ï¼Œé€‚åˆçº¿ä¸Šç¯å¢ƒã€‚

é’ˆå¯¹@FeignClientç±»ç”Ÿæˆproxyä»£ç†ç±»çš„æ­¥éª¤ï¼Œæˆ‘ä»¬æ¯ä¸ªæ­¥éª¤éƒ½è¯¦ç»†é˜è¿°ï¼Œå¦‚ä¸‹

==== @FeignClientç±»ç”Ÿæˆproxyä»£ç†ç±»

===== è·å–FeignContextå¯¹è±¡
FeignClientFactoryBean.getTarget()æ–¹æ³•(1)å¤„æ‰€ç¤ºï¼ŒFeignContextå¯¹è±¡æ˜¯ä»beanFactoryä¸­è·å–çš„ã€‚åˆå¦‚ä¸‹ä»£ç ï¼šFeignContextæ˜¯ä»¥@Beanæ–¹æ³•çš„æ–¹å¼å£°æ˜çš„ã€‚
----
@Configuration
public class FeignAutoConfiguration {
	@Bean
	public FeignContext feignContext() {
		FeignContext context = new FeignContext();
		context.setConfigurations(this.configurations);
		return context;
	}
}
----
å…³äºFeignContextå¯¹è±¡çš„ç”Ÿæˆè¿‡ç¨‹ï¼Œå‚è§<springboot @Configurationç±»çš„åŠ è½½æºç å’Œæ‰©å±•ç‚¹è§£æ>ã€‚FeignContextå¯¹è±¡åŒ…å«äº†
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191106171742.png[20191106171742.png]
å›¾ä¸­configurationså±æ€§å­˜å‚¨äº†æ‰€æœ‰çš„@FeignClientçš„ç±»å³FeignClientSpecificationï¼Œç”¨äº

===== è·å–Feign.Builderå¯¹è±¡
FeignClientFactoryBean.getTarget()æ–¹æ³•(2)å¤„é€šè¿‡è°ƒç”¨feign()æ–¹æ³•è·å–Feign.Builderå¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹
----
protected Feign.Builder feign(FeignContext context) {
    FeignLoggerFactory loggerFactory = get(context, FeignLoggerFactory.class);
    Logger logger = loggerFactory.create(this.type);

    Feign.Builder builder = get(context, Feign.Builder.class)
            // required values
            .logger(logger)
            .encoder(get(context, Encoder.class))
            .decoder(get(context, Decoder.class))
            .contract(get(context, Contract.class));

    configureFeign(context, builder);

    return builder;
}

protected void configureFeign(FeignContext context, Feign.Builder builder) {
    FeignClientProperties properties = this.applicationContext
            .getBean(FeignClientProperties.class);
    if (properties != null) {
        if (properties.isDefaultToProperties()) {
            configureUsingConfiguration(context, builder);
            configureUsingProperties(
                    properties.getConfig().get(properties.getDefaultConfig()),
                    builder);
            configureUsingProperties(properties.getConfig().get(this.contextId),
                    builder);
        }
        else {
            configureUsingProperties(
                    properties.getConfig().get(properties.getDefaultConfig()),
                    builder);
            configureUsingProperties(properties.getConfig().get(this.contextId),
                    builder);
            configureUsingConfiguration(context, builder);
        }
    }
    else {
        configureUsingConfiguration(context, builder);
    }
}
----
å¦‚ä¸Šä»£ç ï¼Œé€šè¿‡ç»™Feign.Builderå¯¹è±¡çš„å„å±æ€§èµ‹å€¼ä»è€Œæ„å»ºå¯¹è±¡ï¼Œè¿™äº›å±æ€§åŒ…æ‹¬requestInterceptorsã€logLevelã€contractã€clientã€encoderã€decoderã€queryMapEncoderã€optionsç­‰ï¼ŒFeign.Builderå¯¹è±¡è´Ÿè´£ç”Ÿæˆ@FeignClientç±»çš„proxyä»£ç†ç±»ï¼Œæ‰€ä»¥è¿™äº›å±æ€§åœ¨ç”Ÿæˆproxyä»£ç†æ—¶éƒ½ä¼šç”¨åˆ°ã€‚configureFeign()æ–¹æ³•è¯´æ˜ä¸€ä¸ªé€»è¾‘ï¼šæœ‰ä¸¤ç§æ–¹å¼é…ç½®@FeignClientçš„å±æ€§å€¼ï¼Œ1æ˜¯properties.ymlæ–‡ä»¶é…ç½®ï¼ŒäºŒæ˜¯ä½¿ç”¨@Configurationç»“åˆ@Beançš„æ–¹å¼ã€‚å¹¶ä¸”é»˜è®¤å‰è€…æ–¹å¼è¦†ç›–åè€…æ–¹å¼ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡é…ç½®feign.client.defaultToPropertieså±æ€§å€¼å®ç°å€’è½¬è¦†ç›–

===== è·å–Targeterå¯¹è±¡
----
@Configuration
@ConditionalOnClass(name = "feign.hystrix.HystrixFeign")
protected static class HystrixFeignTargeterConfiguration {
    @Bean
    @ConditionalOnMissingBean
    public Targeter feignTargeter() {
        return new HystrixTargeter();
    }
}
----
Targeterå¯¹è±¡çš„ç”ŸæˆåŒFeignContextå¯¹è±¡çš„ç”Ÿæˆè¿‡ç¨‹ï¼Œå‚è§<springboot @Configurationç±»çš„åŠ è½½æºç å’Œæ‰©å±•ç‚¹è§£æ>ã€‚è¿™ä¸ªå¯¹è±¡çš„ä½œç”¨æ˜¯åˆ¤æ–­æ˜¯å¦é…ç½®Hystrixç†”æ–­fallbackã€‚
===== è°ƒç”¨Targeter.targeter()ç”Ÿæˆproxyä»£ç†ç±»
FeignClientFactoryBean.getTarget()æ–¹æ³•(4)å¤„ç”Ÿæˆproxyä»£ç†ç±»ã€‚ä»£ç å¦‚ä¸‹
----
HystrixTargeter class
public <T> T target(FeignClientFactoryBean factory, Feign.Builder feign,
        FeignContext context, Target.HardCodedTarget<T> target) {
    if (!(feign instanceof feign.hystrix.HystrixFeign.Builder)) {
        return feign.target(target);
    }
}

Feign.Builder class
public <T> T target(Target<T> target) {
    return build().newInstance(target);
}
    
public Feign build() {
    SynchronousMethodHandler.Factory synchronousMethodHandlerFactory =
        new SynchronousMethodHandler.Factory(client, retryer, requestInterceptors, logger,
            logLevel, decode404, closeAfterDecode, propagationPolicy);
    ParseHandlersByName handlersByName =
        new ParseHandlersByName(contract, options, encoder, decoder, queryMapEncoder,
            errorDecoder, synchronousMethodHandlerFactory);
    return new ReflectiveFeign(handlersByName, invocationHandlerFactory, queryMapEncoder);
}

ReflectiveFeign class
public <T> T newInstance(Target<T> target) {
    Map<String, MethodHandler> nameToHandler = targetToHandlersByName.apply(target);
    Map<Method, MethodHandler> methodToHandler = new LinkedHashMap<Method, MethodHandler>();
    List<DefaultMethodHandler> defaultMethodHandlers = new LinkedList<DefaultMethodHandler>();

    for (Method method : target.type().getMethods()) {
      if (method.getDeclaringClass() == Object.class) {
        continue;
      } else if (Util.isDefault(method)) {
        DefaultMethodHandler handler = new DefaultMethodHandler(method);
        defaultMethodHandlers.add(handler);
        methodToHandler.put(method, handler);
      } else {
        methodToHandler.put(method, nameToHandler.get(Feign.configKey(target.type(), method)));
      }
    }
    InvocationHandler handler = factory.create(target, methodToHandler);
    T proxy = (T) Proxy.newProxyInstance(target.type().getClassLoader(),
        new Class<?>[] {target.type()}, handler);

    for (DefaultMethodHandler defaultMethodHandler : defaultMethodHandlers) {
      defaultMethodHandler.bindTo(proxy);
    }
    return proxy;
}
----
åˆ°è¿™é‡Œï¼Œç»ˆäºçœ‹åˆ°proxyçš„ç”Ÿæˆäº†ã€‚ReflectiveFeignç›´æ¥è´Ÿè´£proxyä»£ç†ç±»çš„ç”Ÿæˆã€‚ä»newInstance()å¯ä»¥çœ‹å‡ºï¼Œä»£ç†ç”Ÿæˆä½¿ç”¨çš„æ˜¯jdkåŠ¨æ€ä»£ç†ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸¤ä¸ªç±»ç‰¹åˆ«é‡è¦: FeignInvocationHandlerå’ŒSynchronousMethodHandlerã€‚SynchronousMethodHandleræ˜¯MethodHandlerçš„å­ç±»ï¼Œä»åå­—å¯ä»¥çœ‹å‡ºä½œç”¨ï¼Œæ–¹æ³•methodå¯¹åº”çš„å¤„ç†å™¨handlerï¼Œå¥¹å­˜å‚¨çš„æ˜¯æ ‡è¯†äº†@FeignClientçš„ç±»ä¸­å¯¹æ¯ä¸ªæ–¹æ³•è§£æç»“æœçš„å­˜å‚¨ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191107074325.png[20191107074325.png]

FeignInvocationHandleræ˜¯jdk InvocationHandlerçš„å­ç±»ï¼Œå³é€šè¿‡å®ƒè°ƒç”¨proxyä»£ç†ç±»ï¼›FeignInvocationHandlerç±»çš„åˆ›å»ºé‡‡ç”¨å·¥å‚æ–¹æ³•çš„å½¢å¼ï¼Œå€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚ç”Ÿæˆä»£ç†ç±»æ—¶ï¼ŒFeignInvocationHandleråŒ…è£¹ç€SynchronousMethodHandleré›†åˆä¼ å…¥åˆ°ä»£ç†ç±»ä¸­ã€‚ç”Ÿæˆçš„proxyä»£ç†ç±»å¦‚å›¾æ‰€ç¤ºã€‚
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191107080016.png[20191107080016.png]

BeanPostProcessors()) {
			Object current = processor.postProcessAfterInitialization

----
AutowiredAnnotitionBeanPostProcessor class
protected void inject(Object bean, @Nullable String beanName, @Nullable PropertyValues pvs) {
    // èµ‹æƒé™filedå¯è§æ€§ï¼Œé˜²æ­¢filedæ˜¯privateæ—¶å¯¼è‡´èµ‹å€¼æŠ¥é”™
    ReflectionUtils.makeAccessible(field);
    // åå°„ç»™å±æ€§èµ‹å€¼
    field.set(bean, value);
}

		
----
å„å±æ€§å€¼å¦‚ä¸‹å›¾æ‰€ç¤º
filed:
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191107081652.png[20191107081652.png]
bean:
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191107081722.png[20191107081722.png]
value:
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191107081510.png[20191107081510.png]
ä»è€Œæ­¤æ—¶BrandController.brandFeignClientå±æ€§èµ‹å€¼å®Œæˆã€‚å³BrandController.brandFeignClient=$Proxy105ï¼Œä»è€Œå½“æœ‰httpè¯·æ±‚è¿›å…¥Controlleræ–¹æ³•æ—¶ï¼Œå³è°ƒç”¨brandFeignClientçš„æ–¹æ³•ï¼Œä»è€Œè¿›å…¥ä»£ç†ç±»é€»è¾‘ä¸­ã€‚


== è¯·æ±‚å¤„ç†åˆ†æ
Feignç»„ä»¶å·²ç»å®ä¾‹åŒ–å®Œæˆï¼ŒåŒæ—¶BrandController.brandFeignClientå·²ç»è¢«èµ‹å€¼å®Œæˆã€‚ç°åœ¨å°±å¯ä»¥åº”ç”¨äº†ï¼Œå½“ä¸€ä¸ªhttpè¯·æ±‚è¿›æ¥æ—¶ï¼Œå®ƒçš„é€»è¾‘ä¹Ÿå°±å¼€å§‹äº†

å‘é€è¯·æ±‚ï¼š
----
curl -X GET 'http://127.0.0.1:6003/brand/query?id=1&code=2'
----
å¯¹åº”çš„å¤„ç†è¯·æ±‚æ–¹æ³•ï¼š
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191107084916.png[20191107085101.png]

å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶çš„brandFeignClientå€¼æ—¶$Proxy105ï¼Œå³å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ–¹æ³•ç›´æ¥è¿›å…¥äº†FeignInvocationHandler.invokeæ–¹æ³•(æ­¤å¤„å¦‚æœ‰ç–‘é—®ï¼Œè¯·çœ‹$proxy105çš„.classæ–‡ä»¶)ã€‚
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191107085102.png[20191107085102.png]

è¿™é‡Œæ˜¯æˆ‘ä»¬ç€é‡è¯´çš„åœ°æ–¹ï¼Œè¿™é‡Œçš„é€»è¾‘æ˜¯é€šç”¨çš„ï¼Œæ¯ä¸ªFeignçš„ä»£ç†ç±»éƒ½èµ°è¿™ä¸ªé€»è¾‘ã€‚
è¿˜è®°å¾—FeignInvocationHandlerè¿™ä¸ªç±»å§ï¼Œç”Ÿæˆproxyä»£ç†ç±»å°èŠ‚æˆ‘ä»¬é‡ç‚¹è¯´è¿‡ï¼Œé‚£ä¸ªæ—¶å€™å®ƒè¢«å®ä¾‹åŒ–ï¼Œç°åœ¨å¼€å§‹ä½¿ç”¨å®ä¾‹åŒ–æ—¶çš„å±æ€§å€¼ã€‚çœ‹ä»£ç 
----
FeignInvocationHandler class
public Object invoke(Object proxy, Method method, Object[] args) {
    return dispatch.get(method).invoke(args);
}
----
dispatch:Map<Method, MethodHandler>ç±»å‹ï¼Œvalueä¸ºSynchronousMethodHandler,SynchronousMethodHandlerå­˜å‚¨è¿™æ¯ä¸ªæ–¹æ³•çš„ä¿¡æ¯ã€‚dispatchå¦‚ä¸‹å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191107090336.png[20191107090336.png]

çœ‹ä»£ç 
----
SynchronousMethodHandler class
public Object invoke(Object[] argv) throws Throwable {
    // å°†BrandFeignClient.query()æ–¹æ³•è½¬åŒ–ä¸ºåŒ…å«httpè¯·æ±‚ä¿¡æ¯RequestTemplateå¯¹è±¡ï¼Œå¦‚ä¸‹å›¾
    RequestTemplate template = buildTemplateFromArgs.create(argv);
    Retryer retryer = this.retryer.clone();
    while (true) {
        try {
            return executeAndDecode(template);
        } catch (RetryableException e) {
           // é‡è¯•é€»è¾‘
        }
    }
}
----
æ–¹æ³•åˆ†ä¸¤æ­¥
ç¬¬ä¸€æ­¥ï¼š
å°†@FeignClientç±»çš„æ–¹æ³•è½¬åŒ–ä¸ºåŒ…å«httpè¯·æ±‚ä¿¡æ¯RequestTemplateå¯¹è±¡ï¼Œå¦‚å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191108073006.png[20191108073006.png]

ç¬¬äºŒæ­¥ï¼šç»„è£…å¹¶å‘é€requestè¯·æ±‚ï¼Œå¤„ç†responseå“åº”æ•°æ®
----
  Object executeAndDecode(RequestTemplate template) throws Throwable {
    // ç»„è£…æˆrequestè¯·æ±‚ï¼Œ
    Request request = targetRequest(template);

    if (logLevel != Logger.Level.NONE) {
      logger.logRequest(metadata.configKey(), logLevel, request);
    }

    Response response = client.execute(request, options);
}

----
æ–¹æ³•é¦–å…ˆä¼šç»„è£…æˆrequestè¯·æ±‚ï¼Œä¼šç»è¿‡RequestInterceptoræ‹¦æˆªå¤„ç†ï¼Œè¿™å°±ç»™äº†æˆ‘ä»¬æ‰©å±•çš„æœºä¼šã€‚è¿™é‡Œæˆ‘ä»¬å®é™…å¼€å‘ä¸­å¯ä»¥ç»§æ‰¿RequestInterceptorå®ç°æˆ‘ä»¬çš„é€»è¾‘ï¼Œå¦‚å¤„ç†Getæ–¹å¼çš„request bodyæ•°æ®ã€‚ç„¶åæ˜¯æ ¹æ®æ—¥å¿—çº§åˆ«è®°å½•æ—¥å¿—ï¼Œè¿™é‡Œç»™æˆ‘çš„å¯ç¤ºä¸ºï¼Œæˆ‘ä»¬å¹³æ—¶å¼€å‘ä¸­è®°å½•æ—¥å¿—å¯ä»¥å‘è¿™æ ·å°è£…å¤„ç†ã€‚

æœ€åæ˜¯ä½¿ç”¨LoadBalanceFeignClient(è¿™æ˜¯feigné»˜è®¤ä½¿ç”¨çš„FeignClient)ï¼Œä»–ç»“åˆribbonå’Œeurekaå®ç°è´Ÿè½½å‡è¡¡ï¼Œæ ¹æ®ribbonçš„ç®—æ³•æ‰¾åˆ°ä¸€å°è¿œç¨‹æœåŠ¡ï¼Œæœ€åæ˜¯å‘é€è¯·æ±‚ï¼Œå¾—åˆ°å“åº”æ•°æ®ã€‚ribbonè´Ÿè½½å‡è¡¡è¯¦è§ç½‘ä¸Šæ–‡æ¡£

åˆ°è¿™é‡Œï¼Œæ•´ä¸ªfeignç»„ä»¶çš„åŠ è½½è§£æï¼Œä»¥åŠè¯·æ±‚å¤„ç†éƒ½å®Œäº‹äº†ï¼ŒèŠ±äº†3å¤©æ—¶é—´ï¼Œéš¾å…æœ‰ç–æ¼


=== æ ‡æ³¨äº†@FeignClientçš„ç±»å®ä¾‹åŒ–è¿‡ç¨‹æ€»ç»“
ä¸€ä¸ªjava .classæ–‡ä»¶åœ¨spring bootä¸­çš„è½¬åŒ–è¿‡ç¨‹
.class-->BeanDefinition-->beanInstance-->proxyä»£ç†ç±»

----
beanDefinitionåœ¨beanFactoryçš„å­˜å‚¨ä½ç½®ï¼š
DefaultListableBeanFactroy.beanDenifitionNames.add(beanName);
DefaultListableBeanFactroy.beanDenifitionMap.put(beanName, BeanDefinition);
beanName:com.ke.utopia.construction.api.ConstructionStoppageFeignService
BeanDefinition:GenericBeanDefinition(beanClass=class org.springframework.cloud.openfeign.FeignClientFactoryBean))


beanInstanceåœ¨beanFactoryçš„å­˜å‚¨ä½ç½®ï¼š
DefaultSingletonBeanRegistry.singletonObjects.put(beanName, beanInstance);
beanName:com.ke.utopia.construction.api.ConstructionStoppageFeignService
beanInstance:FeignClientFactoryBean(type=interface com.ke.utopia.construction.api.ConstructionStoppageFeignService)

proxyä»£ç†ç±»åœ¨beanFactoryçš„å­˜å‚¨ä½ç½®ï¼š
ä¸ä¼šæ”¾å…¥beanFactoryï¼Œè€Œæ˜¯ç›´æ¥èµ‹å€¼ç»™å¼•ç”¨å®ƒçš„å±æ€§
----

å…³äºfeignçš„ä½¿ç”¨å‚è§
https://segmentfault.com/a/1190000020656405
https://juejin.im/post/5c6fb8b7518825629b42f572


éšæ—¶å°é—®
1. feignæ˜¯å¦‚ä½•æ”¯æŒå›¾ç‰‡ç­‰æµæ•°æ®çš„
2. feignçš„encoderå’ŒdecoderåŸç†
3. feignçš„constractä½œç”¨
4. feignæ–¹æ³•å…¥å‚ä¸ºä»€ä¹ˆå¿…é¡»åŠ ä¸Šæ³¨è§£
5. feign GETè¯·æ±‚å…¥å‚ä¸æ”¯æŒå¯¹è±¡æ–¹å¼æ¥æ”¶

