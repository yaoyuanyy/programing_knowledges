= springboot HandlerIntercepteræ‹¦æˆªå™¨å®ç°ä¿®æ”¹request bodyæ•°æ®
:toc: left
:toc-title: ç›®å½•
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: â—
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
// :tip-caption: :bulb:
// :note-caption: :information_source:
// :important-caption: :heavy_exclamation_mark:	
// :caution-caption: :fire:
// :warning-caption: :warning:
:icons: font

Doc writer yaoyihao1@gmail.com

> å®é™…å·¥ä½œä¸­å­¦ä¹ æŠ€æœ¯æ˜¯æœ€å¿«ã€æœ€æ·±åˆ»çš„ã€‚å½“ç„¶ï¼Œè‡ªèº«çš„æŒç»­å­¦ä¹ æ„è¯†æ˜¯å¿…é¡»çš„

== æŠ€æœ¯æ ˆç‰ˆæœ¬ï¼š
- spring boot 2.0.2

== é‡åˆ°äº‹å„¿äº†
è¿‘æ¥åšä¸šåŠ¡éœ€æ±‚ï¼Œå‰ç«¯åŒå­¦feå°†`userId`å’Œ`userName`æ”¾åˆ°`request header`ä¸­äº†ã€‚åç«¯apiæ¥å£è¦æƒ³ä½¿ç”¨`userId`å’Œ`userName`ï¼Œæ¯ä¸ªæ¥å£éƒ½è¦ä»`header`ä¸­è·å–ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä½ æœ‰åä¸ªæ¥å£ï¼Œé‚£ä¹ˆæ¯ä¸ªæ¥å£éƒ½è¦å†™ä¸€é`Object.setUserId(request.getHeader("userId"))`ã€‚æ­£å¦‚ä¸‹é¢ä»£ç æ®µ
----
@RestController
@Validated
@RequestMapping("/template")
public class TemplateController {

    // ä¸€ä¸ªfeign client
    @Autowired 
    TemplateClient templateClient

    @PostMapping(value = "/create", produces = MediaType.APPLICATION_JSON_VALUE)
    public ResultVO create(@RequestBody @Valid TemplateParam param, HttpServletRequest request) {
        // æ¯ä¸ªæ¥å£éƒ½è¦å†™ä¸€ésetXXX()æ–¹æ³•
        param.setUserId(request.getHeader("userId"));
        param.setUserName(request.getHeader("userName"));

        return templateClient.createTemplate(param).toResultVO();
    }
}   
@Data
public class TemplateParam{
    private Long templateId; 
    private Long userId;
    private String userName;
}
----

== è§£å†³åŠæ³•
å¤§å®¶éƒ½çŸ¥é“çš„ä¸¤å¤§åˆ©å™¨ï¼Œ
> tomcatçš„Filterå’Œspringçš„Intercepter(å…·ä½“ä¸ºHandlerIntercepter)

== å®ç°åŸç†

å…·ä½“æ–¹æ³•ä¸ºå®šä¹‰ä¸€ä¸ªFilterå®ç°ç±»å’Œä¸€ä¸ªHandlerIntercepterçš„å®ç°ç±»ã€‚å†å®šä¹‰ä¸€ä¸ªHttpServletRequestå®ç°ç±»ï¼Œå…¶ä½œç”¨åˆ†åˆ«ä¸º

=== Filterå®ç°ç±»ï¼šUserInfoFilter

åˆ›å»ºä¸€ä¸ªå…¥å£ï¼Œåœ¨è¿™ä¸ªå…¥å£ä¸­å®šä¹‰ä¸€ä¸ªæœºä¼šï¼šå°†æˆ‘ä»¬è‡ªå®šä¹‰çš„CustomHttpServletRequestWrapperä»£æ›¿HttpServletRequestéšç€è¯·æ±‚ä¼ é€’ä¸‹å»

=== HttpServletRequestå®ç°ç±»ï¼šcustomHttpServletRequestWrapper

å› ä¸ºHttpServletRequestå¯¹è±¡çš„bodyæ•°æ®åªèƒ½getï¼Œä¸èƒ½setï¼Œå³ä¸èƒ½å†æ¬¡èµ‹å€¼ã€‚è€Œæˆ‘ä»¬çš„éœ€æ±‚æ˜¯éœ€è¦ç»™HttpServletRequestèµ‹å€¼ï¼Œæ‰€ä»¥éœ€è¦å®šä¹‰ä¸€ä¸ªHttpServletRequestå®ç°ç±»ï¼šcustomHttpServletRequestWrapperï¼Œè¿™ä¸ªå®ç°ç±»å¯ä»¥è¢«èµ‹å€¼æ¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚

=== HandlerIntercepterçš„å®ç°ç±»ï¼šCustomInterceptor

æ‹¦æˆªè¯·æ±‚ï¼Œè·å–æ¥å£æ–¹æ³•ç›¸å…³ä¿¡æ¯(æ–¹æ³•åï¼Œå‚æ•°ï¼Œè¿”å›å€¼ç­‰)ã€‚ä»è€Œå®ç°ç»Ÿä¸€çš„ç»™request bodyåŠ¨æ€èµ‹å€¼

å®ç°æ€è·¯å¦‚ä¸Šæ‰€è¿°ï¼Œå…·ä½“çš„å®ç°ä»£ç å¦‚ä¸‹

=== ä»£ç å®ç°

==== å£°æ˜åŸºç¡€bean: UserInfoParam
UserInfoParamï¼šå®šä¹‰äº†åŒ…å«userId,userNameçš„å®ä½“bean,è¦æƒ³å°†ç”¨æˆ·ä¿¡æ¯æ³¨å…¥è¿›å…¥ï¼Œéœ€è¦å…¥å‚å¯¹è±¡XXXParamç»§æ‰¿UserInfoParamï¼Œæ‹¦æˆªå™¨ä¸­åªå¤„ç†@Requestbodyä¸­å®ç°äº†UserInfoParamç±»çš„beanã€‚å¦‚ä¸Šæ–‡controllerä¸­createæ–¹æ³•çš„å…¥å‚ï¼šTemplateParamï¼Œç»§æ‰¿UserInfoParam
----
@Data
public class TemplateParam extends UserInfoParam{
    private Long templateId; 
    // private Long userId;
    // private String userName;
}
----

@Data
public class UserInfoParam {

    // ç”¨æˆ·id
    private Long userId;

    // ç”¨æˆ·åç§°
    private String userName;
}

==== å®šä¹‰Filterå®ç°ç±»: UserInfoFilter

----
@Slf4j
public class UserInfoFilter implements Filter {

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
        CustomHttpServletRequestWrapper customHttpServletRequestWrapper = null;
        try {
            HttpServletRequest req = (HttpServletRequest)request;
            customHttpServletRequestWrapper = new CustomHttpServletRequestWrapper(req);
        }catch (Exception e){
            log.warn("customHttpServletRequestWrapper Error:", e);
        }

        chain.doFilter((Objects.isNull(customHttpServletRequestWrapper) ? request : customHttpServletRequestWrapper), response);
    }
}
----

==== HttpServletRequestå®ç°ç±»ï¼šCustomHttpServletRequestWrapper

----
public class CustomHttpServletRequestWrapper extends HttpServletRequestWrapper {

    // ä¿å­˜request bodyçš„æ•°æ®
    private String body;

    // è§£ærequestçš„inputStream(å³body)æ•°æ®ï¼Œè½¬æˆå­—ç¬¦ä¸²
    public CustomHttpServletRequestWrapper(HttpServletRequest request) {
        super(request);
        StringBuilder stringBuilder = new StringBuilder();
        BufferedReader bufferedReader = null;
        InputStream inputStream = null;
        try {
            inputStream = request.getInputStream();
            if (inputStream != null) {
                bufferedReader = new BufferedReader(new InputStreamReader(inputStream));
                char[] charBuffer = new char[128];
                int bytesRead = -1;
                while ((bytesRead = bufferedReader.read(charBuffer)) > 0) {
                    stringBuilder.append(charBuffer, 0, bytesRead);
                }
            } else {
                stringBuilder.append("");
            }
        } catch (IOException ex) {

        } finally {
            if (inputStream != null) {
                try {
                    inputStream.close();
                }
                catch (IOException e) {
                    e.printStackTrace();
                }
            }
            if (bufferedReader != null) {
                try {
                    bufferedReader.close();
                }
                catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
        body = stringBuilder.toString();
    }

    @Override
    public ServletInputStream getInputStream() throws IOException {
        final ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(body.getBytes());
        ServletInputStream servletInputStream = new ServletInputStream() {
            @Override
            public boolean isFinished() {
                return false;
            }
            @Override
            public boolean isReady() {
                return false;
            }
            @Override
            public void setReadListener(ReadListener readListener) {
            }
            @Override
            public int read() throws IOException {
                return byteArrayInputStream.read();
            }
        };
        return servletInputStream;

    }

    @Override
    public BufferedReader getReader() throws IOException {
        return new BufferedReader(new InputStreamReader(this.getInputStream()));
    }

    public String getBody() {
        return this.body;
    }

    // èµ‹å€¼ç»™bodyå­—æ®µ
    public void setBody(String body) {
        this.body = body;
    }

}
----

==== HandlerIntercepterçš„å®ç°ç±»ï¼šCustomInterceptor
----
@Slf4j
public class CustomInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler)
        throws Exception {
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }
        HandlerMethod handlerMethod = (HandlerMethod)handler;
        pushUserInfo2Body(request, handlerMethod);

        return true;
    }

    private void pushUserInfo2Body(HttpServletRequest request, HandlerMethod handlerMethod) {
        try{
            String userId = request.getHeader("userId");
            String userName = request.getHeader("userName");

            MethodParameter[] methodParameters = handlerMethod.getMethodParameters();
            if(ArrayUtils.isEmpty(methodParameters)) {
                return;
            }
            for (MethodParameter methodParameter : methodParameters) {
                Class clazz = methodParameter.getParameterType();
                if(ClassUtils.isAssignable(UserInfoParam.class, clazz)){
                    if(request instanceof CustomHttpServletRequestWrapper){
                        CustomHttpServletRequestWrapper requestWrapper = (CustomHttpServletRequestWrapper)request;
                        String body = requestWrapper.getBody();
                        JSONObject param = JSONObject.parseObject(body);
                        param.put("userId", userId);
                        param.put("userName", Objects.isNull(userName) ? null : URLDecoder.decode(userName, "UTF-8"));
                        requestWrapper.setBody(JSON.toJSONString(param));
                    }
                }
            }
        }catch (Exception e){
            log.warn("fill userInfo to request body Error ", e);
        }
    }
----

==== å®šä¹‰Configuration classï¼Œå¢åŠ æ‹¦æˆªå™¨å’Œè¿‡æ»¤å™¨çš„é…ç½®

WebMvcConfigurerå­ç±»ï¼šCustomWebMvcConfigurer
----
@Configuration
public class CustomWebMvcConfigurer implements WebMvcConfigurer {

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        CustomInterceptor customInterceptor= new CustomInterceptor();
        registry.addInterceptor(customInterceptor);
    }

    @Bean
    public FilterRegistrationBean servletRegistrationBean() {
        UserInfoFilter userInfoFilter = new UserInfoFilter();
        FilterRegistrationBean<UserInfoFilter> bean = new FilterRegistrationBean<>();
        bean.setFilter(userInfoFilter);
        bean.setName("userInfoFilter");
        bean.addUrlPatterns("/*");
        bean.setOrder(Ordered.LOWEST_PRECEDENCE);

        return bean;
    }
}
----
åˆ°æ­¤ï¼Œå®ç°åŠŸèƒ½çš„ä»£ç æ’¸å®Œäº†ã€‚å¯åŠ¨spring boot Appï¼Œå°±å¯ä»¥curlè®¿é—®restfulæ¥å£äº†

== httpè®¿é—®
----
curl -X POST \
  http://localhost:8080/template/create
  -H 'Content-Type: application/json'
  -H 'username: tiankongå¤©ç©º'
  -H 'userId: 11'
  -d '{
  "templateId": 1000}
----

== æ•ˆæœ
å¯ä»¥çœ‹åˆ°TemplateController.create(...)æ‰“å‡ºçš„ä¿¡æ¯ï¼ŒuserIdå’Œusernameçš„å€¼æ­£æ˜¯headerä¸­ä¼ çš„å€¼



== toDo

å‰©ä¸‹çš„å°±çœ‹ä½ çš„äº†