
:toc: left
:toc-title: ç›®å½•
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: â—
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
// :tip-caption: :bulb:
// :note-caption: :information_source:
// :important-caption: :heavy_exclamation_mark:	
// :caution-caption: :fire:
// :warning-caption: :warning:
:icons: font

Doc writer yaoyihao1@gmail.com

== æ¦‚è¿°
ä»beançš„ç±»å‹ä¸Šçœ‹ï¼Œspringå°†beanåˆ†æˆäº†normal beanå’Œ FactoryBeanä¸¤ç§ï¼›ä»beançš„å£°æ˜æ–¹å¼æ¥çœ‹ä¹Ÿæœ‰ä¸¤ç§ï¼š@Componentå’Œ@Beanã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™å‡ ç§beançš„å®ä¾‹åŒ–æ–¹å¼çš„ç›¸åŒç‚¹å’Œä¸åŒç‚¹ã€‚è¿™é‡Œæˆ‘ä»¬ç§°normal beanå’Œ@Componentä¸ºæ­£ç»çš„beanï¼Œå› ä¸ºä»–ä»¬çš„å®ä¾‹åŒ–æ–¹å¼æ˜¯å¤§ä¼—çš„ï¼Œè€ŒFactoryBeanå’Œ@Beanæ˜¯ä¸æ­£ç»çš„ï¼Œå› ä¸ºä»–ä»¬çš„å®ä¾‹åŒ–æ–¹å¼æœ‰é‚£ä¹ˆä¸€ç‚¹å°ä¼—ã€‚æ­£ç»å’Œä¸æ­£ç»æˆ‘è®¤ä¸ºæ²¡æœ‰å¥½åä¹‹åˆ†ï¼Œå°±åƒäººä¸€æ ·ï¼Œä½ å–œæ¬¢çš„æ‰æ˜¯å¥½çš„ã€‚

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191212091057.png[20191212091057.png]

== ä½ çš„æ”¶è·
é€šè¿‡æœ¬æ–‡ï¼Œä½ èƒ½æ”¶è·ä»€ä¹ˆï¼Ÿ

1. normal beanå’Œ@Componentç”ŸæˆbeanDefinitionçš„å…¥å£
2. normal beanå’Œ@Componentçš„beanDefinitionå¦‚ä½•ç”Ÿæˆbean instanceå¹¶æ”¾å…¥springå®¹å™¨çš„
3. @Beanç”ŸæˆbeanDefinitionçš„å…¥å£
4. @Beançš„beanDefinitionå¦‚ä½•ç”Ÿæˆbean instanceå¹¶æ”¾å…¥springå®¹å™¨çš„,è¿™é‡Œçš„instanceå¯èƒ½æ˜¯proxyä»£ç†ç±»
5. FactoryBeanç”ŸæˆbeanDefinitionçš„å…¥å£
6. FactoryBeançš„beanDefinitionå¦‚ä½•ç”Ÿæˆbean instanceå¹¶æ”¾å…¥springå®¹å™¨çš„,è¿™é‡Œçš„instanceå¯èƒ½æ˜¯proxyä»£ç†ç±»
7. è¿™äº›ä¸åŒç±»å‹çš„beanç”Ÿæˆbean instanceè¿‡ç¨‹çš„è”ç³»å’ŒåŒºåˆ«

> æœ¬æ–‡åŠ›æ±‚ä¸“æ³¨å’Œç²¾ç®€ï¼Œå¸Œæœ›ä½ æœ‰æ‰€æ”¶è·å’Œæƒ³æ³•

== ç¤ºä¾‹
å¦‚ä¸‹ï¼Œæˆ‘ä»¬åˆ—ä¸¾äº†å®é™…å·¥ä½œä¸­å¸¸ç”¨çš„ç±»ï¼Œä¸åŒç±»å‹çš„beanéƒ½æ‹¿å‡ºæ¥ä¸€ä¸ªï¼Œä¾¿äºæˆ‘ä»¬å¯¹é½æ€è·¯
----
import com.skyler.project
// normal bean
@Service
public class UserServiceImpl implements IUserService {
	@Override
	public int insert(User user) {}
}

// @Beanæ–¹å¼å£°æ˜çš„ç±»
@Configuration
public class MapperAutoConfiguration {
    @Bean
    public SqlSessionFactory sqlSessionFactory(DataSource dataSource)
    }
}
----

å…ˆä¸Šå›¾ï¼Œæœ‰å›¾å¥½è¯´è¯
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191214073018.png[20191214073018.png]

å›¾å±•ç¤ºäº†ä¸åŒç±»å‹çš„ç±»çš„.classæ–‡ä»¶ç”ŸæˆbeanDefinitionçš„å…¥å£ï¼Œä»¥åŠé€šç”¨çš„beanDefinitionç”Ÿæˆbean instanceæˆ–proxyä»£ç†ç±»çš„å¤§æ¡†è¿‡ç¨‹å’Œå…¥å£

== normal beanå’Œ@Componentç±»å‹çš„bean
=== å…¥å£
å¦‚ä¸Šå›¾
=== å…·ä½“çš„BeanDefinition
normal beanå’Œ@Componentç±»å‹çš„beanç”Ÿæˆçš„BeanDefinitionä¸ºRootBeanDefinitionã€‚æ­¤æ—¶çš„å…³é”®å±æ€§æœ‰
----
resolvedTargetType=com.skyler.project.UserServiceImpl
resolvedConstructorOrFactoryMethod=com.skyler.project.UserServiceImpl
beanClass=com.skyler.project.UserServiceImpl
autowireMode=0
attributes
extenallyManagedConfigMembers=å­˜çš„æ˜¯beançš„æˆå‘˜å±æ€§
----
è¯¦ç»†å‚è§æ–‡ç« ç»“å°¾è´´å‡ºäº†@Componentå£°æ˜çš„beanã€@Beanå£°æ˜çš„beanã€FactoryBeanç±»å‹çš„beanä¸‰è€…BeanDefinitionçš„å¯¹è±¡å±æ€§å¯¹æ¯”å›¾

=== beanDefinitionå¦‚ä½•ç”Ÿæˆbean instance

beanDefinitionå¦‚ä½•ç”Ÿæˆbean instanceçš„è½¨è¿¹
----
UserServiceImpl:
AbstractBeanFactory.getBean
AbstractBeanFactory.doGetBean
DefaultSingletonBeanRegistry.getSingleton
AbstractAutowireCapableBeanFactory.createBean
AbstractAutowireCapableBeanFactory.doCreateBean
--this.createBeanInstance
----resolveBeanClass
----instantiateBean
AbstractAutowireCapableBeanFactory.populateBean
--AutowiredAnnotationBeanPostProcessor.postProcessProperties for BeanPostProcessor.postProcessProperties
----InjectionMetadata.inject
AbstractAutowireCapableBeanFactory.initializeBean //ä½¿ç”¨AbstractAdvisorç”Ÿæˆproxyä»£ç†ç±»
----


== @Beanç±»å‹çš„bean
=== å…¥å£
å¦‚ä¸Šå›¾
=== å…·ä½“çš„BeanDefinition
æ­¤æ—¶çš„BeanDefinitionç±»å‹ä¸ºConfigurationClassBeanDefinitionã€‚ä»¥`@Bean SqlSessionFactory`ä¸ºä¾‹ï¼Œæ­¤æ—¶æ¯”è¾ƒå…³é”®çš„å±æ€§æœ‰
----
factoryMethodMetadata
autowireMode=3
factoryBeanName=tk.mybatis.mapper.autoconfigure.MapperAutoConfiguration
factoryMethodName=sqlSessionFactory
factoryMethodReturnType
----
è¯¦ç»†å‚è§æ–‡ç« ç»“å°¾è´´å‡ºäº†@Componentå£°æ˜çš„beanã€@Beanå£°æ˜çš„beanã€FactoryBeanç±»å‹çš„beanä¸‰è€…BeanDefinitionçš„å¯¹è±¡å±æ€§å¯¹æ¯”å›¾

=== beanDefinitionå¦‚ä½•ç”Ÿæˆbean instance
beanDefinitionå¦‚ä½•ç”Ÿæˆbean instanceçš„è½¨è¿¹
----
AbstractBeanFactory.getBean
AbstractBeanFactory.doGetBean
DefaultSingletonBeanRegistry.getSingleton
AbstractAutowireCapableBeanFactory.createBean
AbstractAutowireCapableBeanFactory.doCreateBean
--this.createBeanInstance
----this.instantiateUsingFactoryMethod
------ConstructorResolver.instantiateUsingFactoryMethod
--------ConfigurationClassEnhancer$BeanMethdoInterceptor
----
ä»debugè¿è¡Œè½¨è¿¹å¯ä»¥æ›´æ¸…æ™°çš„è§‚å¯Ÿ
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191214144005.png[20191214144005.png]

== @Configurationç±»å‹çš„bean
=== å…¥å£
å¦‚ä¸Šå›¾
=== å…·ä½“çš„BeanDefinition
æ­¤æ—¶çš„BeanDefinitionç±»å‹ä¸ºConfigurationClassBeanDefinitionã€‚@Configurationç±»å‹çš„beanç”ŸæˆBeanDefinitionçš„è¿‡ç¨‹æ¯”è¾ƒç‰¹æ®Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191214143554.png[20191214143554.png]

=== beanDefinitionå¦‚ä½•ç”Ÿæˆbean instance
----
AbstractBeanFactory.getBean
AbstractBeanFactory.doGetBean
DefaultSingletonBeanRegistry.getSingleton
AbstractAutowireCapableBeanFactory.createBean
AbstractAutowireCapableBeanFactory.doCreateBean
--AbstractAutowireCapableBeanFactory.autowireConstructor å¦‚æœæœ‰æ„é€ å‡½æ•° 
----
ä»debugè¿è¡Œè½¨è¿¹å¯ä»¥æ›´æ¸…æ™°çš„è§‚å¯Ÿã€‚è¿™æ ·æˆ‘ä»¬ä»¥MapperAutoConfigurationä¸ºä¾‹
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191214144157.png[20191214144157.png]


== FactoryBeanç±»å‹çš„bean
=== å…¥å£
ä¸Šå›¾æ²¡æœ‰å±•ç¤ºFactoryBeançš„.classæ–‡ä»¶ç”ŸæˆbeanDefinitionçš„å…¥å£ã€‚å› ä¸ºFactoryBeanæ˜¯ä¸ªç‰¹æ®Šçš„beanã€‚çœ‹ä¸‹å®ƒçš„ç”¨æ³•å’Œé€‚ç”¨åœºæ™¯ã€‚
FactoryBeané¦–å…ˆæ˜¯ä¸€ä¸ªbeanï¼Œå…¶æ¬¡ï¼Œå®ƒæ˜¯ä¸€ä¸ªfactory beanï¼šå·¥å‚beanï¼Œå¹²ä»€ä¹ˆçš„ï¼Ÿç”Ÿäº§beançš„å•Šã€‚æ€ä¹ˆç”Ÿäº§ï¼Ÿé€šè¿‡FactoryBean.getObject()æ–¹æ³•ç”Ÿäº§ï¼Œè¿™ä¹ˆç”Ÿäº§æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿæˆ–è€…è¯´FactoryBeançš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ

FactoryBeanç”Ÿäº§çš„äº§å“ï¼Œä¸æ˜¯FactoryBeanæœ¬èº«ã€‚å³FactoryBeanè¿”å›çš„å¯¹è±¡ä¸æ˜¯æŒ‡å®šç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œå…¶è¿”å›çš„æ˜¯è¯¥FactoryBeançš„getObjectæ–¹æ³•æ‰€è¿”å›çš„å¯¹è±¡ã€‚FactoryBeançš„ç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒå¯ä»¥å‘å®¹å™¨ä¸­æ³¨å†Œä¸¤ä¸ªBeanï¼Œä¸€ä¸ªæ˜¯å®ƒæœ¬èº«ï¼Œä¸€ä¸ªæ˜¯FactoryBean.getObject()æ–¹æ³•è¿”å›å€¼æ‰€ä»£è¡¨çš„Beanã€‚åœ¨Springæ¡†æ¶å†…éƒ¨ï¼Œæœ‰å¾ˆå¤šåœ°æ–¹æœ‰FactoryBeançš„å®ç°ç±»ï¼Œå®ƒä»¬åœ¨å¾ˆå¤šåº”ç”¨å¦‚(Springçš„AOPã€ORMã€äº‹åŠ¡ç®¡ç†)

æ‰€ä»¥ï¼ŒFactoryBeanæ¥å£æ˜¯Spring IoCå®¹å™¨å®ä¾‹åŒ–é€»è¾‘çš„æ‰©å±•ç‚¹ã€‚å‡å¦‚åˆå§‹åŒ–ä»£ç éå¸¸å¤æ‚ï¼Œè¿™ç§åœºæ™¯ä¸­ï¼Œå°±å¯ä»¥è‡ªå®šä¹‰FactoryBean,åœ¨ç±»ä¸­æ’°å†™å¤æ‚çš„åˆå§‹åŒ–ç¨‹åºï¼Œå¹¶å°†å…¶ä½œä¸ºæ’ä»¶åŠ å…¥åˆ°å®¹å™¨ä¸­ã€‚spring cloud openFeignå’Œmybatis Mapperéƒ½åº”ç”¨äº†è¿™ä¸ªæŠ€æœ¯ï¼Œä¸Šå®é™…å·¥ä½œçš„ä»£ç 
----
//spring cloud openFeign å£°æ˜ä¸€ä¸ªFeignClient
@FeignClient(value = "${provider.application:skyler-base}", contextId = "SkylerComboFeignService")
public interface SkylerComboFeignService {

    @PostMapping(value = "api/skyler/combo/create", produces = MediaType.APPLICATION_JSON_VALUE)
    ResultDTO create(@RequestBody ComboParam param);

    @GetMapping(value = "api/skyler/combo/list")
    ResultDTO<Page<ComboDTO>> listCombo(Long comboId, Integer currentPage,Integer pageSize);
}

// mybatiså£°æ˜ä¸€ä¸ªMapperï¼Œæ“ä½œæ•°æ®åº“ï¼Œè¿›è¡Œcurdæ“ä½œ
@Repository
public interface ComboMapper {
    int insert(Combo record);

    List<Combo> selectByExample(ComboExample example);
}
----
è¿™ä¸¤æ®µä»£ç ç›¸ä¿¡ä½ ä¸€å®šå¾ˆç†Ÿæ‚‰ï¼Œéƒ½æ˜¯å¼€å‘ä¸­å¸¸ç”¨çš„ã€‚åªè¦æˆ‘ä»¬è¿™æ ·å£°æ˜äº†/å®šä¹‰äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨feignå°±è¡Œè¿œç¨‹è°ƒç”¨äº†ï¼Œå°±å¯ä»¥è°ƒç”¨æ•°æ®åº“äº†ï¼Œè¿™ä¸€åˆ‡çš„èƒŒåéƒ½æ˜¯é€šè¿‡FactoryBeanå®ç°çš„ã€‚

æ‰€ä»¥ï¼ŒopenFeignçš„å…¥å£åœ¨FeignClientsRegistrarï¼›mybatis Mapperçš„å…¥å£åœ¨MapperScannerRegistrarã€‚

=== å…·ä½“çš„BeanDefinition
æ­¤æ—¶çš„BeanDefinitionç±»å‹ä¸ºRootBeanDefinitionã€‚ä»¥`@FeignClient`ä¸ºä¾‹ï¼Œæ­¤æ—¶æ¯”è¾ƒå…³é”®çš„å±æ€§æœ‰
----
propertyValues=MutablePropertyValues 
resolvedTargetType=org.springframework.cloud.openfeign.FeignClientFactoryBean
resolvedConstructorOrFactoryMethod=org.springframework.cloud.openfeign.FeignClientFactoryBean
beanClass=org.springframework.cloud.openfeign.FeignClientFactoryBean
autowireMode=2
----
è¯¦ç»†å‚è§æ–‡ç« ç»“å°¾è´´å‡ºäº†@Componentå£°æ˜çš„beanã€@Beanå£°æ˜çš„beanã€FactoryBeanç±»å‹çš„beanä¸‰è€…BeanDefinitionçš„å¯¹è±¡å±æ€§å¯¹æ¯”å›¾

=== beanDefinitionå¦‚ä½•ç”Ÿæˆbean instance
----
AbstractBeanFactory.getBean
AbstractBeanFactory.doGetBean
AbstractBeanFactory.getObjectForBeanInstance
FactoryBeanRegistrySupport.getObjectFromFactoryBean
FactoryBeanRegistrySupport.doGetObjectFromFactoryBean
object = factory.getObject(); //factoryä¸ºFactoryBeanç±»å‹
----
== ä¸åŒç±»å‹BeanDefinitionå¯¹è±¡å±æ€§å¯¹æ¯”å›¾
å›¾æœ‰ç‚¹ä¸æ¸…æ™°ï¼Œåé¢æˆ‘æ‰¾ä¸ªå¤§å±å¹•æˆªä¸ªå›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191214153155.png[20191214153155.png]

== it`s time to summary
æœ¬æ–‡æ„åœ¨ç†æ¸…ä¸åŒç±»å‹çš„beanåœ¨ç”ŸæˆbeanDefinitionçš„å…¥å£åœ¨å“ªï¼Œä¸ºä½ æä¾›ä¸€ä¸ªæ¢¯å­ã€‚æœ‰äº†è¿™ä¸ªæ¢¯å­ï¼Œä½ å°±å¯ä»¥å¿«é€Ÿå®šä½æŒ‡å®šä½ç½®ï¼Œä»è€Œæ›´è¯¦ç»†çš„å»è¿½è¸ªä»£ç ï¼Œè–„ä¸ç»†èŠ‚ã€‚è¦æƒ³å½»åº•çœŸæ­£çš„å¼„æ¸…æŠ€æœ¯çš„åŸç†ï¼Œçœ‹æ–‡ç« è¿œè¿œä¸å¤Ÿï¼Œå¿…é¡»ä½ è‡ªå·±äº²è‡ªåŠ¨æ‰‹ã€‚æ‰€ä»¥ï¼Œæœ¬æ–‡çš„ç›®çš„æ„åœ¨ç¼©çŸ­ä½ å­¦ä¹ æŠ€æœ¯åŸç†çš„è·¯å¾„ï¼ŒèŠ‚çœå®è´µçš„æ—¶é—´åšæ›´é‡è¦çš„äº‹æƒ…ã€‚


== æ‰©å±•
æˆ‘ä»¬è–„ä¸å»çš®åå‘ç°ï¼Œ`beanDefinitionå¦‚ä½•ç”Ÿæˆbean instance`çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä»æºç ä¸­å¯ä»¥å‘ç°ï¼Œæ‰€æœ‰ç±»å‹beançš„å®ä¾‹åŒ–æœ€ç»ˆéƒ½ä¼šè°ƒç”¨getObjectForBeanInstance()æ–¹æ³•ã€‚åœ¨getObjectForBeanInstance()æ–¹æ³•ä¸­ä¼šå…ˆåˆ¤æ–­beanæ˜¯ä¸æ˜¯FactoryBeanï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±ç›´æ¥è¿”å›Beanã€‚å¦‚æœæ˜¯FactoryBeanï¼Œä¸”nameæ˜¯ä»¥&ç¬¦å·å¼€å¤´ï¼Œé‚£ä¹ˆè¡¨ç¤ºçš„æ˜¯è·å–FactoryBeançš„åŸç”Ÿå¯¹è±¡ï¼Œä¹Ÿä¼šç›´æ¥è¿”å›ã€‚å¦‚æœnameä¸æ˜¯ä»¥&ç¬¦å·å¼€å¤´ï¼Œé‚£ä¹ˆè¡¨ç¤ºè¦è·å–FactoryBeanä¸­getObject()æ–¹æ³•è¿”å›çš„å¯¹è±¡ã€‚è–„ä¸å»çš®åä»£ç å¦‚ä¸‹

----
AbstractBeanFactory class
protected <T> T doGetBean(final String name, @Nullable final Class<T> requiredType,
			@Nullable final Object[] args, boolean typeCheckOnly) throws BeansException {
	final String beanName = transformedBeanName(name);
	Object bean;

	Object sharedInstance = getSingleton(beanName);
	if (sharedInstance != null && args == null) {
		bean = getObjectForBeanInstance(sharedInstance, name, beanName, null);
	}
	else {
		if (mbd.isSingleton()) {
			
			bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
		}
		else if (mbd.isPrototype()) {
			bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);
		}
		else {
			bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);
		}
		
	}
	return (T) bean;
}
----


ä¸€å¼ å›¾relaxä½ çš„æ€ç»ª
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191214154439.png[20191214154439.png]