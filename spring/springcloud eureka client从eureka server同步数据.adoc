= springcloud eureka clientä»eureka serveråŒæ­¥æ•°æ®
:toc: left
:toc-title: ç›®å½•
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: â—
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
// :tip-caption: :bulb:
// :note-caption: :information_source:
// :important-caption: :heavy_exclamation_mark:	
// :caution-caption: :fire:
// :warning-caption: :warning:
:icons: font

Doc writer yaoyihao1@gmail.com

== æ¦‚è¿°
ä»eureka clientç«¯çœ‹ï¼š
eureka clientå®šæ—¶ä»eureka serverä¸­æ‹¿åˆ°çš„æ•°æ®æ”¾åˆ°è‡ªå·±çš„DiscoveryClient.LocalRegionApps/remoteRegionVsAppsä¸­ï¼Œè€Œåribbonã€feignç­‰å®¢æˆ·ç«¯ç»„ä»¶ä½¿ç”¨DiscoveryClient.LocalRegionApps/remoteRegionVsAppsæŸ¥æ‰¾æœ€æ–°çš„æœåŠ¡serviceï¼Œå®Œæˆä¸šåŠ¡é€»è¾‘ï¼Œå¦‚è´Ÿè½½å‡è¡¡

ä¸‹é¢ä¸€èµ·åˆ†æä¸‹eureka clientæ˜¯æ€ä¹ˆä»eureka serveråŒæ­¥æ•°æ®çš„
== springcloud-eureka clientä»eureka serveråŒæ­¥æ•°æ®è¿‡ç¨‹åˆ†æ
å…¥å£
eureka-client-1.6.2.jar
DiscoveryClient.getAndStoreFullRegistry()æ–¹æ³•ä»£ç å¦‚ä¸‹
----
private void getAndStoreFullRegistry() throws Throwable {
        long currentUpdateGeneration = fetchRegistryGeneration.get();
        Applications apps = null;
        // ä½¿ç”¨jerseyè°ƒç”¨eureka serverçš„æ¥å£è·å–æ•°æ®
        EurekaHttpResponse<Applications> httpResponse = clientConfig.getRegistryRefreshSingleVipAddress() == null
                ? eurekaTransport.queryClient.getApplications(remoteRegionsRef.get())
                : eurekaTransport.queryClient.getVip(clientConfig.getRegistryRefreshSingleVipAddress(), remoteRegionsRef.get());
        if (httpResponse.getStatusCode() == Status.OK.getStatusCode()) {
            apps = httpResponse.getEntity();
        }
        if (fetchRegistryGeneration.compareAndSet(currentUpdateGeneration, currentUpdateGeneration + 1)) {
            // å°†è·å–åˆ°çš„æ•°æ®æ”¾åˆ°this.localRegionAppså±æ€§ä¸­
            localRegionApps.set(this.filterAndShuffle(apps));
        }
}
----
eureka clientä»eureka serveråŒæ­¥æ•°æ®æ˜¯å®šæ—¶åŒæ­¥çš„ï¼Œæ‰€ä»¥DiscoveryClient.getAndStoreFullRegistry()æ–¹æ³•æ˜¯å®šæ—¶è¢«è°ƒç”¨çš„ï¼Œè°ƒç”¨æ ˆå¦‚ä¸‹
----
-DiscoveryClient.CacheRefreshThread.run()
--DiscoveryClient.fetchRegistry()
----DiscoveryClient.fetchRegistry(boolean forceFullRegistryFetch)
------DiscoveryClient.getAndStoreFullRegistry()
----

DiscoveryClientçš„å†…éƒ¨ç±»CacheRefreshThreadæ˜¯ä¸€ä¸ªRunnableä»»åŠ¡,æ—¢ç„¶æ˜¯å®šæ—¶å‘¨æœŸæ‰§è¡Œï¼Œé‚£åŠ¿å¿…å®ƒä¼šè¢«å…¶ä»–çº¿ç¨‹æ± æ‰§è¡Œ
----
DiscoveryClientçš„å†…éƒ¨class
class CacheRefreshThread implements Runnable {
    public void run() {
        refreshRegistry();
    }
}
----
æ‰§è¡Œè¿™ä¸ªä»»åŠ¡çš„çº¿ç¨‹æ± ,DiscoveryClient.initScheduledTasks(),çœ‹æ³¨é‡Š"Initializes all scheduled tasks"å°±çŸ¥é“ï¼Œä»–ä¸ä»…æ‰§è¡Œäº†è¿™ä¸ªä»»åŠ¡ï¼Œè¿˜æœ‰å…¶ä»–çš„ä»»åŠ¡åœ¨è¿™é‡Œæ‰§è¡Œï¼Œä»£ç é€»è¾‘å¦‚ä¸‹
----
DiscoveryClient class
private void initScheduledTasks() {
    // ä»eureka serveræ‹¿åˆ°æœ€æ–°æœåŠ¡åˆ—è¡¨æ•°æ®ã€‚è¿™é‡Œæœ‰ä¸ªå¼€å…³ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶å¼€æˆ–å…³: eureka.client.fetch-registry:true/false
    if (clientConfig.shouldFetchRegistry()) {
        // registry cache refresh timer
        int registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();
        int expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();
        scheduler.schedule(
                new TimedSupervisorTask(
                        "cacheRefresh",
                        scheduler,
                        cacheRefreshExecutor,
                        registryFetchIntervalSeconds,
                        TimeUnit.SECONDS,
                        expBackOffBound,
                        new CacheRefreshThread()
                ),
                registryFetchIntervalSeconds, TimeUnit.SECONDS);
    }
    
    // æ˜¯å¦æ³¨å†Œè‡ªå·±åˆ°eureka serverä¸Šã€‚è¿™é‡Œä¹Ÿæœ‰ä¸ªå¼€å…³ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶å¼€æˆ–å…³: eureka.client.register-with-eureka:true/false
    if (clientConfig.shouldRegisterWithEureka()) {
        int renewalIntervalInSecs = instanceInfo.getLeaseInfo().getRenewalIntervalInSecs();
        int expBackOffBound = clientConfig.getHeartbeatExecutorExponentialBackOffBound();
        logger.info("Starting heartbeat executor: " + "renew interval is: " + renewalIntervalInSecs);

        // Heartbeat timer
        scheduler.schedule(
                new TimedSupervisorTask(
                        "heartbeat",
                        scheduler,
                        heartbeatExecutor,
                        renewalIntervalInSecs,
                        TimeUnit.SECONDS,
                        expBackOffBound,
                        new HeartbeatThread()
                ),
                renewalIntervalInSecs, TimeUnit.SECONDS);

        // InstanceInfo replicator
        instanceInfoReplicator = new InstanceInfoReplicator(
                this,
                instanceInfo,
                clientConfig.getInstanceInfoReplicationIntervalSeconds(),
                2); // burstSize

        statusChangeListener = new ApplicationInfoManager.StatusChangeListener() {
            @Override
            public String getId() {
                return "statusChangeListener";
            }

            @Override
            public void notify(StatusChangeEvent statusChangeEvent) {
                if (InstanceStatus.DOWN == statusChangeEvent.getStatus() ||
                        InstanceStatus.DOWN == statusChangeEvent.getPreviousStatus()) {
                    // log at warn level if DOWN was involved
                    logger.warn("Saw local status change event {}", statusChangeEvent);
                } else {
                    logger.info("Saw local status change event {}", statusChangeEvent);
                }
                instanceInfoReplicator.onDemandUpdate();
            }
        };

        if (clientConfig.shouldOnDemandUpdateStatusChange()) {
            applicationInfoManager.registerStatusChangeListener(statusChangeListener);
        }

        instanceInfoReplicator.start(clientConfig.getInitialInstanceInfoReplicationIntervalSeconds());
    } else {
        logger.info("Not registering with Eureka server per configuration");
    }
}
----
è¿™é‡Œä½¿ç”¨äº†3ä¸ªçº¿ç¨‹æ± (ä¸€ä¸ªå‘¨æœŸæ€§çš„ï¼Œä¸¤ä¸ªæ™®é€šçš„)ï¼Œå’Œä¸€ä¸ªRunnableï¼Œå®Œæˆå„è‡ªçš„åŒæ­¥ä»»åŠ¡ã€‚å‘¨æœŸæ€§çš„çº¿ç¨‹æ± è°ƒç”¨å‘¨æœŸæ–¹æ³•ä½¿ç”¨ä¸¤ä¸ªæ™®é€šçš„çº¿ç¨‹æ± æ‰§è¡Œtask