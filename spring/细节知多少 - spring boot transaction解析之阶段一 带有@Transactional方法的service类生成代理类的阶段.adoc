= ç»†èŠ‚çŸ¥å¤šå°‘ - spring boot transactionè§£æä¹‹é˜¶æ®µä¸€ å¸¦æœ‰@Transactionalæ–¹æ³•çš„serviceç±»ç”Ÿæˆä»£ç†ç±»çš„é˜¶æ®µ:toc: left
:toc-title: ç›®å½•
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: â—
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
// :tip-caption: :bulb:
// :note-caption: :information_source:
// :important-caption: :heavy_exclamation_mark:	
// :caution-caption: :fire:
// :warning-caption: :warning:
:icons: font

Doc writer yaoyihao1@gmail.com


== æ¦‚è¿°
spring boot transactionæˆ‘ä»¬å¹³æ—¶ç”¨ç€éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨serviceæ–¹æ³•ä¸Šå£°æ˜@Transactionalå°±å¯ä»¥äº†ã€‚ä½†æ˜¯è¦çŸ¥é“ï¼Œç®€å•çš„èƒŒåæ˜¯ä¸ç®€å•ï¼Œåªæ˜¯å¾ˆå¤šä¸œè¥¿springæ¡†æ¶å¸®æˆ‘ä»¬åšå¥½äº†ã€‚å¦‚æœæƒ³è¿›é˜¶ï¼Œæƒ³è¿›æ­¥ï¼Œæƒ³å¼„æ‡‚ï¼Œæƒ³å­¦ä¹ ï¼Œéœ€è¦æ¥è¿‘å®ƒï¼Œäº†è§£å®ƒï¼Œå¼„æ‡‚å®ƒï¼Œæœ€å¥½çš„æ–¹æ³•è«è¿‡äºdebugå®ƒçš„æºç äº†ã€‚

ç¬”è€…æŠŠspring boot transactionçš„æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ
1. å¸¦æœ‰@Transactionalæ–¹æ³•çš„serviceç±»ç”Ÿæˆä»£ç†ç±»çš„é˜¶æ®µ
2. è®¿é—®serviceç±»çš„@Transactionalæ–¹æ³•å®ç°äº‹åŠ¡çš„é˜¶æ®µ

æœ¬æ–‡è¯´ä¸‹ç¬¬ä¸€é˜¶æ®µï¼Œç”¨è¿‡springçš„äººå·®ä¸å¤šéƒ½æ˜¯çŸ¥é“ï¼Œspring äº‹åŠ¡çš„å®ç°æ˜¯é€šè¿‡aopçš„æ–¹å¼ã€‚æ‰€ä»¥æœ¬ç³»åˆ—çš„å‰ææ˜¯åŸºäºæ³¨è§£çš„aopå®ç°è§£æä½ è¦çŸ¥é“äº›ï¼Œè¿™éƒ¨åˆ†è¯·å‚è€ƒï¼š https://yaoyuanyy.github.io/2019/04/21/%E7%BB%86%E8%8A%82%E7%9F%A5%E5%A4%9A%E5%B0%91%20-%20spring%20boot%20aop%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E8%A7%A3%E6%9E%90%E4%B9%8B%E9%98%B6%E6%AE%B5%E4%B8%80/[spring boot aopè¿‡ç¨‹è§£æä¹‹é˜¶æ®µä¸€ AnnotationAwareAspectJAutoProxyCreatoråŠ è½½å’Œåˆå§‹åŒ–], AnnotationAwareAspectJAutoProxyCreatoræ˜¯aopåŠ¨æ€ä»£ç†çš„èµ·å§‹ç‚¹å’Œå…¥å£å¤„ï¼Œæ‰€æœ‰çš„beanClassç»è¿‡é€šè¿‡ä»–çš„å®ä¾‹åŒ–å‰ç½®æ–¹æ³•å’Œæ‰€æœ‰çš„bean Objectç»è¿‡ä»–çš„åˆå§‹åŒ–åç½®æ–¹æ³•æ—¶éƒ½ä¼šåˆ¤æ–­æ˜¯å¦ç”Ÿæˆä»£ç†ç±»ã€‚ç¬”è€…å‡å®šä½ äº†è§£äº†è¿™éƒ¨åˆ†ã€‚

æœ¬æ–‡ç”¨åˆ°çš„ä»£ç é¡¹ç›®ï¼š https://github.com/yaoyuanyy/springboot_project/tree/feature-docker-20190517/springboot_mybatis[springboot_mybatis]


== æŠ€æœ¯æ ˆ

----
spring boot 1.5.10
spring framework 4.3.14

----


== ç”¨ä¾‹ä»£ç 

----
@RestController
@Slf4j
@RequestMapping("/user")
public class UserController {

	@Resource
	private IUserService userService;

	/**
	 * @param schoolName
	 * @param studentId
	 * @return
	 */
    @GetMapping("/updateSchoolName")
    public ResponseResult updateSchoolName(String schoolName, long studentId) {
        log.info("updateSchoolName param schoolName:{} studentId:{}", schoolName, studentId);
        userService.updateSchoolName(schoolName, studentId);
        return ResponseResult.ok();
    }
}

public interface IUserService {
	int insert(User user);
    int updateScore(long score, long id);
    void updateSchoolName(String schoolName, long studentId);
}

@Service
public class UserServiceImpl implements IUserService {
	@Resource
	private UserMapper userMapper;
    @Resource
    private StudentMapper studentMapper;

	@Override
    @Transactional(rollbackFor = Throwable.class)
	public int insert(User user) {
        int count = userMapper.insert(user);
		return count;
	}

    @Override
    @Transactional(rollbackFor = Throwable.class)
    public int updateScore(long score, long id) {
        int count = userMapper.updateScore(iii, id);
        return count;
    }

    @Override
    @Transactional(rollbackFor = Throwable.class)
    public void updateSchoolName(String schoolName, long studentId) {
        User user = userMapper.fingByStudentId(studentId);
        studentMapper.updateSchoolName(schoolName, user.getStudentId());
    }
}

public interface StudentMapper {
    Student findById(@Param("id") long id);
	int updateSchoolName(@Param("schoolName") String schoolName, @Param("id") long id);
}

public interface UserMapper {
	int insert(User user);
	int updateScore(@Param("score") long score, @Param("id") long id);
}

----
ä»¥ä¸Šä»£ç æ¨¡æ‹Ÿäº†å®é™…å¼€å‘ä¸­mvcå±‚çº§è°ƒç”¨å…³ç³»ï¼Œäº‹åŠ¡åœ¨serviceå±‚ã€‚æˆ‘ä»¬ä»¥æ­¤ä»£ç ä¸ºä¾‹é˜è¿°springäº‹åŠ¡ç›¸å…³çŸ¥è¯†ç‚¹


== å¸¦ç€é—®é¢˜å­¦ä¹ 
> å¸¦ç€é—®é¢˜å­¦ä¹ å¾€å¾€èµ·åˆ°æ›´å¥½çš„æ•ˆæœ

é—®é¢˜ï¼š

----
1. serviceç±»åªè¦æœ‰æ–¹æ³•åŠ äº†@Transactionalæ³¨è§£å°±ä¼šç”Ÿæˆä»£ç†ç±»å—ï¼Œæ­¤å¤„çš„æ–¹æ³•æœ‰æ¡ä»¶å—
2. spring boot æ¶‰åŠtransactionäº‹åŠ¡çš„xxxAutoConfigurationéƒ½æœ‰å“ªäº›
3. spring boot é»˜è®¤ç”Ÿæˆä»£ç†çš„æ–¹å¼æ˜¯cglibè¿˜æ˜¯jdk
4. ä»€ä¹ˆæ ·çš„æ–¹æ³•å¯ä»¥ç”Ÿæˆä»£ç†æ–¹æ³•


----
ä¸‹é¢å¼€å§‹å’Œç¬”è€…ä¸€èµ·èµ°å…¥spring aopç”Ÿæˆä»£ç†ç±»çš„å°æºªï¼Œä»æœ¬æ–‡å¼€å¤´å¤„æˆ‘ä»¬çŸ¥é“ï¼Œç”Ÿæˆä»£ç†ç±»çš„å…¥å£æ˜¯AnnotationAwareAspectJAutoProxyCreator(ä½¿ç”¨çˆ¶ç±»çš„æ–¹æ³•)å®ä¾‹åŒ–å‰ç½®æ–¹æ³•å’Œåˆå§‹åŒ–åç½®æ–¹æ³•(å¦‚æœæ­¤å¤„ä¸å¤ªäº†è§£ï¼Œè¯·å‚è€ƒï¼š https://yaoyuanyy.github.io/2019/04/21/%E7%BB%86%E8%8A%82%E7%9F%A5%E5%A4%9A%E5%B0%91%20-%20spring%20boot%20aop%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E8%A7%A3%E6%9E%90%E4%B9%8B%E9%98%B6%E6%AE%B5%E4%B8%80/[spring boot aopè¿‡ç¨‹è§£æä¹‹é˜¶æ®µä¸€ AnnotationAwareAspectJAutoProxyCreatoråŠ è½½å’Œåˆå§‹åŒ–]ã€‚æˆ‘ä»¬ç›´æ¥ä»æ­¤å¤„å±•å¼€


== ç”Ÿæˆä»£ç†ç±»æ¡ä»¶åˆ¤æ–­
æˆ‘ä»¬çœ‹ä¸‹å‰åç½®æ–¹æ³•çš„ä»£ç ã€‚åŒæ ·ï¼Œå› ä¸ºè¿™é‡Œåœ¨ https://yaoyuanyy.github.io/2019/04/21/%E7%BB%86%E8%8A%82%E7%9F%A5%E5%A4%9A%E5%B0%91%20-%20spring%20boot%20aop%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E8%A7%A3%E6%9E%90%E4%B9%8B%E9%98%B6%E6%AE%B5%E4%B8%80/[spring boot aopè¿‡ç¨‹è§£æä¹‹é˜¶æ®µä¸€ AnnotationAwareAspectJAutoProxyCreatoråŠ è½½å’Œåˆå§‹åŒ–] å·²ç»é˜è¿°è¿‡ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬åªå…³æ³¨å’Œspring transactionæœ‰å…³çš„åœ°æ–¹

----
public Object postProcessBeforeInstantiation(Class<?> beanClass, String beanName) throws BeansException {
	Â·Â·Â·Â·Â·Â·
	// shouldSkipæ–¹æ³•æ˜¯é‡ç‚¹ï¼Œåˆ¤æ–­æ˜¯å¦åº”è¯¥ä¸ºbeanClassç”Ÿæˆä»£ç†ç±»
	if (isInfrastructureClass(beanClass) || shouldSkip(beanClass, beanName)) { // (1)
		this.advisedBeans.put(cacheKey, Boolean.FALSE);
		return null;
	}
	 

	// Create proxy here if we have a custom TargetSource
	if (beanName != null) {
		TargetSource targetSource = getCustomTargetSource(beanClass, beanName);
		if (targetSource != null) {
			this.targetSourcedBeans.add(beanName);
			Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(beanClass, beanName, targetSource); // (2)
			Object proxy = createProxy(beanClass, beanName, specificInterceptors, targetSource);
			this.proxyTypes.put(cacheKey, proxy.getClass());
			return proxy;
		}
	}

	return null;
}

public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
	if (bean != null) {
		Object cacheKey = getCacheKey(bean.getClass(), beanName);
		if (!this.earlyProxyReferences.contains(cacheKey)) {
			return wrapIfNecessary(bean, beanName, cacheKey);
		}
	}
	return bean;
}
	
protected Object wrapIfNecessary(Object bean, String beanName, Object cacheKey) {
	Â·Â·Â·Â·Â·Â·
	if (isInfrastructureClass(bean.getClass()) || shouldSkip(bean.getClass(), beanName)) { // (1)
		this.advisedBeans.put(cacheKey, Boolean.FALSE);
		return bean;
	}

	// Create proxy if we have advice.
	Object[] specificInterceptors = getAdvicesAndAdvisorsForBean(bean.getClass(), beanName, null); // (2)
	if (specificInterceptors != DO_NOT_PROXY) {
		Object proxy = createProxy(
				bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean));  // (3)
		return proxy;
	}

	return bean;
}

----
è¿™é‡Œæˆ‘ä»¬åªåˆ—å‡ºäº†å…³é”®ä»£ç ã€‚å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæ–¹æ³•åœ¨åˆ¤æ–­æ˜¯å¦ç”Ÿæˆä»£ç†ç±»æ—¶éƒ½ç”¨åˆ°äº†<font color=green>(1)</font>å¤„shouldSkip(beanClass, beanName)æ–¹æ³•ã€‚æ­¤æ–¹æ³•ä¸»è¦é€»è¾‘ä¸ºè·å–Advisorç±»å‹çš„beansï¼Œå¦‚æœè·å–åˆ°åˆ¤æ–­æ˜¯å¦ä¸ºAspectåˆ‡é¢ç›¸å…³çš„é€»è¾‘ï¼Œå¦åˆ™ç›´æ¥èµ°superå³AbstractAutoProxyCreator.shouldSkipé€»è¾‘ï¼Œè¿™ä¸ªæ–¹æ³•é»˜è®¤æ˜¯falseã€‚æ­¤å¤„çš„é‡ç‚¹æ˜¯è·å–Advisorç±»å‹çš„beansï¼Œè·å–çš„åœ°æ–¹æ˜¯BeanFactoryå®¹å™¨ã€‚
è°ƒç”¨æ ˆä¸ºï¼š
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129091721.png[20201129091721]
å…·ä½“ä»£ç ä¸ºï¼š

----
BeanFactoryAdvisorRetrievalHelper class è¿™ä¸ªç±»æ˜¯ä¸“é—¨ä»BeanFactoryè·å–Advisorçš„
public List<Advisor> findAdvisorBeans() {
	// Determine list of advisor bean names, if not cached already.
	String[] advisorNames = null;
	synchronized (this) {
		advisorNames = this.cachedAdvisorBeanNames; // é¢å¤–çš„é—®é¢˜ï¼Œè¿™å¥åº”è¯¥æ”¾åˆ°synchronizedå¤–æ›´å¥½å§ï¼Ÿ
		if (advisorNames == null) {
			advisorNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors(
					this.beanFactory, Advisor.class, true, false);
			this.cachedAdvisorBeanNames = advisorNames;
		}
	}
		
	List<Advisor> advisors = new LinkedList<Advisor>();
	for (String name : advisorNames) {
		if (isEligibleBean(name)) {
			try {
				advisors.add(this.beanFactory.getBean(name, Advisor.class));
			}catch (BeanCreationException ex) {throw ex;}
		}
	}
	return advisors;
}

----
ä¸Šé¢æ–¹æ³•ä»£ç ä½¿ç”¨`BeanFactoryUtils.beanNamesForTypeIncludingAncestors()`è·å–Advisorç±»å‹classNameï¼ŒåŒæ—¶è¿™é‡Œä½¿ç”¨äº†ç¼“å­˜æ–¹ä¾¿ä»¥åä½¿ç”¨ã€‚ç„¶åé€šè¿‡beanFactory.getBean(name,Class)æ–¹æ³•è·å–beanå®ä¾‹å¹¶è¿”å›ã€‚å®é™…debugæ—¶ï¼Œæˆ‘ä»¬è·å–çš„advisorNameæ˜¯`org.springframework.transaction.config.internalTransactionAdvisor`ï¼Œä¸ºä»€ä¹ˆæ˜¯å®ƒå‘¢ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹è¿™ä¸ªä¸œè¥¿æ˜¯å•¥ï¼Œåœ¨å“ªç”¨äº†ï¼Œä»£ç å¦‚ä¸‹

----
public abstract class TransactionManagementConfigUtils {
	/**
	 * The bean name of the internally managed transaction advisor (used when mode == PROXY).
	 */
	public static final String TRANSACTION_ADVISOR_BEAN_NAME = "org.springframework.transaction.config.internalTransactionAdvisor";
}

@Configuration
public class ProxyTransactionManagementConfiguration extends AbstractTransactionManagementConfiguration {

	@Bean(name = TransactionManagementConfigUtils.TRANSACTION_ADVISOR_BEAN_NAME)
	@Role(BeanDefinition.ROLE_INFRASTRUCTURE)
	public BeanFactoryTransactionAttributeSourceAdvisor transactionAdvisor() {
		BeanFactoryTransactionAttributeSourceAdvisor advisor = new BeanFactoryTransactionAttributeSourceAdvisor();
		advisor.setTransactionAttributeSource(transactionAttributeSource());
		advisor.setAdvice(transactionInterceptor());
		advisor.setOrder(this.enableTx.<Integer>getNumber("order"));
		return advisor;
	}

	@Bean
	@Role(BeanDefinition.ROLE_INFRASTRUCTURE)
	public TransactionAttributeSource transactionAttributeSource() {
		return new AnnotationTransactionAttributeSource();
	}

	@Bean
	@Role(BeanDefinition.ROLE_INFRASTRUCTURE)
	public TransactionInterceptor transactionInterceptor() {
		TransactionInterceptor interceptor = new TransactionInterceptor();
		interceptor.setTransactionAttributeSource(transactionAttributeSource());
		if (this.txManager != null) {
			interceptor.setTransactionManager(this.txManager);
		}
		return interceptor;
	}
}

----
å¯ä»¥çœ‹åˆ°ProxyTransactionManagementConfiguration.transactionAdvisor()æ–¹æ³•çš„@Beançš„nameå±æ€§ä½¿ç”¨äº†org.springframework.transaction.config.internalTransactionAdvisorä½œä¸ºvalueï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦è¯´ä¸‹å¸¦æœ‰@Configurationå’Œ@Beançš„classè§£æè¿‡ç¨‹ï¼Œå¸¦æœ‰@Beançš„æ–¹æ³•ä¼šè¢«ConfigurationClassParserè§£æä¸ºä¸€ä¸ªBeanDefinitionï¼Œç„¶åå°†è¿™ä¸ªBeanDefinitionæ–¹æ³•DefaultListableBeanFactory.beanDefinitionMapå±æ€§ä¸­key:org.springframework.transaction.config.internalTransactionAdvisor"ï¼Œvalue:BeanDefinition; åŒæ—¶å°†org.springframework.transaction.config.internalTransactionAdvisoræ”¾å…¥DefaultListableBeanFactory.beanDefinitionNamesä¸­ã€‚æ‰€ä»¥ä¸Šé¢çš„BeanFactoryAdvisorRetrievalHelper.findAdvisorBeans()èƒ½é€šè¿‡BeanFactoryUtils.beanNamesForTypeIncludingAncestors()æ–¹æ³•å–åˆ°org.springframework.transaction.config.internalTransactionAdvisorï¼Œè€ŒbeanFactory.getBean(name, Advisor.class)æ–¹æ³•ä¼šä»DefaultListableBeanFactory.beanDefinitionMapè·å–åˆ°keyå¯¹åº”çš„valueï¼Œå³BeanDefinitionå¯¹è±¡ï¼Œè¿›è€Œè§£æè¿™ä¸ªBeanDefinitionï¼Œè§£æå°±æ˜¯å°†BeanDefinitionå®ä¾‹åŒ–æˆBean Instanceï¼Œå…·ä½“ä½“ç°å°±æ˜¯ç”ŸæˆBeanFactoryTransactionAttributeSourceAdvisorå®ä¾‹ï¼Œè§£æçš„è¿‡ç¨‹ç”¨è¿‡äº†åŠ¨æ€ä»£ç†ï¼Œå…·ä½“å‚è§ï¼šTODO

ç”Ÿæˆçš„BeanFactoryTransactionAttributeSourceAdvisorå®ä¾‹ä¸ºä½œä¸ºvalue, org.springframework.transaction.config.internalTransactionAdvisorä½œä¸ºkeyæ”¾å…¥DefaultListableBeanFactory.singletonObjectsã€‚ç”ŸæˆBeanFactoryTransactionAttributeSourceAdvisorå®ä¾‹çš„è¿‡ç¨‹ä¸­ï¼Œç”±äºç”¨åˆ°äº†transactionAttributeSourceå’ŒtransactionInterceptorã€‚æ‰€ä»¥ï¼Œè¿™ä¸¤ä¸ªå®ä¾‹ä¹Ÿä¼šä»¥åŒæ ·çš„æ–¹å¼ç”Ÿæˆã€‚

åˆ°è¿™ï¼Œå’Œspring transactionäº‹åŠ¡ç›¸å…³çš„advisorå®ä¾‹å°±æ‰¾åˆ°äº†ï¼Œå³BeanFactoryTransactionAttributeSourceAdvisorå®ä¾‹ï¼Œä»–åŒ…å«transactionAttributeSourceã€åˆ‡å…¥ç‚¹ï¼šTransactionAttributeSourcePointcutå’Œåˆ‡é¢ï¼štransactionInterceptoræ‹¦æˆªå™¨ã€‚<font color=green>(1)</font>å¤„ä»£ç shouldSkip(beanClass, beanName)æ–¹æ³•åˆ°è¿™å°±èµ°å®Œäº†ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­advisorè¢«æ‰¾åˆ°æ”¾åˆ°beanFactoryä¸­ï¼Œå¯¹åº”çš„advisorNameæ”¾å…¥ç¼“å­˜ä¸­ï¼Œåé¢çš„æ¯ä¸ªbeanClasså’Œbeanç»è¿‡å‰åç½®æ–¹æ³•æ—¶ä¸å¿…å†èµ°ä¸€éå¯»æ‰¾Advisorçš„é€»è¾‘ï¼Œçœ‹è§ç¼“å­˜ä¸­æœ‰å°±ç›´æ¥ä½¿ç”¨ã€‚

<font color=green>(1)</font>å¤„è¿”å›falseï¼Œç¨‹åºå¾€ä¸‹èµ°<font color=green>(2)</font>å¤„ä»£ç getAdvicesAndAdvisorsForBeanï¼Œçœ‹åå­—æˆ‘ä»¬èƒ½çŸ¥é“å¤§æ¦‚ï¼šè·å–Advisorï¼Œçœ‹ä¸‹è¿™é‡Œã€‚åˆæˆ‘ä»¬å‰é¢å®šä¹‰äº†`UserServiceImpl`ç±»ï¼Œæˆ‘ä»¬æƒ³é€šè¿‡è¿™ä¸ªç±»æ¥äº†è§£spring transactionäº‹åŠ¡ï¼Œåˆå› ä¸ºæ¯ä¸ªbeanClasså’Œbeanéƒ½ä¼šèµ°AnnotationAwareAspectJAutoProxyCreatorå‰åç½®æ–¹æ³•ã€‚ä¸ºäº†èƒ½å¿«è¯»å®šä½åˆ°æˆ‘ä»¬å®šä¹‰çš„`UserServiceImpl`ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å‰åç½®æ–¹æ³•çš„`shouldSkip(bean.getClass(), beanName)`ä¸€è¡Œæ‰“ä¸ªå¸¦æ¡ä»¶çš„æ–­ç‚¹(breakpoint)ï¼Œå¦‚ä¸‹å›¾

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129091843.png[20201129091843]
è¿™æ ·åªæœ‰ç¬¦åˆæ¡ä»¶æ‰ä¼šåœåœ¨æ–­ç‚¹ä¸Šã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥ä¸€æ­¥ä¸€æ­¥debugæ¥è§‚å¯Ÿ`UserServiceImpl`æ€æ ·å…³è”spring transactionäº‹åŠ¡çš„ã€‚æ–­ç‚¹è¿›å…¥getAdvicesAndAdvisorsForBeanæ–¹æ³•ã€‚getAdvicesAndAdvisorsForBeanæ–¹æ³•åšä¸¤ä»¶äº‹ï¼šè·å–Advisorå’Œåˆ¤æ–­Advisoræ˜¯å¦èƒ½åº”ç”¨åˆ°ç›®æ ‡beanClass(`UserServiceImpl`)ã€‚çœ‹ä»£ç 

----
protected List<Advisor> findEligibleAdvisors(Class<?> beanClass, String beanName) {
	List<Advisor> candidateAdvisors = findCandidateAdvisors(); // è·å–Advisor
	List<Advisor> eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, beanClass, beanName); // åˆ¤æ–­Advisoræ˜¯å¦èƒ½åº”ç”¨åˆ°ç›®æ ‡beanClass
	// eligibleAdvisorsä¸ä¸ºç©ºæ‰ä¼šç”Ÿæˆä»£ç†ç±»
	return eligibleAdvisors;
}

----
è·å–åˆ°çš„Advisorå³æ˜¯æ˜¯æˆ‘ä»¬åˆšè¯¦ç»†é˜è¿°çš„BeanFactoryTransactionAttributeSourceAdvisorã€‚ä¸‹é¢çœ‹ä¸‹åˆ¤æ–­Advisoræ˜¯å¦èƒ½åº”ç”¨åˆ°ç›®æ ‡beanClassé€»è¾‘ã€‚æˆ‘ä»¬çŸ¥é“BeanFactoryTransactionAttributeSourceAdvisoræœ‰ä¸ªpointcutå±æ€§ï¼šTransactionAttributeSourcePointcutï¼Œå®ä¾‹åŒ–BeanFactoryTransactionAttributeSourceAdvisoræ—¶ï¼ŒTransactionAttributeSourcePointcutä¹Ÿè·Ÿç€å®ä¾‹åŒ–äº†ã€‚æ˜¯å¦èƒ½åº”ç”¨åˆ°ç›®æ ‡beanClassçš„é€»è¾‘å°±åœ¨è¿™é‡Œï¼Œçœ‹ä»£ç 

----
public static List<Advisor> findAdvisorsThatCanApply(List<Advisor> candidateAdvisors, Class<?> clazz) {
	for (Advisor candidate : candidateAdvisors) {
		if (canApply(candidate, clazz, false)) {
			eligibleAdvisors.add(candidate);
		}
	}
	return eligibleAdvisors;
}

AopUtils class
public static boolean canApply(Pointcut pc, Class<?> targetClass, boolean hasIntroductions) {
	// MethodMatcherå³ä¸ºTransactionAttributeSourcePointcut
	MethodMatcher methodMatcher = pc.getMethodMatcher();
	Set<Class<?>> classes = new LinkedHashSet<Class<?>>(ClassUtils.getAllInterfacesForClassAsSet(targetClass));
	classes.add(targetClass);
	// éå†ç›®æ ‡ç±»çš„æ–¹æ³•ï¼Œä¾æ¬¡è¿›è¡ŒåŒ¹é…ï¼Œåªè¦æœ‰ä¸€ä¸ªåŒ¹é…ä¸Šï¼Œè¿”å›trueï¼Œè¡¨ç¤ºå¯ä»¥åº”ç”¨
	for (Class<?> clazz : classes) {
		Method[] methods = ReflectionUtils.getAllDeclaredMethods(clazz);
		for (Method method : methods) {
			if ((introductionAwareMethodMatcher != null &&
					introductionAwareMethodMatcher.matches(method, targetClass, hasIntroductions)) ||
					methodMatcher.matches(method, targetClass)) {
				return true;
			}
		}
	}
	return false;
}

TransactionAttributeSourcePointcut class
public boolean matches(Method method, Class<?> targetClass) {
	TransactionAttributeSource tas = getTransactionAttributeSource();
	return (tas == null || tas.getTransactionAttribute(method, targetClass) != null); // èƒ½è·å–TransactionAttributeå°±è¡¨ç¤ºåŒ¹é…
}

AbstractFallbackTransactionAttributeSource class
public TransactionAttribute getTransactionAttribute(Method method, Class<?> targetClass) {
	Â·Â·Â·Â·Â·Â· // å‰åæ˜¯æœ‰ç¼“å­˜çš„
	TransactionAttribute txAttr = computeTransactionAttribute(method, targetClass);
	return txAttr;
}

AbstractFallbackTransactionAttributeSource class
protected TransactionAttribute computeTransactionAttribute(Method method, Class<?> targetClass) {
	// AnnotationTransactionAttributeSource.publicMethodsOnlyçš„å€¼ä¸ºtrueä¸”ç›®æ ‡æ–¹æ³•çš„ä¿®é¥°ç¬¦æ˜¯publicæ‰æœ‰å¯èƒ½ï¼Œå¦åˆ™ç›´æ¥è¿”å›null
	if (allowPublicMethodsOnly() && !Modifier.isPublic(method.getModifiers())) {
		return null;
	}

	// åœ¨ç›®æ ‡æ–¹æ³•ä¸Šè·å–TransactionAttribute
	TransactionAttribute txAttr = findTransactionAttribute(specificMethod);
	if (txAttr != null) {
		return txAttr;
	}

	// å¦‚æœç›®æ ‡æ–¹æ³•ä¸Šæ²¡æœ‰ï¼Œçœ‹çœ‹åœ¨ç›®æ ‡æ–¹æ³•çš„ç±»ä¸Šè·å–TransactionAttribute
	txAttr = findTransactionAttribute(specificMethod.getDeclaringClass());
	if (txAttr != null && ClassUtils.isUserLevelMethod(method)) {
		return txAttr;
	}
    // éƒ½æ²¡æœ‰è·å–åˆ°ï¼Œè¿”å›nullï¼Œè¡¨ç¤ºæ²¡æœ‰è·å–åˆ°TransactionAttribute
	return null;
}

AnnotationTransactionAttributeSource class AbstractFallbackTransactionAttributeSourceå­ç±»
protected TransactionAttribute determineTransactionAttribute(AnnotatedElement ae) {
	// è·å–AnnotatedElementçš„æ³¨è§£é›†åˆï¼Œå¦‚æœæœ‰@Transactionalï¼Œè·å–åˆ°TransactionAttributeè¿”å›
	if (ae.getAnnotations().length > 0) {
		for (TransactionAnnotationParser annotationParser : this.annotationParsers) {
			TransactionAttribute attr = annotationParser.parseTransactionAnnotation(ae);
			if (attr != null) {
				return attr;
			}
		}
	}
	return null;
}

SpringTransactionAnnotationParser class ç”¨äºè§£æTransactional annotation
public TransactionAttribute parseTransactionAnnotation(AnnotatedElement ae) {
	// åœ¨AnnotatedElementä¸Šçš„@Transactionalè·å–AnnotationAttributes
	AnnotationAttributes attributes = AnnotatedElementUtils.getMergedAnnotationAttributes(ae, Transactional.class);
	if (attributes != null) {
		return parseTransactionAnnotation(attributes);
	}
	return null;
}

----
ä»¥ä¸Šä»£ç æ®µä¸ºåˆ¤æ–­Advisoræ˜¯å¦èƒ½åº”ç”¨åˆ°ç›®æ ‡beanClassçš„æ•´ä½“é€»è¾‘ï¼Œæœ¬è´¨æ˜¯éå†ç›®æ ‡ç±»`userServiceImpl`çš„æ–¹æ³•ï¼Œçœ‹çœ‹æ–¹æ³•ä¸Šæ˜¯å¦æœ‰@Transactionalæ³¨è§£ï¼Œ(è¿™é‡Œæœ‰ä¸ªå‰æ:<font color=green> çœ‹çœ‹æ–¹æ³•ä¸Šæ˜¯å¦æœ‰@Transactionalæ³¨è§£ä¹‹å‰ï¼Œä¼šå…ˆçœ‹çœ‹è¿™ä¸ªæ–¹æ³•æ˜¯ä¸æ˜¯publicä¿®é¥°ç¬¦çš„ï¼Œå¦‚æœä¸æ˜¯ï¼Œç›´æ¥éå†ä¸‹ä¸€ä¸ªæ–¹æ³•ï¼Œè¡¨ç¤ºè¿™ä¸ªæ–¹æ³•ä¸èƒ½ä½œä¸ºç”Ÿæˆä»£ç†ç±»çš„ä¾æ®ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºépublicçš„@Transactionalæ–¹æ³•äº‹åŠ¡ä¸èµ·ä½œç”¨ </font>)ï¼Œå¦‚æœæœ‰@Transactionalæ³¨è§£ï¼Œè·å–å…¶å±æ€§å€¼ç»„æˆçš„TransactionAttributeï¼Œæœ‰äº†TransactionAttributeï¼Œå°±å¯ä»¥è¯´æ˜åŒ¹é…ä¸Šäº†,ä»è€ŒAdvisorè¿”å›ç»™getAdvicesAndAdvisorsForBeanæ–¹æ³•ï¼Œä»è€ŒAdvisorè¿”å›ç»™<font color=green>(2)</font>å¤„ä»£ç å¹¶èµ‹å€¼ç»™specificInterceptorsï¼Œä»è€Œå¯ä»¥ç”Ÿæˆä»£ç†ç±»å³<font color=green>(3)</font>å¤„ä»£ç é€»è¾‘ã€‚é€šè¿‡è¿™ä¸ªAdvisorä¼šä¼ å…¥ç”Ÿæˆä»£ç†ç±»çš„æ–¹æ³•ï¼Œä»£ç†ç±»çš„æ‹¦æˆªå™¨å’Œåˆ‡é¢éƒ½æ˜¯ä»è¿™ä¸ªAdviosræ‹¿åˆ°çš„ï¼Œä¸ç”¨çš„ä»£ç†ç±»çš„Advisoræ˜¯ä¸åŒçš„ï¼Œspring transactionçš„Advisoræ˜¯BeanFactoryTransactionAttributeSourceAdvisorï¼Œè§ä¸‹å›¾ï¼›è€Œspring Aspectçš„Advisoræ˜¯`InstantiationModelAwarePointcutAdvisorImpl`ï¼Œè¯¦æƒ…è§[spring boot aopè¿‡ç¨‹è§£æä¹‹é˜¶æ®µäºŒ åˆ¤æ–­beanNameæˆ–beanClassæ˜¯å¦ç”ŸæˆProxyä»£ç†ç±»](https://yaoyuanyy.github.io/2019/04/28/%E7%BB%86%E8%8A%82%E7%9F%A5%E5%A4%9A%E5%B0%91%20-%20spring%20boot%20aop%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E8%A7%A3%E6%9E%90%E4%B9%8B%E9%98%B6%E6%AE%B5%E4%BA%8C/)

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129091959.png[20201129091959]

== ç”Ÿæˆä»£ç†ç±»
éšç€Advisorè·å–åˆ°äº†ï¼Œå¼€å§‹æ‰§è¡Œ<font color=green>(3)</font>å¤„ä»£ç é€»è¾‘ï¼šç”Ÿæˆäº‹åŠ¡ä»£ç†ç±»ï¼Œä»£ç `Object proxy = createProxy(bean.getClass(), beanName, specificInterceptors, new SingletonTargetSource(bean))`ï¼Œçœ‹å…¶æ–¹æ³•é€»è¾‘ä»£ç 

----
protected Object createProxy(Class<?> beanClass, String beanName, Object[] specificInterceptors, TargetSource targetSource) {
	ProxyFactory proxyFactory = new ProxyFactory();
	// thisä¸ºAnnotationAwareAspectJAutoProxyCreator(proxyTargetClass=true; optimize=false; opaque=false; exposeProxy=false; frozen=false)
	// å³proxyFactoryçš„proxyTargetClasså’ŒexposeProxyç­‰å±æ€§å€¼æ˜¯ä»AnnotationAwareAspectJAutoProxyCreatorä¼ è¿‡æ¥çš„ï¼Œ
	// è€ŒAnnotationAwareAspectJAutoProxyCreatorproxyTargetClasså’ŒexposeProxyç­‰å±æ€§å€¼åˆæ˜¯é€šè¿‡æˆ‘ä»¬æ‰‹åŠ¨å£°æ˜@EnableAspectJAutoProxy(proxyTargetClass=?, exposeProxy=?)ä¼ è¿›æ¥
	proxyFactory.copyFrom(this);

    // å¦‚æœproxyFactory.proxyTargetClassä¸ºfalseï¼Œä½†æ˜¯ç›®æ ‡beanClassæ˜¯ç±»è€Œä¸æ˜¯æ¥å£ï¼Œé‚£ä¹ˆéœ€è¦è®¾ç½®proxyFactory.proxyTargetClassä¸ºtrueï¼Œè¡¨ç¤ºä½¿ç”¨cglinç”Ÿæˆä»£ç†
	if (!proxyFactory.isProxyTargetClass()) {
		if (shouldProxyTargetClass(beanClass, beanName)) {
			proxyFactory.setProxyTargetClass(true);
		}
		else {
			evaluateProxyInterfaces(beanClass, proxyFactory);
		}
	}
	// è·å–advisorï¼Œå°±æ˜¯ä¸Šé¢ä¼ è¿‡æ¥çš„BeanFactoryTransactionAttributeSourceAdvisorå®ä¾‹
	Advisor[] advisors = buildAdvisors(beanName, specificInterceptors);
	proxyFactory.addAdvisors(advisors);
	proxyFactory.setTargetSource(targetSource);
	customizeProxyFactory(proxyFactory);

	proxyFactory.setFrozen(this.freezeProxy);

	return proxyFactory.getProxy(getProxyClassLoader());
}

----
è¿™ä¸ªæ–¹æ³•ç”ŸæˆproxyFactoryå®ä¾‹ï¼ŒproxyFactoryæ˜¯ç®¡ç†å’Œé…ç½®proxysçš„å·¥å…·ç±»ï¼ŒçœŸæ­£è´Ÿè´£ç”Ÿæˆä»£ç†ç±»çš„ç±»æ˜¯AopProxyFactoryï¼Œ`AopProxyFactory.createAopProxy(this)`æ–¹æ³•ç”Ÿæˆä»£ç†ç±»ã€‚thisä¸ºproxyFactoryï¼Œä»è€ŒæŠŠproxyFactoryä¸­çš„Advisorã€targetClassã€proxyTargetClassã€exposeProxyä¸€å¹¶ä¼ åˆ°JdkDynamicAopProxyæˆ–ObjenesisCglibAopProxyä¸­ï¼Œç”±äºproxyTargetClassä¸ºtrueä¸”UserServiceImplä¸æ˜¯æ¥å£ï¼Œæ‰€ä»¥åˆ›å»ºäº†ObjenesisCglibAopProxyå®ä¾‹ï¼Œå³ä½¿ç”¨cglibç”Ÿæˆä»£ç†ç±»
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20201129092130.png[20201129092130]

ä¸‹é¢æ˜¯è°ƒç”¨cglibçš„getProxyæ–¹æ³•åˆ›å»ºä»£ç†ç±»ï¼Œå…³äºè¿™é‡Œè¯¦è§: https://yaoyuanyy.github.io/2019/05/28/%E7%BB%86%E8%8A%82%E7%9F%A5%E5%A4%9A%E5%B0%91%20-%20spring%20boot%20aop%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E8%A7%A3%E6%9E%90%E4%B9%8B%E9%98%B6%E6%AE%B5%E4%B8%89/[spring boot aopè¿‡ç¨‹è§£æä¹‹é˜¶æ®µä¸‰ CglibAopProxyæˆ–JdkDynamicAopProxyç”ŸæˆProxyä»£ç†ç±»é˜¶æ®µ]ã€‚ä¸Aspectç”Ÿæˆä»£ç†çš„ä¸åŒçš„åœ°æ–¹åœ¨ï¼šæ­¤å¤„ProxyFactoryä¸­çš„Advisoræ˜¯BeanFactoryTransactionAttributeSourceAdvisorï¼Œè€ŒAspectçš„æƒ…å†µæ˜¯InstantiationModelAwarePointcutAdvisorImplï¼Œæ‰€ä»¥ç”Ÿæˆçš„ä»£ç†ç±»çš„æ‹¦æˆªå™¨å°±ä¸åŒäº†

spring transaction cglibæ–¹å¼ç”Ÿæˆä»£ç†ç±»çš„è¿‡ç¨‹ä¸­ä¼šéå†(éå†çš„é€»è¾‘åœ¨Enhancer.emitMethods)ç›®æ ‡ç±»çš„æ¯ä¸ªæ–¹æ³•ï¼Œä½¿ç”¨cglibAopProxyçš„ProxyCallbackFilter.acceptæ–¹æ³•åˆ¤æ–­æ˜¯å¦ç”Ÿæˆä»£ç†æ–¹æ³•ï¼Œå…·ä½“ä¸ºè·å–Advisorçš„Intercepters,è·å–Interceptersè¿‡ç¨‹ä¸­ä¼šè¿›è¡ŒåŒ¹é…åˆ¤æ–­ï¼Œåˆ¤æ–­é€»è¾‘ä¸<font color=green>(2)</font>å¤„ç›¸åŒï¼šè°ƒç”¨TransactionAttributeSourcePointcut.matches(method,targetClass)æ–¹æ³•åˆ¤æ–­æ˜¯å¦åŒ¹é…ï¼Œåœ¨è¯¦ç»†ç‚¹è¯´æ˜¯<font color=green>çœ‹çœ‹methodæ˜¯å¦æœ‰@Transactionalæ³¨è§£å’Œmethodçš„ä¿®é¥°ç¬¦æ˜¯å¦ä¸ºpublicï¼Œä¸¤è€…éƒ½æ»¡è¶³æ‰ç”Ÿæˆä»£ç†æ–¹æ³•</font>ï¼Œè¯¦ç»†é€»è¾‘è§å¦‚ä¸‹ä»£ç 

----
public int accept(Method method) {
	Â·Â·Â·Â·Â·Â·
	Class<?> targetClass = this.advised.getTargetClass();
	// Proxy is not yet available, but that shouldn't matter.
	List<?> chain = this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass); // é‡ç‚¹ä»£ç 
	boolean haveAdvice = !chain.isEmpty();
	boolean exposeProxy = this.advised.isExposeProxy();
	boolean isStatic = this.advised.getTargetSource().isStatic();
	boolean isFrozen = this.advised.isFrozen();
	if (haveAdvice || !isFrozen) {
		if (exposeProxy) {
			return AOP_PROXY;
		}
		String key = method.toString();
		// Check to see if we have fixed interceptor to serve this method.
		// Else use the AOP_PROXY.
		if (isStatic && isFrozen && this.fixedInterceptorMap.containsKey(key)) {
			// We know that we are optimizing so we can use the FixedStaticChainInterceptors.
			int index = this.fixedInterceptorMap.get(key);
			return (index + this.fixedInterceptorOffset);
		}
		else {
			return AOP_PROXY;
		}
	}
}

public List<Object> getInterceptorsAndDynamicInterceptionAdvice(Advised config, Method method, Class<?> targetClass) {
 	List<Object> interceptorList = new ArrayList<Object>(config.getAdvisors().length);
	Class<?> actualClass = (targetClass != null ? targetClass : method.getDeclaringClass());
 	AdvisorAdapterRegistry registry = GlobalAdvisorAdapterRegistry.getInstance();

	for (Advisor advisor : config.getAdvisors()) {
		PointcutAdvisor pointcutAdvisor = (PointcutAdvisor) advisor;
		if (config.isPreFiltered() || pointcutAdvisor.getPointcut().getClassFilter().matches(actualClass)) {
			MethodInterceptor[] interceptors = registry.getInterceptors(advisor);
			// MethodMatcherä¸ºTransactionAttributeSourcePointcut
			MethodMatcher mm = pointcutAdvisor.getPointcut().getMethodMatcher();
			if (MethodMatchers.matches(mm, method, actualClass, hasIntroductions)) {
				interceptorList.addAll(Arrays.asList(interceptors));
			}
		}
	}
	return interceptorList;
}

----


== ç”Ÿæˆçš„ä»£ç†ç±»
ç”±äºä»£ç†ç±»å¤ªé•¿ï¼Œä¸“é—¨æ”¾åœ¨ä¸€ä¸ªæ–‡æ¡£ä¸­ï¼Œè¯¦è§ï¼šTODO


æˆ‘ä»¬å·²ç»å®Œæˆäº†å¸¦æœ‰@Transactionalæ–¹æ³•çš„serviceç±»ç”Ÿæˆä»£ç†ç±»çš„æ•´ä¸ªè¿‡ç¨‹çš„è§£æé˜è¿°ï¼Œå¯ä»¥å›ç­”ä¸‹é¢çš„é—®é¢˜äº†

== é—®é¢˜å›ç­”

é—®é¢˜ï¼š

----
1. serviceç±»åªè¦æœ‰æ–¹æ³•åŠ äº†@Transactionalæ³¨è§£å°±ä¼šç”Ÿæˆä»£ç†ç±»å—ï¼Œæ­¤å¤„çš„æ–¹æ³•æœ‰æ¡ä»¶å—
2. spring boot æ¶‰åŠtransactionäº‹åŠ¡çš„xxxAutoConfigurationéƒ½æœ‰å“ªäº›
3. spring boot é»˜è®¤ç”Ÿæˆä»£ç†çš„æ–¹å¼æ˜¯cglibè¿˜æ˜¯jdk
4. ä»€ä¹ˆæ ·çš„æ–¹æ³•å¯ä»¥ç”Ÿæˆä»£ç†æ–¹æ³•

----
å›ç­”ï¼š

----
1. æœ‰çš„ï¼Œ
ç”Ÿæˆä»£ç†ç±»çš„æ¡ä»¶ï¼šå¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªå¸¦æœ‰@Transactionalæ³¨è§£ä¸”ä¿®é¥°ç¬¦æ˜¯publicçš„æ–¹æ³•
ç”Ÿæˆä»£ç†æ–¹æ³•çš„æ¡ä»¶ï¼šæ–¹æ³•å¿…é¡»å¸¦æœ‰@Transactionalæ³¨è§£ä¸”ä¿®é¥°ç¬¦æ˜¯publicçš„æ–¹æ³•

2. spring boot æ¶‰åŠtransactionäº‹åŠ¡çš„xxxAutoConfigurationéƒ½æœ‰å“ªäº›
é€šè¿‡spring-boot-autoconfig-xxx.jarçš„spring.factoriesæ–‡ä»¶å¯çŸ¥ï¼Œæ¶‰åŠtransactionçš„AutoConfigurationæœ‰
a.DataSourceTransactionManagerAutoConfiguration ç”¨äºåˆ›å»ºDataSourceTransactionManagerå®ä¾‹
b.TransactionAutoConfiguration ç”¨äºåˆ›å»ºTransactionTemplateå®ä¾‹
c.DataSourceAutoConfiguration ç”¨äºåˆ›å»ºDataSourceInitializerå®ä¾‹

3. cglib 
TransactionAutoConfigurationçš„å†…éƒ¨ç±»ä¸Šæœ‰@ConditionalOnPropertyæ³¨è§£ï¼Œæ ¹æ®è¿™ä¸ªæ³¨è§£çš„å„å±æ€§å€¼é…ç½®ï¼Œå†³å®šæ˜¯åŠ è½½JdkDynamicAutoProxyConfigurationè¿˜æ˜¯CglibAutoProxyConfigurationï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œâ€™@ConditionalOnProperty(prefix = "spring.aop", name = "proxy-target-class", havingValue = "true", matchIfMissing = true)â€˜ä¼šåŒ¹é…ä¸Šï¼Œæ‰€ä»¥ç¨‹åºä¼šåŠ è½½CglibAutoProxyConfigurationç±»ï¼Œå³spring boot é»˜è®¤ç”Ÿæˆäº‹åŠ¡ä»£ç†çš„æ–¹å¼æ˜¯cglibï¼Œå…·ä½“ä»£ç å¦‚ä¸‹
@Configuration
@EnableConfigurationProperties(TransactionProperties.class)
public class TransactionAutoConfiguration {
	Â·Â·Â·Â·Â·Â·

	@Configuration
	public static class EnableTransactionManagementConfiguration {

		@Configuration
		@EnableTransactionManagement(proxyTargetClass = false)
		@ConditionalOnProperty(prefix = "spring.aop", name = "proxy-target-class", havingValue = "false", matchIfMissing = false)
		public static class JdkDynamicAutoProxyConfiguration {

		}

		@Configuration
		@EnableTransactionManagement(proxyTargetClass = true)
		@ConditionalOnProperty(prefix = "spring.aop", name = "proxy-target-class", havingValue = "true", matchIfMissing = true)
		public static class CglibAutoProxyConfiguration {

		}
	}
}


4.
a. épublicä¿®é¥°çš„æ–¹æ³•
ä¸ä¼šè·å–åˆ°TransactionInterceptorï¼Œä½†æ˜¯ä¼šåœ¨ä»£ç†ç±»ä¸­ç”Ÿæˆä»£ç†æ–¹æ³•ã€‚åªæ˜¯è¿™ä¸ªä»£ç†æ–¹æ³•æ²¡æœ‰TransactionInterceptorï¼Œæ‰€ä»¥è¿™æ ·çš„æ–¹æ³•äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆ

b. privateä¿®é¥°çš„æ–¹æ³•
ä¸ä¼šå‹æ ¹ä¸ä¼šå†ä»£ç†ç±»ä¸­å‡ºç°ï¼Œå› ä¸ºEnhancer.generateClassæ–¹æ³•ä¸­ä¼šå¯¹ç›®æ ‡ç±»çš„æ¯ä¸ªæ–¹æ³•è¿›è¡ŒFilterè¿‡æ»¤ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š
public class VisibilityPredicate implements Predicate {
    public boolean evaluate(Object arg) {
        Member member = (Member)arg;
        int mod = member.getModifiers();
        if (Modifier.isPrivate(mod)) {
            return false;
        } else if (Modifier.isPublic(mod)) {
            return true;
        } else if (Modifier.isProtected(mod) && this.protectedOk) {
            return true;
        } else {
            return this.samePackageOk && this.pkg.equals(TypeUtils.getPackageName(Type.getType(member.getDeclaringClass())));
        }
    }
}
public static Collection filter(Collection c, Predicate p) {
	Iterator it = c.iterator();
	while(it.hasNext()) {
		if (!p.evaluate(it.next())) {
			it.remove();
		}
	}
	return c;

}
å¯ä»¥çœ‹åˆ°ï¼Œå½“ä¿®é¥°ç¬¦æ˜¯privateæ—¶ï¼Œevaluateæ–¹æ³•è¿”å›falseï¼Œä»è€Œè§¦å‘iterator.remove()æ–¹æ³•ï¼Œä»è€Œç”Ÿæˆçš„ä»£ç†ç±»æ²¡æœ‰è¿™ä¸ªæ–¹æ³•çš„ä»£ç†æ–¹æ³•ï¼Œæ‰€ä»¥è¿™æ ·çš„æ–¹æ³•äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆ


----


== spring transaction å…³é”®è¯

----
BeanFactoryTransactionAttributeSourceAdvisor
è¿™æ˜¯ä¸€ä¸ªè·Ÿspring transactionäº‹åŠ¡ç›¸å…³çš„Advisor,åŒå…¶ä»–çš„Advisorä¸€æ ·ï¼ŒåŒ…å«ä¸€ä¸ªPointcutå’Œä¸€ä¸ªAdvice(interceptor)ï¼Œå‰åç½®æ–¹æ³•å°†å®ƒä¼ é€’ç»™ProxyFactoryï¼Œå†ä¼ ç»™AopProxyï¼ŒEnhancerä»å®ƒæ‹¿åˆ°Interceptor(Advice)ï¼Œè¿›è€Œå°†Interceptor(Advice)ç”Ÿæˆåˆ°ä»£ç†ç±»ä¸­

org.springframework.transaction.config.internalTransactionAdvisor
å®ƒæ˜¯ä½œä¸ºBeanFactoryTransactionAttributeSourceAdvisorçš„beanDefinitionå­˜åˆ°åœ¨beanFactoryå®¹å™¨ä¸­beanDefinitionMapå±æ€§çš„key, å½“ç¨‹åºä»beanFactoryå®¹å™¨æ‰¾Advisoræ—¶ï¼Œæ˜¯é€šè¿‡å®ƒä½œä¸ºkeyåœ¨å®¹å™¨ä¸­æ‰¾valueï¼Œä»è€Œåˆ¤æ–­valueæ˜¯ä¸æ˜¯Advisor

ProxyTransactionManagementConfiguration
ç”¨äºåˆ›å»ºBeanFactoryTransactionAttributeSourceAdvisorï¼ŒTransactionAttributeSourceï¼ŒTransactionInterceptorå®ä¾‹ã€‚åªæœ‰ä½¿ç”¨cglibç”Ÿæˆäº‹åŠ¡ä»£ç†ç±»æ—¶ï¼ŒProxyTransactionManagementConfigurationæ‰ä¼šè¢«è§£æ


----


== it`s time to sumiray

æœ¬æ–‡ä¸»è¦é˜è¿°äº†ï¼Œspring transactionäº‹åŠ¡ç”Ÿæˆä»£ç†ç±»çš„è¿‡ç¨‹ä¸­ï¼Œç›®æ ‡ç±»åŠå…¶æ–¹æ³•ç”Ÿæˆäº‹åŠ¡ä»£ç†ç±»å’Œäº‹åŠ¡ä»£ç†æ–¹æ³•æ—¶çš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Œè®¤æ¸…äº†ä»€ä¹ˆæ ·çš„ç±»å’Œæ–¹æ³•ä¸èƒ½ç”Ÿæˆäº‹åŠ¡ä»£ç†ç±»å’Œäº‹åŠ¡ä»£ç†æ–¹æ³•ï¼ŒåŒæ—¶è®²æ¸…äº†å…¶ä¸èƒ½çš„æœ¬è´¨åŸå› ã€‚åŒæ—¶ï¼Œé‡ç‚¹åˆ—ä¸¾äº†ä¸spring transactionæœ‰å…³çš„AutoConfigurationç±»æœ‰å“ªäº›ï¼Œæ€æ ·åŠ è½½ä»–ä»¬ã€‚ä¸‹æ–‡ï¼Œæˆ‘ä»¬é˜è¿°ä¸‹é€šè¿‡curl urlè®¿é—®è¿™äº›serviceæ–¹æ³•æ—¶ï¼Œspring transactionäº‹åŠ¡ä»£ç†ç±»æ˜¯æ€æ ·èµ·åšäº‹åŠ¡æäº¤å’Œå›æ»šä½œç”¨çš„


== æ‰©å±• - jdkç”Ÿæˆspring transactionäº‹åŠ¡ä»£ç†ç±»æ˜¯æ€æ ·çš„é€»è¾‘å‘¢
