= springboot @Configurationç±»å‹çš„classéœ€è¦çŸ¥é“çš„ç»†èŠ‚
:toc: left
:toc-title: ç›®å½•
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: â—
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
// :tip-caption: :bulb:
// :note-caption: :information_source:
// :important-caption: :heavy_exclamation_mark:	
// :caution-caption: :fire:
// :warning-caption: :warning:
:icons: font

Doc writer yaoyihao1@gmail.com

== çŸ¥è¯†ç‚¹æ”¶è·

é€šè¿‡æœ¬æ–‡ï¼Œä½ èƒ½æ”¶è·ä»€ä¹ˆï¼Ÿ

1. @Configurationçš„.classæ–‡ä»¶å¦‚ä½•è¢«springåŠ è½½çš„ï¼Ÿ
2. @Configurationçš„.classæ–‡ä»¶å¦‚ä½•è¢«è½¬åŒ–ä¸ºBeanDefinitionæ”¾å…¥springå®¹å™¨çš„ï¼Ÿ
3. @Configurationçš„BeanDefinitionå¦‚ä½•è½¬åŒ–ä¸ºConfigurationClasså¯¹è±¡çš„
4. ConfigurationClasså¯¹è±¡å±æ€§åœ¨å“ªé‡Œå¼€å§‹è¢«è§£æçš„ï¼Ÿ
5. @Configurationçš„BeanDefinitionçš„beanClasså€¼ä½•æ—¶å˜æˆproxyä»£ç†ç±»çš„ï¼Œä¸ºä»€ä¹ˆè¦å˜
6. @Configurationç±»æœ€ç»ˆä¼šç”Ÿæˆcglib proxyä»£ç†ç±»ï¼Œè¿™ä¸ªç”±@Configurationç±»ç”Ÿæˆçš„cglib proxyä»£ç†ç±»å¦‚ä½•å®ä¾‹åŒ–çš„
7. æˆ‘ä»¬èƒ½ä»ä¸­å¾—åˆ°çš„æ‰©å±•ç‚¹æœ‰å“ªäº›

> æœ¬æ–‡åŠ›æ±‚ä¸“æ³¨å’Œç²¾ç®€ï¼Œå¸Œæœ›ä½ æœ‰æ‰€æ”¶è·å’Œæƒ³æ³•

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191129002132.png[20191129002132.png]

== @Configurationæ³¨è§£ä½œç”¨

@Configurationæ ‡è¯†çš„ç±»æœ‰è¿™äº›ç‰¹æ€§ï¼šå¯ä»¥å£°æ˜å¤šä¸ª@Beanæ–¹æ³•ï¼Œä¸”åœ¨è¿è¡Œæ—¶è¢«springå®¹å™¨å¤„ç†æ¥ç”ŸæˆBeanDefinitionã€‚@Configurationç±»æ˜¯è¢«AnnotationConfigWebApplicationContextå¯åŠ¨(bootstrap)å¤„ç†æµç¨‹çš„ã€‚å£°æ˜æ–¹å¼å¦‚ä¸‹ä»£ç 
----
 @Configuration
 public class AppConfig {
    @Bean
    public MyBean myBean() {
        // instantiate, configure and return bean ...
    }
}


----
@Configuration classå­˜åœ¨å¦‚ä¸‹çº¦æŸï¼Œå¦‚ä¸‹å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191125072356.png[20191125072356.png]

== @Configuration classæºç åŠ è½½åˆ†æ

=== @Configurationç›¸å…³çš„ç±»

å¦‚æœIDEä½ ä½¿ç”¨çš„Ideaï¼Œdouble Shifté”®ï¼Œè¾“å…¥`ConfigurationClass`ï¼Œä¼šå‡ºç°ä¸€é•¿åˆ—çš„ç±»ï¼Œå¦‚ä¸‹å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191125075119.png[20191125075119.png]
è¿™äº›ç±»åˆ†å·¥åä½œï¼Œä»åŠ è½½æ ‡è¯†@Configurationçš„.classæ–‡ä»¶ï¼Œåˆ°ç”ŸæˆBeanDefinitionï¼Œå†åˆ°ç”ŸæˆConfigurationClasså¯¹è±¡ï¼Œå†åˆ°è§£æConfigurationClasså¯¹è±¡ï¼Œå³è§£æ@ConfigurationClass classç±»ä¸­@Beanã€@Importã€@ImportResourceç­‰æ³¨è§£

.classçš„ä½œç”¨è¡¨æ ¼
|===
|class | ä½œç”¨|

|ConfigurationClass |ä¸“é—¨è¡¨ç¤º@Configuration classã€‚å­˜å‚¨è§£æ@Configuration classçš„ä¿¡æ¯|
|ConfigurationClassPostProcessor |ä¸“é—¨ç”¨äºå¤„ç†@Configuration classçš„BeanDefinitoinRegistryPostProcessorï¼ˆBeanFactoryPostProcessorå­ç±»)|
|AnnotationConfigUtils |ä¸“é—¨æ³¨å†ŒBeanPostProcessorå’ŒBeanFactoryPostProcessoråˆ°springå®¹å™¨|
|===


=== @Configurationè§£æè¿‡ç¨‹

==== ConfigurationClassPostProcessorå®ä¾‹åˆ›å»ºè¿‡ç¨‹

æˆ‘ä»¬åˆšè¯´è¿‡ï¼ŒConfigurationClassPostProcessoræ˜¯å¤„ç†@Configuration classçš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒæ˜¯BeanFactoryPostProcessorç±»å‹å­ç±»ä¸”æ˜¯BeanDefinitoinRegistryPostProcessorç±»å‹å­ç±»ã€‚BeanFactoryPostProcessoræ˜¯`AbstractApplicationContext's post-processor handling`æŠ€æœ¯çš„è§„èŒƒæ¥å£ï¼Œåœ¨é¡¹ç›®å¯åŠ¨è¾ƒæ—©æ—¶æ®µï¼Œå®ƒä¾¿å¼€å§‹å·¥ä½œã€‚æˆ–è€…è¯´ä»»ä½•spring booté¡¹ç›®å¯åŠ¨æ—¶éƒ½æ˜¯èµ°`post-processor handling`å¤„ç†é€»è¾‘ï¼Œè¿™ä¸ªé€»è¾‘çš„å…¥å£åœ¨`PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors()æ–¹æ³•`ï¼Œä»£ç å¦‚ä¸‹

----
PostProcessorRegistrationDelegate class
public static void invokeBeanFactoryPostProcessors(
		ConfigurableListableBeanFactory beanFactory, List<BeanFactoryPostProcessor> beanFactoryPostProcessors) {
    Â·Â·Â·
	// Invoke BeanDefinitionRegistryPostProcessors first, if any.
	if (beanFactory instanceof BeanDefinitionRegistry) {
		BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;
		List<BeanDefinitionRegistryPostProcessor> currentRegistryProcessors = new ArrayList<>();

		// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.
		String[] postProcessorNames =
				beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); // (1)
		for (String ppName : postProcessorNames) {
			if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {
				currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); // (2)
			}
		}
		sortPostProcessors(currentRegistryProcessors, beanFactory);
        // å°†@Configurationç±»ç”ŸæˆBeanDefinitionï¼Œæ­¤æ—¶çš„BeanDefinition.beanClassä¸ºåŸç±»classå¯¹è±¡
		invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry); // (3)

        // Now, invoke the postProcessBeanFactory callback of all processors handled so far.
        // å°†(3)å¤„çš„BeanDefinition.beanClassèµ‹å€¼ä¸ºproxyä»£ç†ç±»
		nvokeBeanFactoryPostProcessors(registryProcessors, beanFactory);(4)
	}
	Â·Â·Â·
}
----
è¿™ä¸ªæ–¹æ³•å¤„ç†æ‰€æœ‰çš„BeanFactoryPostProcessorç±»å‹å¯¹è±¡ï¼Œä½†æ˜¯é€šè¿‡ä¼˜å…ˆçº§æ¥è§„å®šå…ˆåå¤„ç†é¡ºåºï¼Œä¼˜å…ˆçº§ç»´åº¦æœ‰ä¸¤ä¸ª:`1:BeanDefinitionRegistryPostProcessorç±»å‹å’ŒBeanFactoryPostProcessorç±»å‹ï¼›2:PriorityOrderedå’ŒOrdered`ã€‚è€Œ
ConfigurationClassPostProcessoråŒæ—¶å®ç°äº†BeanDefinitionRegistryPostProcessorå’ŒPriorityOrderedï¼Œæ‰€ä»¥å®ƒå¾—åˆ°æœ€ä¼˜å…ˆå¤„ç†çš„æœºä¼š

å¦‚ä¸Šæ–¹æ³•(1)å¤„ï¼Œä»springå®¹å™¨è·å–BeanDefinitionRegistryPostProcessorç±»å‹çš„beanName, è¿™ä¸ªæ—¶æœŸåªæœ‰ConfigurationClassPostProcessorçš„beanNameæ»¡è¶³ï¼Œéœ€è¦æŒ‡å‡ºï¼šConfigurationClassPostProcessoræ˜¯é€šè¿‡ç¡¬ç¼–ç çš„æ–¹å¼æ³¨å†Œåˆ°springå®¹å™¨çš„ï¼Œè¯¦è§AnnotationConfigUtilsç±»)ï¼Œæ¥ç€æ‰§è¡Œå¦‚ä¸Šæ–¹æ³•(2)å¤„ï¼Œä»¥beanNameä¸ºkeyä»springå®¹å™¨ä¸­è·å–ConfigurationClassPostProcessorå®ä¾‹ã€‚


==== åº”ç”¨ConfigurationClassPostProcessorå®ä¾‹åŠ è½½@Configurationè¿›è¡ŒBeanDefinitionæ³¨å†Œ
å¦‚ä¸Šæ–¹æ³•(3)å¤„ï¼Œå³ä¸ºåº”ç”¨ConfigurationClassPostProcessorå®ä¾‹ã€‚
----
PostProcessorRegistrationDelegate class
private static void invokeBeanDefinitionRegistryPostProcessors(
		Collection<? extends BeanDefinitionRegistryPostProcessor> postProcessors, BeanDefinitionRegistry registry) {
	for (BeanDefinitionRegistryPostProcessor postProcessor : postProcessors) {
		postProcessor.postProcessBeanDefinitionRegistry(registry);
	}
}

ConfigurationClassPostProcessor class
@Override
public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) {
	processConfigBeanDefinitions(registry);
}
----
ä»æ–¹æ³•åå¤§æ¦‚å°±çŸ¥é“æ–¹æ³•çš„ä½œç”¨äº†ï¼Œä¼šè°ƒç”¨æ‰€æœ‰`BeanDefinitionRegistryPostProcessorç±»å‹`çš„`postProcessBeanDefinitionRegistry()`æ–¹æ³•ï¼Œæ­¤å¤„åªæœ‰`ConfigurationClassPostProcessor`ç¬¦åˆã€‚

==== åº”ç”¨ConfigurationClassPostProcessorå®ä¾‹å°†BeanDefinition.beanClassç”Ÿæˆproxyä»£ç†ç±»
å¦‚ä¸Š`invokeBeanFactoryPostProcessors`æ–¹æ³•(4)å¤„ï¼Œç»è¿‡äº†æ–¹æ³•(3)çš„å¤„ç†ï¼Œ@Configurationç±»å·²ç»ç”ŸæˆBeanDefinitionï¼Œæ­¤æ—¶BeanDefinition.beanClasså€¼ä¸ºåŸç±»classå¯¹è±¡ã€‚è€Œæ–¹æ³•(4)å¤„ç›®çš„æ˜¯å°†BeanDefinition.beanClassèµ‹å€¼ä¸ºproxyä»£ç†ç±»ï¼Œ`è¿™é‡Œç•™ä¸ªé—®é¢˜ï¼Œå…¶ä»–ä¸ºä»€ä¹ˆè¦è®¾ç½®æˆproxyä»£ç†ç±»å‘¢`

å…³äºæ–¹æ³•(3)å’Œæ–¹æ³•(4)è¦åšçš„äº‹ï¼Œå‚è€ƒä¸‹å›¾ï¼Œæ—¶æœºå’Œä½œç”¨æ¸…æ™°çš„å¯¹æ¯”å’Œå±•ç¤º
![20191212080200.png](https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191212080200.png)

==== @Configuration classè¿‡ç¨‹è§£æ
ä¸‹é¢çš„æ–¹æ³•å°±æ˜¯è§£æ@Configuration classçš„æ ¸å¿ƒé€»è¾‘äº†ã€‚è§£æè¿‡ç¨‹å¯ä»¥æ€»ç»“åˆ†ä¸‰æ­¥ï¼Œæ­£å¥½å¯¹åº”ç€æ–¹æ³•ä¸­(1),(2),(3)å¤„
----
ConfigurationClassPostProcessor class
public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) {
	List<BeanDefinitionHolder> configCandidates = new ArrayList<>();
	String[] candidateNames = registry.getBeanDefinitionNames(); 

	for (String beanName : candidateNames) {
		BeanDefinition beanDef = registry.getBeanDefinition(beanName);
		if (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, this.metadataReaderFactory)){
			configCandidates.add(new BeanDefinitionHolder(beanDef, beanName));//(1)
		}
	}
	Â·Â·Â· æ’åºç­‰

	// Parse each @Configuration class
	ConfigurationClassParser parser = new ConfigurationClassParser(
			this.metadataReaderFactory, this.problemReporter, this.environment,
			this.resourceLoader, this.componentScanBeanNameGenerator, registry);

	Set<BeanDefinitionHolder> candidates = new LinkedHashSet<>(configCandidates);
	Set<ConfigurationClass> alreadyParsed = new HashSet<>(configCandidates.size());
	do {
		parser.parse(candidates); //(2)
		parser.validate();

		Set<ConfigurationClass> configClasses = new LinkedHashSet<>(parser.getConfigurationClasses());
 
		// Read the model and create bean definitions based on its content
		this.reader = new ConfigurationClassBeanDefinitionReader(
				registry, this.sourceExtractor, this.resourceLoader, this.environment,
				this.importBeanNameGenerator, parser.getImportRegistry());
	
		this.reader.loadBeanDefinitions(configClasses); //(3)
		 
	}
	while (!candidates.isEmpty());
	
	Â·Â·Â· Â·Â·Â·
}
----
step1: è·å–å€™é€‰è€…
ä»springå®¹å™¨æ‹¿åˆ°æ‰€æœ‰çš„beanDefinitionNamesï¼Œç„¶åéå†éªŒè¯è·å¾—å€™é€‰è€…ï¼ŒéªŒè¯çš„ä¾æ®æ˜¯class metadataæ˜¯å¦å«æœ‰@Configurationæ³¨è§£ï¼Œä»ä¸‹é¢æˆ‘ä»¬å¯çŸ¥ï¼Œæ­¤æ—¶ï¼ŒbeanDefinitionNamesä¸­åªæœ‰`consumerFeignApp`ç¬¦åˆæ¡ä»¶ã€‚æ‰€ä»¥å€™é€‰è€…å°±æ˜¯consumerFeignAppåŠä»–çš„beanDefinition
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191126082030.png[20191126082030.png]

step2: é€šè¿‡å€™é€‰è€…è·å–ConfigurationClass
æ‰¾åˆ°äº†å€™é€‰è€…ï¼Œä¸‹é¢å°±å¯¹å€™é€‰è€…è¿›è¡Œè§£æï¼Œè§£æçš„å…¨éƒ¨åŠŸèƒ½å’Œé€»è¾‘éƒ½é›†ä¸­åœ¨ConfigurationClassParserç±»ä¸­ï¼Œçœ‹åç§°å¯çŸ¥ï¼Œè¿™ä¸ªç±»ä¸“ä¸šè§£æ@Configurationç±»ã€‚
----
ConfigurationClassParser class
public void parse(Set<BeanDefinitionHolder> configCandidates) {
	for (BeanDefinitionHolder holder : configCandidates) {
		BeanDefinition bd = holder.getBeanDefinition();
		if (bd instanceof AnnotatedBeanDefinition) {
			parse(((AnnotatedBeanDefinition) bd).getMetadata(), holder.getBeanName());
		}
		...
	}

	this.deferredImportSelectorHandler.process();
}

protected final void parse(AnnotationMetadata metadata, String beanName) throws IOException {
	processConfigurationClass(new ConfigurationClass(metadata, beanName));
}

protected void processConfigurationClass(ConfigurationClass configClass) throws IOException {
	// è¯„ä¼°æ ‡è¯†@Configurationçš„ç±»æ˜¯å¦æ»¡è¶³æ¡ä»¶å»åŠ è½½ï¼Œè¿™æ˜¯æ¡ä»¶æ³¨è§£@ConditionalXXXèµ·çš„ä½œç”¨
	// å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä¾æ®è¿™ä¸ªåŠŸèƒ½å®ç°çµæ´»çš„åŠ è½½é…ç½®(å¦‚è®©è°åŠ è½½è¿›æ¥ï¼Œä¸è®©è°åŠ è½½è¿›æ¥^_^)
	if (this.conditionEvaluator.shouldSkip(configClass.getMetadata(), ConfigurationPhase.PARSE_CONFIGURATION)) {
		return;
	}

	// Recursively process the configuration class and its superclass hierarchy.
	SourceClass sourceClass = asSourceClass(configClass);
	do {
		sourceClass = doProcessConfigurationClass(configClass, sourceClass);
	}
	while (sourceClass != null);

    // æ‰€æœ‰åŠ è½½çš„@Configurationç±»éƒ½ä¼šè½¬ä¸ºConfigurationClassæ”¾å…¥è¿™ä¸ªmapä¸­
	this.configurationClasses.put(configClass, configClass);
}

protected final SourceClass doProcessConfigurationClass(ConfigurationClass configClass, SourceClass sourceClass){
	// ä¸ºäº†é›†ä¸­è¯´æ˜æ„å›¾ï¼Œéšè—äº†ä»£ç 
    // Recursively process any member (nested) classes first
	// Process any @PropertySource annotations
	// Process any @ComponentScan annotations
	for (AnnotationAttributes componentScan : componentScans) {
		for (BeanDefinitionHolder holder : scannedBeanDefinitions) {
			if () {
				// è¿›å…¥é€’å½’è°ƒç”¨
				parse(bdCand.getBeanClassName(), holder.getBeanName());
			}
		}
	}

	// Process any @Import annotations
	// Process any @ImportResource annotations
	// Process individual @Bean methods
	// Process default methods on interfaces
	// Process superclass, if any
	// No superclass -> processing is complete
	return null;
}
----

å¦‚ä¸Šæ–¹æ³•æ•´ä½“çš„é€»è¾‘ä¸ºå¯¹ConfigurationClasså’ŒSourceClassè§£æï¼Œæ£€æŸ¥ä»–ä»¬æœ‰æ²¡æœ‰@ComponentScanï¼Œ@Importï¼Œ@Bean methodsï¼Œ@ImportResourceï¼Œ@PropertySourceè¿™äº›æ³¨è§£ï¼Œå¦‚æœæœ‰ï¼Œåˆ†åˆ«å¯¹å…¶è§£æï¼Œè§£æåçš„ç»“æœæ”¾å…¥ConfigurationClassçš„å„å±æ€§ä¸­ï¼Œå¦‚ä¸‹å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191128000838.png[20191128000838.png]

å„ä¸ªæ³¨è§£çš„å±æ€§å€¼ä¸­å¯èƒ½åˆåŒ…å«@Configurationæ³¨è§£ï¼Œåˆè¦å¯¹åŒ…å«çš„@Configurationæ³¨è§£è¿›è¡Œè§£æï¼Œè¿™æ ·å½¢æˆäº†é€’å½’ï¼Œæ‰€ä»¥è§£æè¿‡ç¨‹ä¸­æœ‰ä¸‰ä¸ªæ–¹æ³•å½¢æˆäº†ä¸‰è§’é€’å½’è°ƒç”¨çš„é€»è¾‘ï¼Œå¦‚ä¸‹å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191127235053.png[20191127235053.png]

è¿™ä¸€æ­¥ä¼šå°†æˆ‘ä»¬é¡¹ç›®ä¸­å®šä¹‰çš„@Configurationç±»éƒ½åŠ è½½è¿›æ¥ï¼Œä½ å¯èƒ½æœ‰ç–‘é—®ï¼Œéš¾é“é¡¹ç›®ä¸­æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„@Configurationç±»éƒ½æ˜¯é é€’å½’åŠ è½½è¿›æ¥çš„ï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯NOï¼Œè¯·æ³¨æ„@ComponentScanæ³¨è§£ï¼Œè¿™ä¸ªæ³¨è§£çš„è§£æå™¨å¾ˆå‰å®³ï¼Œå®ƒæŠŠæ‰€æœ‰çš„æ ‡è¯†@Componentæ³¨è§£çš„classåŠ è½½è¿›æ¥ï¼Œè€Œ@Configurationï¼Œ@RestControllerï¼Œ@Serviceï¼Œ@Repositoryç­‰éƒ½åŒ…å«@Componentï¼Œæ‰€æœ‰è¿™äº›æ³¨è§£çš„classéƒ½ä¼šåŠ è½½è¿›æ¥å½¢æˆBeanDefinitionå­˜å…¥spring å®¹å™¨(è§£æè¿‡ç¨‹è¯¦è§ComponentScanAnnotationParser)ã€‚è¯´å›æ¥ï¼Œå¯¹äº@ComponentScanè§£æå™¨åŠ è½½è¿›æ¥çš„BeanDefinitoinï¼Œä¼šè¿›è¡Œæ—¶@Configurationè¿›è¡Œè¿‡æ»¤ï¼Œä»è€Œå¾—åˆ°@Configurationç±»ï¼Œå†æ¬¡è°ƒç”¨parse()æ–¹æ³•ï¼Œè¿™æ—¶ä½“ç°å‡ºä¸‰è§’é€’å½’è°ƒç”¨äº†ã€‚æ­¤æ—¶ï¼Œé¡¹ç›®ä¸­æ‰€æœ‰æˆ‘ä»¬è‡ªå®šä¹‰çš„@Configurationç±»éƒ½è·å–åˆ°äº†

step3: è§£ææ¯ä¸ªConfigurationClass
step2ä¸­å¯¹@Configurationç±»çš„@Importï¼Œ@Bean methodsï¼Œ@ImportResourceè¿›è¡Œè§£æï¼Œè§£æçš„ç»“æœæ”¾å…¥ConfigurationClasså¯¹è±¡çš„importBeanDefinitionRegistrarsï¼ŒbeanMethodsï¼ŒimportedResourcesï¼Œmetadataç­‰å±æ€§ã€‚
æ‰€ä»¥ï¼Œstep2å°†@Configurationç±»çš„è§£æç»“æœéƒ½æ”¾å…¥äº†ConfigurationClasså¯¹è±¡ï¼Œå³ConfigurationClasså¯¹è±¡åŒ…è£…äº†@Configurationç±»çš„æ‰€æœ‰ä¿¡æ¯ã€‚

å›åˆ°ConfigurationClassPostProcessor.processConfigBeanDefinitions()æ–¹æ³•(3)å¤„ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬è§£æConfigurationClassï¼Œè€Œè§£æConfigurationClassè¿‡ç¨‹ç”±ConfigurationClassBeanDefinitionReaderç±»è´Ÿè´£çš„
çœ‹code
----
ConfigurationClassBeanDefinitionReader class
public void loadBeanDefinitions(Set<ConfigurationClass> configurationModel) {
	TrackedConditionEvaluator trackedConditionEvaluator = new TrackedConditionEvaluator();
	for (ConfigurationClass configClass : configurationModel) {
		loadBeanDefinitionsForConfigurationClass(configClass, trackedConditionEvaluator);
	}
}

private void loadBeanDefinitionsForConfigurationClass(
		ConfigurationClass configClass, TrackedConditionEvaluator trackedConditionEvaluator) {

	if (trackedConditionEvaluator.shouldSkip(configClass)) {
		String beanName = configClass.getBeanName();
		if (StringUtils.hasLength(beanName) && this.registry.containsBeanDefinition(beanName)) {
			this.registry.removeBeanDefinition(beanName);
		}
		this.importRegistry.removeImportingClass(configClass.getMetadata().getClassName());
		return;
	}

	if (configClass.isImported()) {
		registerBeanDefinitionForImportedConfigurationClass(configClass);
	}
	for (BeanMethod beanMethod : configClass.getBeanMethods()) {
		loadBeanDefinitionsForBeanMethod(beanMethod);
	}

	loadBeanDefinitionsFromImportedResources(configClass.getImportedResources());
	loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars());
}
----
çœ‹loadBeanDefinitionsForConfigurationClass()æ–¹æ³•ï¼Œæ–¹æ³•ä¸»è¦åŠŸèƒ½ä¸ºå¯¹ConfigurationClassçš„beanMethodsï¼ŒimportedResourcesï¼ŒimportBeanDefinitionReistrarså±æ€§è¿›è¡Œè§£æï¼Œä¸ºä»€ä¹ˆè¦å¯¹è¿™ä¸‰ä¸ªå±æ€§è¿›è¡Œè§£æå‘¢ï¼Œçœ‹çœ‹è¿™ä¸‰ä¸ªå…¶@Importï¼Œ@Bean methodsï¼Œ@ImportResourceçš„ç”¨æ³•
----
@Import(DispatcherServletConfiguration.class)
@ImportResource("classpath:/com/acme/database-config.xml")
protected static class DispatcherServletRegistrationConfiguration {

	@Bean(name = DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME)
	public DispatcherServletRegistrationBean dispatcherServletRegistration(){
		...
	}
}
----
å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸‰ä¸ªæ³¨è§£çš„å±æ€§å€¼éƒ½æ˜¯ç±»æˆ–è€…é…ç½®æ–‡ä»¶æˆ–è€…åŠ è½½æ–‡ä»¶çš„ç±»ï¼Œæ‰€ä»¥ï¼Œéœ€è¦è§£æï¼Œä»è€Œå°†è§£æåˆ°çš„.classæ–‡ä»¶è½¬åŒ–ä¸ºBeanDefinitionæ”¾å…¥springå®¹å™¨ã€‚

== @Configurationç±»çš„cglibä»£ç†ç±»å®ä¾‹åŒ–åˆ†æ
ç”±äº@Configurationæ³¨è§£çš„éƒ½æ˜¯ç±»ï¼Œè€Œéæ¥å£ï¼Œæ‰€æœ‰è¿™é‡Œä½¿ç”¨çš„æ˜¯cglibä»£ç†æŠ€æœ¯ï¼ŒConfigurationClassEnhanceråŒ…è£…äº†cglibã€‚`è¿™é‡Œæˆ‘ä»¬å®é™…å·¥ä½œä¸­å¯ä»¥ç›´æ¥å¤ç”¨ConfigurationClassEnhanceræ»¡è¶³æˆ‘ä»¬ç”Ÿæˆä»£ç†ç±»çš„åœºæ™¯`
----
å®ç°è‡ªBeanFactoryPostProcessor.postProcessBeanFactory
ConfigurationClassPostProcessor class
@Override
public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) {
    // ç”Ÿæˆä»£ç†
    enhanceConfigurationClasses(beanFactory);
    beanFactory.addBeanPostProcessor(new ImportAwareBeanPostProcessor(beanFactory));
}

ConfigurationClassPostProcessor.ConfigurationClassEnhancer class
public void enhanceConfigurationClasses(ConfigurableListableBeanFactory beanFactory) {
    Map<String, AbstractBeanDefinition> configBeanDefs = new LinkedHashMap<>();
    for (String beanName : beanFactory.getBeanDefinitionNames()) {
        BeanDefinition beanDef = beanFactory.getBeanDefinition(beanName);
        if (ConfigurationClassUtils.isFullConfigurationClass(beanDef)) {
            if (!(beanDef instanceof AbstractBeanDefinition)) {
                throw 
            }
            configBeanDefs.put(beanName, (AbstractBeanDefinition) beanDef);
        }
    }

    ConfigurationClassEnhancer enhancer = new ConfigurationClassEnhancer();
    for (Map.Entry<String, AbstractBeanDefinition> entry : configBeanDefs.entrySet()) {
        AbstractBeanDefinition beanDef = entry.getValue();
        // If a @Configuration class gets proxied, always proxy the target class
        beanDef.setAttribute(AutoProxyUtils.PRESERVE_TARGET_CLASS_ATTRIBUTE, Boolean.TRUE);
        // Set enhanced subclass of the user-specified bean class
        Class<?> configClass = beanDef.resolveBeanClass(this.beanClassLoader);
        if (configClass != null) {
            Class<?> enhancedClass = enhancer.enhance(configClass, this.beanClassLoader);
            if (configClass != enhancedClass) {
                beanDef.setBeanClass(enhancedClass);
            }
        }
    }
}

ConfigurationClassPostProcessor.ConfigurationClassEnhancer class
public Class<?> enhance(Class<?> configClass, @Nullable ClassLoader classLoader) {
    if (EnhancedConfiguration.class.isAssignableFrom(configClass)) {
        return configClass;
    }
    Class<?> enhancedClass = createClass(newEnhancer(configClass, classLoader));
    return enhancedClass;
}
----
ä»£ç†çš„ä»£ç å¾ˆæ¸…æ™°ï¼Œå¾ˆå€¼å¾—æˆ‘ä»¬å­¦ä¹ 

== it`s time to summary

æ•´ä¸ªè¿‡ç¨‹å¯ä»¥çœ‹åšæ˜¯ä¸€é¢—å°æ ‘é•¿æˆå‚å¤©å¤§æ ‘ï¼ŒconsumerFeignAppå°±æ˜¯æ ‘è‹—ï¼Œè€Œæˆ‘ä»¬é¡¹ç›®çš„ä»£ç å°±æ˜¯åæ¥å¤§æ ‘çš„æå¹²å’Œå¶å­ã€‚æå¹²å’Œå¶å­ä¸@ComponentScanï¼Œ@Importï¼Œ@Bean methodsï¼Œ@ImportResourceï¼Œ@PropertySourceï¼Œ@Configurationäº¤ç»‡åœ¨ä¸€èµ·è¢«è§£æå‡ºæ¥ï¼Œç”ŸæˆbeanDefinitionã€å®ä¾‹å¯¹è±¡æˆ–ä»£ç†ç±»ã€‚

æœ¬æ–‡ä¸»è¦è¯´æ˜äº†æ ‡è¯†äº†@Configurationçš„.classæ–‡ä»¶ï¼Œæ˜¯å¦‚ä½•è¢«è§£ææˆConfigurationClassï¼Œå†åˆ°è½¬åŒ–ä¸ºConfigurationClassBeanDefinitionæ”¾å…¥springå®¹å™¨ï¼Œå†åˆ°å¦‚ä½•è§£æConfigurationClasså¯¹è±¡å±æ€§ã€‚ä¸ºäº†é›†ä¸­é˜è¿°@Configurationï¼Œæ‰€ä»¥ï¼Œå…¶ä»–çš„éƒ¨åˆ†è¿™é‡Œä¸åšè¯¦è¿°å’Œå»¶å±•ã€‚å¦‚æœé˜…è¯»åä½ æœ‰æ‰€æ”¶è·ï¼Œå…±äº«æ¬¢å–œ


== çŸ¥è¯†ç‚¹æ”¶è·å›å¤
1ï¼Œ2ï¼Œ3ï¼Œ4ç›¸ä¿¡ä½ å·²ç»æœ‰ç­”æ¡ˆäº†ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬çœ‹çœ‹æ‰©å±•ç‚¹æœ‰ä»€ä¹ˆ 
1. åŠ è½½ä¸€äº›packageç›®å½•ä¸‹çš„.classæ–‡ä»¶
----
ClassPathBeanDefinitionScanner scanner = new ClassPathBeanDefinitionScanner(this.registry,
			componentScan.getBoolean("useDefaultFilters"), this.environment, this.resourceLoader);
Set<BeanDefinitionHolder> beanDefinitions = scanner.doScan(StringUtils.toStringArray(basePackages));
å¦‚æ­¤ä¸¤è¡Œä»£ç å°±å®ç°äº†åŠ è½½packageç›®å½•ä¸‹çš„.classæ–‡ä»¶çš„åŠŸèƒ½ã€‚è¯¦è§ComponentScanAnnotationParser.parse()æ–¹æ³•
----