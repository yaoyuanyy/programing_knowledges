
= springboot post-processoråº”ç”¨åœ¨beanDefinitionè½¬ä¸ºbeanInstanceå†ä¸ºproxyç±»è‰å½•
:toc: left
:toc-title: ç›®å½•
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: â—
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
// :tip-caption: :bulb:
// :note-caption: :information_source:
// :important-caption: :heavy_exclamation_mark:	
// :caution-caption: :fire:
// :warning-caption: :warning:
:icons: font

Doc writer yaoyihao1@gmail.com

== å‰æ
å¦‚æœä½ å·²ç»å¾ˆäº†è§£`springboootä¸­bean post-processorçš„åŸç†å’Œä½¿ç”¨`ï¼Œæœ¬æ–‡å‘ä½ å±•ç¤ºäº†ä¸€ä¸ªç²¾ç®€ç‰ˆå’Œå¯è§†åŒ–å›¾è°±ï¼›å¦‚æœä½ å¾ˆæƒ³äº†è§£å®ƒï¼Œæœ¬æ–‡æä¾›ä½ æ¢¯å­å¿«é€Ÿçš„èµ°å…¥`bean post-processor`åŸç†å’Œåº”ç”¨ã€‚ä»¥å‡å°‘ä½ åŸæœ¬éœ€è¦èŠ±è´¹çš„æ—¶é—´
æœ¬æ–‡çš„ç»“æ„ä¸ºå›¾+æ–‡æœ¬ç»“åˆçš„æ–¹å¼é˜è¿°

== çŸ¥è¯†ç‚¹æ”¶è·
é€šè¿‡æœ¬æ–‡ï¼Œä½ èƒ½æ”¶è·ä»€ä¹ˆï¼Ÿ
1. BeanPostProcessorä½œç”¨
2. BeanPostProcessorä¸­å…¶æ¯ä¸ªæ–¹æ³•çš„åº”ç”¨åœºæ™¯
3. BeanPostProcessorå®¶æ—æˆå‘˜
4. BeanPostProcessorç±»å‹å¯¹è±¡åœ¨spring iocæ—¶çš„åº”ç”¨


å›¾ä¸­å±•ç¤ºäº†`spring(boot)ä¸­post-processor`åº”ç”¨åœ¨`BeanDefinitionè½¬ä¸ºBeanInstanceå†ä¸ºProxyä»£ç†ç±»`æ•´ä½“çš„æµç¨‹ï¼ŒåŒ…æ‹¬å“ªä¸ªæ–¹æ³•åº”ç”¨äº†å…·ä½“çš„å“ªä¸ªpost-processorï¼Œä»¥è¾¾åˆ°ä»€ä¹ˆç›®çš„æˆ–ä½œç”¨ã€‚

çœ‹å®Œå›¾ä¸­çš„å›¾ä¾‹åå†çœ‹æ­£å›¾
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/springboot%20post-processor%E5%BA%94%E7%94%A8%E5%9C%A8%20BeanDefinition%E8%BD%AC%E4%B8%BABeanInstance%E5%86%8D%E4%B8%BAProxy%E4%BB%A3%E7%90%86%E7%B1%BB.png[springboot post-processoråº”ç”¨åœ¨ BeanDefinitionè½¬ä¸ºBeanInstanceå†ä¸ºProxyä»£ç†ç±».png]

== æ­£æ–‡
ç°åœ¨ï¼Œæˆ‘ä»¬ç»“åˆå›¾çš„åŸºç¡€ä¸Šï¼Œé˜è¿°`eanPostProcessor`çš„å®¶æ—å’Œä½¿ç”¨

=== BeanPostProcessorä½œç”¨
`BeanPostProcessor`æ˜¯`springæ¡†æ¶`ä¸­éå¸¸é‡è¦çš„ç±»ï¼Œæ¯ä¸€ä¸ªæ”¾åˆ°`spring ioc`ä¸­çš„beançš„åˆ›å»ºè¿‡ç¨‹éƒ½æœ‰ä»–çš„èº«å½±ã€‚ä¿—ç§°å‰ç½®å¤„ç†å’Œåç½®å¤„ç†ï¼Œæ„æ€ä¸ºåœ¨beançš„åˆ›å»ºå‰åå¯ä»¥å¢åŠ è‡ªå®šä¹‰çš„å¤„ç†é€»è¾‘ã€‚å¦‚ï¼Œbeanåˆ›å»ºå‰ç»™æŸä¸ªç±»å‹çš„beanå¢åŠ ä¸€ä¸ªå±æ€§å€¼ï¼Œåœ¨beanåˆ›å»ºåç”Ÿæˆè¿™ä¸ªbeançš„ä»£ç†ç±»æ”¾åˆ°spring iocä¸­ç­‰ç­‰

æ³¨æ„ï¼š `BeanPostProcessor`æ˜¯åœ¨`springå®¹å™¨`åŠ è½½äº†`beançš„å®šä¹‰æ–‡ä»¶å¹¶ä¸”å®ä¾‹åŒ–beanä¹‹åæ‰§è¡Œçš„`ã€‚ `BeanPostProcessor`çš„æ‰§è¡Œé¡ºåºæ˜¯åœ¨`BeanFactoryPostProcessor`ä¹‹åã€‚å…³äº`BeanPostProcessor vs BeanFactoryPostProcessor`ï¼Œå‚è§[BeanFactoryPostProcessoryä¸BeanPostProcessoråŒºåˆ«](?)

=== BeanPostProcessorä¸­å…¶æ¯ä¸ªæ–¹æ³•çš„åº”ç”¨åœºæ™¯
çœ‹`BeanPostProcessor`ç±»ç»“æ„
----
public interface BeanPostProcessor {
    /**
     * 
     * populate beans via marker interfaces
     * 
     * åº”ç”¨æ—¶æœºï¼šafter populate property values and before any bean
	 * initialization callbacks (like InitializingBean's {@code afterPropertiesSet}
	 * or a custom init-method)
     *
     * åº”ç”¨åœºæ™¯ï¼šæˆ‘çš„ç†è§£ä¸ºç»™beanå±æ€§èµ‹å€¼çš„åœºæ™¯ä¸‹ä½¿ç”¨
     * 
     * å¦‚ï¼šServletContextAwareProcessor
     */
	@Nullable
	default Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
		return bean;
	}

    /**
     * ç»å¸¸ç”¨äºç”Ÿæˆproxyä»£ç†ç±»ï¼Œå¦‚åº”ç”¨åœ¨FactoryBean
     *
     * åº”ç”¨æ—¶æœºï¼šafter any bean initialization callbacks (like InitializingBean's {@code afterPropertiesSet}
	 * or a custom init-method)
     * åº”ç”¨åœºæ™¯ï¼šç»å¸¸ç”¨äºç”Ÿæˆproxyä»£ç†ç±»ï¼Œå¦‚åº”ç”¨åœ¨FactoryBean
     * 
     */
    @Nullable
	default Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
		return bean;
	}
}
----
`BeanPostProcessor`æœ‰ä¸ªç»å¸¸ä½¿ç”¨çš„å­ç±»å‹ï¼š`InstantiationAwareBeanPostProcessor`ï¼Œçœ‹å…¶ç»“æ„

`InstantiationAwareBeanPostProcessoræ¯”BeanPostProcessorå¤šçš„åŠŸèƒ½æ˜¯ï¼šadds a before-instantiation callback,
and a callback after instantiation but before explicit properties are set or autowiring occurs` 

å…¸å‹çš„ä½¿ç”¨åœºæ™¯å¦‚ `create proxies with special TargetSources (pooling targets, lazily initializing targets, etc), or to implement additional injection strategies
such as field injection`

`InstantiationAwareBeanPostProcessoræ¯”BeanPostProcessorå¤šäº†ä¸‰ä¸ªæ–¹æ³•`
----
public interface InstantiationAwareBeanPostProcessor extends BeanPostProcessor {

    /**
     * åº”ç”¨æ—¶æœºï¼šbefore populate property values
     * åº”ç”¨åœºæ™¯ï¼šå·²çŸ¥çš„åœºæ™¯æ˜¯aopç”ŸæˆTargetSourceçš„proxyä»£ç†ç±»ã€‚todo å‡†ç¡®çš„åº”ç”¨
     * 
     */
	@Nullable
	default Object postProcessBeforeInstantiation(Class<?> beanClass, String beanName) throws BeansException {
		return null;
	}

    /**
     * åº”ç”¨æ—¶æœºï¼šPerform operations after the bean has been instantiated, 
	 * but before Spring property population (from explicit properties or autowiring) occurs
     * 
     * åº”ç”¨åœºæ™¯ï¼šperforming custom field injection on the given bean instance, right before Spring's autowiring kicks in
     */
    default boolean postProcessAfterInstantiation(Object bean, String beanName) throws BeansException {
		return true;
	}

    /**
     * åº”ç”¨æ—¶æœºï¼špostProcessAfterInstantiationä¹‹å
     * åº”ç”¨åœºæ™¯ï¼šéƒ½æ˜¯ç›´æ¥return true
     */
    @Nullable
	default PropertyValues postProcessProperties(PropertyValues pvs, Object bean, String beanName)
			throws BeansException {

		return null;
	}
}
----
ä»å¼€ç¯‡çš„å›¾ä¸­å¯çœ‹å‡ºï¼Œ`beançš„åˆ›å»º(beanDefinition->beanInstance->proxy)ä¸post-processorç´§å¯†çš„äº¤ç»‡åœ¨ä¸€èµ·`ã€‚å¦‚ä½•æ­£ç¡®çš„ä½¿ç”¨ä»–ä»¬æˆä¸ºéš¾ç‚¹å’Œå…³é”®ç‚¹

=== BeanPostProcessorå®¶æ—æˆå‘˜
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191201203038.png[20191201203038.png]

`Spring`ä¸­å†…ç½®äº†å¾ˆå¤šçš„`BeanPostProcesso`rå®ç°ç±»ï¼Œåˆ—ä¸¾çš„éƒ½æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„ï¼Œä»–ä»¬ç»™å‡ºäº†å¾ˆå¥½çš„ä½¿ç”¨ä¾‹å­ï¼Œä¸ºæˆ‘ä»¬ä½¿ç”¨`BeanPostProcessor`å»å®ç°æˆ‘ä»¬çš„è‡ªå·±åœºæ™¯å’Œåº”ç”¨æä¾›äº†å‚è€ƒçš„å§¿åŠ¿
----
BeanPostProcessor
--ConfigurationPropertiesBindingPostProcessor å‚æ•°ç»‘å®šç›¸å…³çš„åº”ç”¨
--ConfigurationPropertiesBeans å‚æ•°ç»‘å®šç›¸å…³çš„åº”ç”¨

--ApplicationContextAwareProcessor ç”¨æ¥ä¸ºbeanæ³¨å…¥ApplicationContextç­‰å®¹å™¨å¯¹è±¡
--AsyncAnnotationBeanPostProcessor @Asyncæ³¨è§£è§£æåº”ç”¨

--DataSourceInitializerPostProcessor dataSourceç›¸å…³åº”ç”¨

--BeanValidationPostProcessor beançš„æ ¡éªŒç›¸å…³åº”ç”¨
--MethodValidationPostProcessor methodçš„æ ¡éªŒç›¸å…³åº”ç”¨

--KafkaListenerAnnotationBeanPostProcessor kafkaç›‘å¬å™¨çš„ä½¿ç”¨

--InstantiationAwareBeanPostProcessor å¢åŠ äº†before-instantiationå’Œafter instantiationçš„callback
----CommonAnnotationBeanPostProcessorï¼šæ”¯æŒ@Resourceæ³¨è§£çš„æ³¨å…¥
----AutowiredAnnotationBeanPostProcessorï¼šæ”¯æŒ@Autowiredæ³¨è§£çš„æ³¨å…¥
----InstantiationAwareBeanPostProcessorAdapter å¯¹å¤–æš´éœ²çš„InstantiationAwareBeanPostProcessor
----AnnotationAwareAspectJAutoProxyCreator ä¸“é—¨å¤„ç†@AspectJæ³¨è§£çš„
----ImportAwareBeanPostProcessor
----
=== å…¸å‹çš„åº”ç”¨ç¤ºä¾‹

==== AutowiredAnnotationBeanPostProcessor 
ç”±ä½ æ¥å®Œæˆ

== it`s time to summary
å¼€ç¯‡å›¾å‡ ä¸ª`BeanPostProcessor`å­ç±»å‹ä¸beanåˆ›å»ºçš„äº¤äº’å…³ç³»ï¼Œé€šè¿‡å®ƒä½ å¯ä»¥å¾ˆæ˜æ™°çš„äº†è§£åˆ°`post-processor`åœ¨`bean`åˆ›å»ºçš„ä¸åŒé˜¶æ®µåº”ç”¨çš„æ–¹æ³•ã€‚ç›¸ä¿¡å¯¹ä½ äº†è§£beançš„åˆ›å»ºæä¾›äº†å¾ˆå¥½çš„å¯è§†åŒ–
ï¼›åŒæ—¶ï¼Œæ–‡ä¸­è¯¦è¿°äº†`BeanPostProcessor`å’Œ`InstantiationAwareBeanPostProcessor`çš„`BeforeInstantiationã€AfterInstantiationã€BeforeInitializationã€AfterInitializationã€postProcessProperties`æ–¹æ³•çš„åº”ç”¨åœºæ™¯å’Œåº”ç”¨æ—¶æœºï¼Œå¸Œæœ›å¯ä»¥å¼•å¯¼å‡ºåˆé€‚çš„ä½¿ç”¨å§¿åŠ¿
ï¼›æœ€åï¼Œåˆ—ä¸¾äº†å¸¸ç”¨çš„`BeanPostProcessor`å®ç°ç±»å‹ï¼Œç®€è¿°äº†ä¸»è¦ä½¿ç”¨åœºæ™¯ã€‚æ¯ä¸ª`BeanPostProcessor`å®ç°ç±»å‹çš„è¯¦ç»†ä½¿ç”¨å¸Œæœ›ä½ è‡ªå·±å®Œæˆä»è€ŒçœŸæ­£ä½“ä¼š`BeanPostProcessor`çš„ç”¨æ³•


ä¸€å¼ **å›¾ç‰‡relaxä½ çš„æ€ç»ª
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20191203081016.png[20191203081016.png]