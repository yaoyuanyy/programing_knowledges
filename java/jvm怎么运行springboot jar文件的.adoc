= jvmæ€ä¹ˆè¿è¡Œspringboot jaræ–‡ä»¶çš„
:toc: left
:toc-title: ç›®å½•
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: â—
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
// :tip-caption: :bulb:
// :note-caption: :information_source:
// :important-caption: :heavy_exclamation_mark:	
// :caution-caption: :fire:
// :warning-caption: :warning:
:icons: font

Doc writer yaoyihao1@gmail.com


image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210418221832.png[20210418221832]

== å‰æ

å…³äºspringbootçš„ç±»åŠ è½½åŸç†å’Œ   `spring-boot-loader`  çš„æºç è§£æï¼Œç½‘ä¸Šå·²æœ‰å¾ˆå¤šçš„å¾ˆæ£’çš„æ–‡ç« äº†ã€‚æˆ‘ä¸€ç›´ç›¸ä¿¡å¯¹äºæŠ€æœ¯åŸç†çš„è·å–ï¼Œä»£ç å±‚é¢çš„è¯ä¸€å®šæ˜¯åŠ¨çœ¼æ¯”ä¸ä¸ŠåŠ¨æ‰‹ï¼Œ `debug` è·Ÿç€æºç è¿è¡Œèµ°ä¸€éï¼Œæ•ˆæœå¾€å¾€æ˜¯å¾ˆæ£’çš„ã€‚åŒç†ï¼Œå¯¹äº `spring-boot-loader` çš„åŸç†ï¼Œæºç çš„æŒæ¡ï¼Œå…¶åŸç†å’Œ `debug` æ–¹å¼å‚è€ƒï¼š 

https://juejin.cn/post/6844904088707186701[springboot jaråŒ…å¯è¿è¡Œ,debugå‘Šè¯‰ä½ æ€ä¹ˆè¿è¡Œçš„]

æœ¬æ–‡æƒ³è¦è®²è¿°çš„å¯èƒ½è¦æ›´è¿‘ä¸€æ­¥äº†ã€‚å¸¦ç€ä¸€äº›ç–‘é—®å¼€å§‹æˆ‘ä»¬çš„å­¦ä¹ 
- 1ã€ç¨‹åºæ˜¯ä»å“ªè¿›å…¥ `JarLauncher.main()` æ–¹æ³•çš„
- 2ã€ `java -jar xxx-executable.jar`   `java` æœ‰ä»€ä¹ˆè§„å®šå—
- 3ã€ `jvm` å±‚é¢æ˜¯å¦‚ä½•è¿›å…¥åˆ° `java` ç¨‹åºçš„ï¼Œè¿æ¥ç‚¹åœ¨å“ªé‡Œ

å‰æœŸå‚¨å¤‡ï¼š
1. ä½ éœ€è¦çŸ¥é“æˆ‘ä»¬å¹³æ—¶å†™çš„ä½¿ç”¨springbootæ¶æ„çš„åº”ç”¨ç¨‹åºï¼Œè¿è¡Œæ—¶çš„èµ·å§‹ç‚¹ä¸æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„app.javaçš„mainæ–¹æ³•ï¼Œè€Œæ˜¯springbootçš„JarLauncher.javaçš„mainæ–¹æ³•ã€‚å¦‚æœä½ éœ€è¦äº†è§£è¿™ä¸ªï¼Œè¯·å‚è€ƒï¼š

https://juejin.cn/post/6844904088707186701[springboot jaråŒ…å¯è¿è¡Œ,debugå¯è§†åŒ–å‘Šè¯‰ä½ æ€ä¹ˆè¿è¡Œçš„]

åœ¨å¯è§†åŒ–è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåœ¨javaä¾§æˆ‘ä»¬è¦debug org.springframework.boot.loader.JarLauncherï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨å®ƒçš„æºç ï¼Œæ‰€ä»¥éœ€è¦å¼•ç”¨JarLauncherçš„æºç jaråŒ…ï¼Œå¦‚ä¸‹

```
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-loader</artifactId>
    <version>2.4.4</version>
</dependency>
```

> æœ¬æ–‡åŠ›æ±‚ä¸“æ³¨å’Œç²¾ç®€ï¼Œå¸Œæœ›ä½ æœ‰æ‰€æ”¶è·å’Œæƒ³æ³•

== æ­£æ–‡

===  `-jar` çš„è§„çŸ©
å…¶å®ï¼Œ `java` å¯¹ `-jar` å®šä¹‰äº†ä¸€äº›è§„åˆ™ï¼Œåªè¦ç¬¦åˆè¿™ä¸ªè§„åˆ™ï¼Œä½ åšå•¥éƒ½è¡Œï¼Œæ€ä¹ˆåšéƒ½è¡Œã€‚å…¶ä¸­çš„ä¸€ä¸ªæ˜¯: `jar` ä¸­éœ€è¦ä¸€ä¸ª `META-INF/MAINFEST.MF` æ–‡ä»¶ï¼Œä¸”æ–‡ä»¶ä¸­ `Main-Class manifest header` ã€‚å®˜ç½‘çš„è¯´æ˜å¦‚ä¸‹

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210417141240.png[20210417141240]

æ‰€ä»¥ï¼Œæˆ‘ä»¬è§£å‹ä¸€ä¸ª `xxx-executable.jar` ï¼Œä¼šçœ‹åˆ° `META-INF/MAINFEST.MF `çš„æ–‡ä»¶åŠå…¶å†…å®¹

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210417141952.png[20210417141952]

æ­£æ˜¯å› ä¸ºæœ‰äº† `Main-Class: org.springframework.boot.loader.JarLauncher` ï¼Œæ‰€ä»¥ï¼Œå½“ `java -jar xxx-executable.jar` æ—¶ï¼Œç¨‹åºä¼šè¿›å…¥ `org.springframework.boot.loader.JarLauncher` æ‰§è¡Œ `main` æ–¹æ³•ã€‚åˆ°è¿™é‡Œæˆ‘åˆæœ‰äº†ç–‘é—®ï¼Œé‚£æ˜¯ä»å“ªè¿›å…¥ `JarLauncher.main` æ–¹æ³•çš„å‘¢

== ä» `jvm` è¿›å…¥ `java` 
=== ç¨‹åºæ˜¯æ€ä¹ˆè¿›å…¥ `JarLauncher.main` æ–¹æ³•çš„å‘¢
è¿™ä¸ªæ—¶å€™æƒ³åˆ°äº† `jvm` ã€‚åº”è¯¥æ˜¯ä» `jvm` è¿›å»åˆ°äº† `JarLauncher.main` ï¼Œé‚£ä¹ˆæ€ä¹ˆéªŒè¯å‘¢ã€‚

æˆ‘ä»¬é€šè¿‡ `CLion` æŸ¥çœ‹ `jvm` æºç ï¼Œè¯•å›¾æ‰¾åˆ°è¿™ä¸ªç­”æ¡ˆã€‚æˆ‘ä»¬é€šè¿‡å…¨å±€æœç´¢ `Main-Class` , `Manifest`  è¿™äº›å…³é”®è¯æ¥å®šä½æ‰€åœ¨çš„æ–‡ä»¶ï¼Œå¹¶æ‰“ä¸Šç›¸åº”çš„ `debug` ç«¯ç‚¹ã€‚å¦‚ä¸‹å›¾

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210417144256.png[]

ç„¶åæˆ‘ä»¬å¯åŠ¨ `debug` æ¨¡å¼å¯åŠ¨ `jvm` ï¼Œå¯åŠ¨æ—¶é…ç½®ä¸Šæˆ‘ä»¬çš„åº”ç”¨ `jar` åŒ…ï¼š `-jar xxx-executable.jar  ï¼Œå¦‚ä¸‹å›¾

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210417144842.png[20210417144842]


ç°åœ¨æˆ‘ä»¬è·Ÿç€ `jvm` çš„ `debug` ä¸€èµ·è¿½ä¸‹å¯»æ‰¾ `Main-Class` , `Manifest`  çš„è¿‡ç¨‹ã€‚

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210417162905.png[20210417162905]

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210417162932.png[20210417162932]

çœ‹åˆ°äº† `JLI_ParseManifest` ï¼Œä»åå­—ä¹Ÿçœ‹çš„å‡ºæ¥è¿™ä¸ªçœ‰ç›®äº†

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210417171349.png[20210417162933]

å¯ä»¥çœ‹åˆ° `static const char *manifest_name = "META-INF/MANIFEST.MF"` åœ¨jvmä¸­æ˜¯ä¸ªå¸¸é‡ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬çš„åº”ç”¨ `xxx-executable.jar` ä¸­å¿…é¡»æœ‰ä¸ªå«è¿™ä¸ªåçš„ç›®å½•å’Œæ–‡ä»¶ã€‚æ–¹æ³•æ¥ç€è§£æäº†è¿™ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶çš„å†…å®¹å’Œæˆ‘ä»¬è§£å‹ `xxx-executable.jar` çœ‹åˆ°çš„å†…å®¹ä¸€è‡´ï¼Œå¦‚ä¸‹å›¾

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210417172247.png[]
æ‰€ä»¥ï¼Œåˆ°è¿™ `Main-Class` çš„å€¼å°±è¢«è§£æå‡ºæ¥äº†ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹jvmå¦‚ä½•åŠ è½½ `Main-Class` çš„å€¼(å³ `org.springframework.boot.loader.JarLauncher` )çš„ã€‚


ä¸‹é¢å›¾ä¸­6ä¸ªéƒ¨åˆ†å…¶å®å°†è™šæ‹Ÿæœºçš„æ•´ä¸ªåˆå§‹åŒ–å’ŒåŠ è½½è¿‡ç¨‹éƒ½æ˜¾ç¤ºå‡ºæ¥äº†ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬åªå…³æ³¨ `JarLauncher` æ˜¯å¦‚ä½•åŠ è½½åˆå§‹åŒ–ä¸ `JarLauncher.main` æ˜¯æ€ä¹ˆè¿è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹å…³æ³¨(1)ã€(2)ã€(4)ã€(6)

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210417175150.png[]


==== ï¼ˆ1ï¼‰ `LoadMainClass`  - åŠ è½½ `main class` 
æˆ‘ä»¬å…ˆçœ‹ä¸‹ `LoadMainClass` çš„ç»†èŠ‚ï¼Œçœ‹çœ‹å¥¹å’‹åŠ è½½çš„ã€‚é€šè¿‡ `GetLauncherHelperClass` æ–¹æ³•ï¼Œæˆ‘ä»¬ç»ˆäºçœ‹åˆ°äº†ç†Ÿæ‚‰çš„èº«å½±ï¼š `sun/launcher/LauncherHelper`  è¿™ä¸ª `java class` ã€‚å¦‚ä¸‹å›¾

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210417181757.png[20210417181757]

 `LoadMainClass` åšäº†ä¸‰ä»¶äº‹ï¼š
1ã€è·å– `LauncherHelper` å®ä¾‹
2ã€é€šè¿‡ `checkAndLoadMain` æ–¹æ³•ä½¿ç”¨ `ClassLoader.getSystemClassLoader` åˆå§‹åŒ– `org.springframework.boot.loader.JarLauncher class` 
3ã€ `makePlatformString` è·å– `utf-8` åçš„ `string` 

éœ€è¦ç‰¹åˆ«æŒ‡å‡ºçš„æ˜¯ `LauncherHelper.java` ã€‚è¿™ä¸ªç±»çš„æºç åœ¨ `jvm` ä¸­ï¼Œåœ¨æˆ‘ä»¬ç†Ÿæ‚‰çš„ `rt.jar` æ˜¯ä»¥ `.class` çš„å½¢å¼å‡ºç°çš„ã€‚æˆ‘æŠŠä»–ä¿©æ”¾åœ¨ä¸€å¼ å›¾ç‰‡é‡Œå¯¹æ¯”ä¸‹

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210417185738.png[20210417185738]

==== ï¼ˆ2ï¼‰è·å– `LauncherHelper` çš„å®ä¾‹
è¿™é‡Œçš„å®ä¾‹æ˜¯åœ¨(1)ä¸­åˆå§‹åŒ–å¥½çš„ï¼Œç”¨å°±å¥½äº†

==== ï¼ˆ4ï¼‰éªŒè¯å’ŒåŠ è½½ `main` æ–¹æ³•
è¿™é‡Œç”¨äº†ç±»ä¼¼åå°„çš„æ–¹æ³•æ¥è·å– `main` æ–¹æ³•

==== ï¼ˆ6ï¼‰è°ƒç”¨ `LauncherHelper.main` æ–¹æ³•
è¿™é‡Œå°±æ˜¯æˆ‘ä»¬ä¸€ç›´è¦çŸ¥é“çš„é‚£ä¸ªåœ°æ–¹ï¼Œä¹Ÿæ˜¯æ–‡ç« å¼€å¤´éƒ¨åˆ†çš„é—®é¢˜1å’Œ3çš„ç­”æ¡ˆã€‚å³ `jvm` è¿è¡Œå’Œ `java application` çš„è¿æ¥ç‚¹ã€‚


== ä» `java` è¿›å…¥ `springboot` 

ä» `java` è¿›å…¥ `springboot` ï¼Œå…·ä½“çš„åœ°æ–¹æ˜¯åœ¨LauncherHelperç±»ä¸­ï¼Œåœ¨LauncherHelperçš„checkAndLoadMainæ–¹æ³•ä¸­ï¼Œé€šè¿‡loadclassæ–¹æ³•å®ä¾‹åŒ– `org.springframework.boot.loader.JarLauncher` ï¼›è¿›è€Œè°ƒç”¨validateMainClass()æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210619094306.png[20210619094306]

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210619094632.png[20210619094306]

validateMainClass()çš„å…³é”®ç‚¹åœ¨é€šè¿‡getMethodè¿™ä¸ªåå°„æ–¹æ³•è°ƒç”¨JarLauncherçš„mainæ–¹æ³•ï¼Œä»è€Œå®ç°è¿›å…¥åˆ°springbootçš„JarLauncher.javaçš„mainæ–¹æ³•ã€‚çœ‹ä¸‹validateMainClass()æ–¹æ³•çš„å†…å®¹é€»è¾‘ï¼Œå¦‚ä¸‹å›¾

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210619094948.png[20210619094948]

è¿›å…¥JarLauncher.javaçš„mainæ–¹æ³•

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210619095342.png[20210619095342]


=== æµè½¬å›¾

åˆ©ç”¨ `CLion` å’Œ `Idea` çš„åˆ†åˆ« `debug` ï¼Œæˆ‘äººä¸ºçš„æŠŠä»–ä¿©çš„è¿è¡Œç»“åˆåœ¨ä¸€èµ·ï¼Œå…·è±¡çš„è¡¨ç¤ºå‡ºè¿™ä¸¤ä¸ªç‚¹çš„è¿è¡Œï¼Œå¦‚ä¸‹å›¾

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210619111004.png[20210619111004]


== it ` s time to summary

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„ç–‘é—®éƒ½æ‰¾åˆ°ç­”æ¡ˆäº†ã€‚æˆ‘ä»¬ä» `jvm` æºç åˆ° `java` ä»£ç ï¼Œæ•´ä¸ªæµç¨‹ä¸²ä¸‹æ¥ã€‚ç›¸ä¿¡æœ‰äººå†é—®ä½  `springboot` çš„å…¥å£æ—¶ï¼Œä½ ä¸ä»…çŸ¥é“äº†æ˜¯ `JarLauncher.main` ï¼Œè€Œä¸”èƒ½è¿›ä¸€æ­¥çŸ¥é“ä»å“ª(æ€ä¹ˆ)è¿›å…¥çš„ `JarLauncher.main` çš„ã€‚è¿™ä¸ç®¡æ˜¯å¯¹å·¥ä½œï¼Œè¿˜æ˜¯é¢è¯•ï¼Œå¯¹ä½ éƒ½æ˜¯æœ‰å¾ˆå¤§æ”¶ç›Šçš„ã€‚


== é™„å½•

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20210417192215.png[20210417192215]


ç°åœ¨ï¼Œä» `jvm` åˆ° `java` ï¼Œåˆä»ä» `java` åˆ° `springboot` ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“äº†ï¼›åˆå‰ä¸€ç¯‡è®²äº† ä» `springboot` åˆ° `åº”ç”¨appç¨‹åº` çš„å…¥å£å’Œè¿æ¥ç‚¹ã€‚æ‰€æœ‰ï¼Œç°åœ¨ï¼Œä»jvmåˆ°åº”ç”¨appç¨‹åºçš„æ•´ä¸ªè¿‡ç¨‹æˆ‘ä»¬éƒ½çŸ¥é“äº†ï¼Œå¦‚ä¸‹

```
java.cçš„JavaMainæ–¹æ³• --> LauncherHelper.javaçš„mainæ–¹æ³• --> JarLauncher.javaçš„mainæ–¹æ³• -->  Application.javaçš„mainæ–¹æ³•
```

æ”¶ç›Šæ–‡ç« ï¼š https://programmer.ink/think/why-the-jar-of-springboot-can-run-independently.html[why-the-jar-of-springboot-can-run-independently]

