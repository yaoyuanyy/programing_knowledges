= ä¸çŸ¥é“javaagentæ˜¯ä»€ä¹ˆ,è¿è¡Œä¸ªhello worldå°±çŸ¥é“äº†
:toc: left
:toc-title: ç›®å½•
:tip-caption: ğŸ’¡
:note-caption: â„¹ï¸
:important-caption: â—
:caution-caption: ğŸ”¥
:warning-caption: âš ï¸
// :tip-caption: :bulb:
// :note-caption: :information_source:
// :important-caption: :heavy_exclamation_mark:	
// :caution-caption: :fire:
// :warning-caption: :warning:
:icons: font

Doc writer yaoyihao1@gmail.com

ä»äº‹javaå¼€å‘çš„åŒå­¦ï¼Œæˆ–å¤šæˆ–å°‘å¬è¯´è¿‡`javaæ¢é’ˆ`/`javaagent`è¿™ä¸ªæœ¯è¯­ã€‚æœ¬æ–‡ä¸è¯´å®ƒçš„å®šä¹‰ï¼Œä¸è¯´å®ƒçš„åŸç†ï¼Œä¸è¯´å®ƒçš„é«˜å¤§ä¸Šçš„ä½œç”¨ï¼Œåªè¯´å®ƒçš„"hello world"ã€‚å³è¿è¡Œä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œå®é™…çœ‹çœ‹æ•ˆæœï¼Œæœ‰äº†çœŸåˆ‡çš„æ„Ÿå—åï¼Œäº§ç”ŸçœŸåˆ‡æ¸…æ™°çš„è®¤è¯†ï¼Œä»¥ä¾¿å¿«é€Ÿçš„å…¥é—¨å¹¶æ·±å…¥æ¢ç´¢ã€‚

== ç¼–ç 
ç”¨ideaåˆ›å»ºä¸ªmavené¡¹ç›®ï¼Œå¦‚ä¸‹å›¾ï¼Œé¡¹ç›®åç§°éšæ„ï¼Œè¿™é‡Œæˆ‘çš„é¡¹ç›®åä¸ºï¼šmicroservice-comb-javaagent
image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20200310194628.png[20200310194628.png]

ä»£ç å¦‚ä¸‹
é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªç±»ï¼šAgentDemo
----
public class AgentDemo {
    /**
     * è¯¥æ–¹æ³•åœ¨mainæ–¹æ³•ä¹‹å‰è¿è¡Œï¼Œä¸mainæ–¹æ³•è¿è¡Œåœ¨åŒä¸€ä¸ªJVMä¸­
     */
    public static void premain(String agentArgs, Instrumentation inst) {
        System.out.println("------ premainæ–¹æ³• æœ‰ä¸¤ä¸ªå…¥å‚ ------ agentArgs:" + agentArgs + " inst:" + inst.toString());
    }

    /**
     * å¦‚æœä¸å­˜åœ¨ {@link AgentDemo#premain(String, Instrumentation)}, åˆ™ä¼šæ‰§è¡Œæœ¬æ–¹æ³•
     */
    public static void premain(String agentArgs) {
        System.out.println("------ premainæ–¹æ³•ï¼Œæœ‰ä¸€ä¸ªå…¥å‚ ------ agentArgs:" + agentArgs);
    }
}
----
NOTE: AgentDemoçš„å…¨é™å®šåä¼šåœ¨pom.xmlä¸­æ ‡ç­¾`Premain-Class`å¼•ç”¨

å…¶æ¬¡ï¼Œå†åˆ›å»ºä¸€ä¸ªç±»ï¼šAgentTest
----
public class AgentTest {
    public static void main(String[] args) {
        System.out.println(" ------ mainæ–¹æ³•");
    }
}
----

å†æ¬¡ï¼Œåœ¨é¡¹ç›®çš„pom.xmlä¸­æ·»åŠ 
----
   Â·Â·Â· ç•¥

<build>
    <plugins>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <configuration>
                <source>1.8</source>
                <target>1.8</target>
            </configuration>
        </plugin>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-jar-plugin</artifactId>
            <configuration>
                <archive>
                    <manifestEntries>
                        <!-- å€¼ä¸ºåŒ…å«premainæ–¹æ³•çš„ç±». å¯åŠ¨æ–¹å¼ä¸ºå‘½ä»¤è¡Œå¯åŠ¨æ—¶,javaagent JARæ–‡ä»¶æ¸…å•å¿…é¡»åŒ…å« Premain-Class å±æ€§, ä»£ç†ç±»å¿…é¡»å®ç° public static premain()-->
                        <Premain-Class>com.skyler.cobweb.agent.AgentDemo</Premain-Class>
                        <Can-Redefine-Classes>true</Can-Redefine-Classes>
                        <Can-Retransform-Classes>true</Can-Retransform-Classes>
                    </manifestEntries>
                </archive>
            </configuration>
        </plugin>
    </plugins>
</build>
----
== æ‰“jaråŒ…
å°†`microservice-comb-javaagent`æ‰“æˆ`jar`åŒ…ã€‚è¿è¡Œæ—¶ä¼šä½¿ç”¨è¿™ä¸ª`Jar`åŒ….æ‰“åŒ…å‘½ä»¤:`mvn clean package`ã€‚ç»“æœå¦‚ä¸‹å›¾

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20200310200510.png[20200310200510.png]

== è¿è¡Œ
ä½ å¯ä»¥æœ‰ä¸¤ä¸ªè¿è¡Œæ–¹å¼ï¼š`ideaä¸­ç›´æ¥è¿è¡Œ`å’Œ`å‘½ä»¤è¡Œè¿è¡Œ`
- ideaä¸­ç›´æ¥è¿è¡Œ

éœ€è¦é…ç½®ä¸‹é¡¹ç›®çš„è¿è¡Œé…ç½®çš„`VM options`ï¼Œå¦‚ä¸‹å›¾ï¼Œå½¢å¼ä¸º`-javaagent:jarpath[=options]`; æˆ‘çš„å†…å®¹ä¸ºï¼š`-javaagent:/Users/xx/microservice-comb/microservice-comb-javaagent/target/microservice-comb-javaagent-1.0.0-SNAPSHOT.jar=hello world`

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20200310211044.png[20200310211044.png]

ç„¶åï¼Œè¿è¡ŒAgentTest.mainæ–¹æ³•ï¼Œç»“æœå¦‚ä¸‹å›¾

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20200310201519.png[20200310201519.png]

å¯ä»¥çœ‹åˆ°ï¼Œæ‰“å°å‡ºäº†AgentDemo.premainæ–¹æ³•çš„ä¿¡æ¯

- å‘½ä»¤è¡Œè¿è¡Œ
`cd`åˆ°é¡¹ç›®microservice-comb-javaagentçš„/target/classesè·¯å¾„ä¸‹
----
$ cd xx/target/classes
$ java -javaagent:/Users/xx/microservice-comb/microservice-comb-javaagent/target/microservice-comb-javaagent-1.0.0-SNAPSHOT.jar="hello world"  com.skyler.cobweb.agent.AgentTest
----
å¯ä»¥çœ‹åˆ°ï¼ŒåŒæ ·æ‰“å°å‡ºäº†AgentDemo.premainæ–¹æ³•çš„ä¿¡æ¯

image::https://raw.githubusercontent.com/yaoyuanyy/MarkdownPhotos/master/img/20200310203649.png[20200310203649.png]

== æ”¶è·

è¿™é‡Œæœ‰ä¸ªå¯¹æ¯”ï¼Œè¿è¡Œæ—¶æ˜¯å¦åŠ ä¸Š`-javaagent:jar`ï¼Œè¿™ä¸ªç»™ä½ çš„æ„Ÿå—ä¼šå¾ˆæ˜æ˜¾å’Œé€å½»ã€‚æ¥å†æ“ä½œä¸‹

åŠ ä¸Šæ—¶
----
$ cd /Users/xx/microservice-comb/microservice-comb-javaagent/target/classes
$ java -javaagent:/Users/xx/microservice-comb/microservice-comb-javaagent/target/microservice-comb-javaagent-1.0.0-SNAPSHOT.jar="hello world" com.skyler.cobweb.agent.AgentTest
----

æ•ˆæœ
----
------ premainæ–¹æ³• æœ‰ä¸¤ä¸ªå…¥å‚ ------ agentArgs:hello world inst:sun.instrument.InstrumentationImpl@a09ee92
 ------ mainæ–¹æ³•
----

ä¸åŠ ä¸Šæ—¶
----
$ cd /Users/xx/microservice-comb/microservice-comb-javaagent/target/classes
$ java com.skyler.cobweb.agent.AgentTest
----

æ•ˆæœ
----
 ------ mainæ–¹æ³•

----
æ•ˆæœè¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œä¸åŠ -javaagentï¼Œjaré‡Œçš„ç±»æ–¹æ³•æ²¡æœ‰æ‰§è¡Œï¼Œä¹Ÿå³ä¸ä¼šè¾“å‡ºä¿¡æ¯

è¿™ä¸ªå¯¹æ¯”çš„ç›®çš„æ˜¯çªå‡ºjavaagentçš„ä½œç”¨ã€‚å¹¶è®©ä½ æ¸…æ™°çš„æ„Ÿå—javaagentçš„ä½œç”¨ï¼šåƒä»£ç†ä¸€æ ·å¯ä»¥åœ¨mainæ–¹æ³•å‰åšäº›äº‹æƒ…ï¼Œå®˜æ–¹çš„è¯´å­—èŠ‚ç å¢å¼ºã€‚é€šè¿‡ä¿®æ”¹å­—èŠ‚ç çš„æ–¹å¼ï¼Œè®©å¼€å‘è€…æœ‰æœºä¼šåšäº›äº‹æƒ…ï¼Œå¦‚arthas å’Œskywalkingçš„å»ºç›‘å¬ç»„ä»¶

åƒè¨€ä¸‡è¯­æŠµä¸ä¸Š`run`ä¸€ä¸ª'hello world'

æœ¬æ–‡æƒ³é€šè¿‡æœ€ç®€å•ã€æœ€ç›´è§‚çš„æ–¹å¼ï¼Œè®©ä½ æœ€å¿«é€Ÿçš„ã€æœ€çœŸåˆ‡çš„äº†è§£javaagentçš„ä½œç”¨ã€‚ä¸‹ç¯‡å±•å¼€è¯´javaagentçš„åŸç†å’Œæ›´å®é™…çš„ä½¿ç”¨ä¾‹å­